<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>月月小手机~</title>
    <!-- ✨ 这是更厉害的“世界通用”变身咒语！✨ -->
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#000000">
<link rel="manifest" href='data:application/manifest+json,{"name":"月月小手机","short_name":"小手机","start_url":".","display":"standalone","background_color":"#000000","theme_color":"#000000","icons":[{"src":"https://i.postimg.cc/kDLskGMS/qq-icon.png","sizes":"192x192","type":"image/png"}]}' />
<link rel="apple-touch-icon" href="https://i.postimg.cc/kDLskGMS/qq-icon.png">
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <style> 
    /* CSS代码将放在这里 */ 
    :root {
    --primary-color: #8E9AAF; /* 主色调-灰蓝色 */
    --secondary-color: #B4A2A2; /* 辅助色-灰粉色 */
    --background-light: #F4F3F1; /* 浅背景色-米白 */
    --background-white: #FFFFFF; /* 白色背景 */
    --border-color: #EAE8E4; /* 边框色 */
    --text-primary: #3D414A; /* 主要文字-深灰蓝 */
    --text-secondary: #A9A9A9; /* 次要文字-浅灰色 */
    --app-font: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "PingFang SC", "Microsoft YaHei", sans-serif;
    --shadow-color: rgba(0, 0, 0, 0.08); /* 阴影颜色 */
    --delete-red: #E57373; /* 删除按钮红色 */
}
   @font-face {
font-family: 'CustomFont';
src: url('https://files.catbox.moe/xmwt2d.ttf');
}
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
/* ▼▼▼ CEO专属 · 全局字体继承法令 v6.0 ▼▼▼ */
input, button, textarea, select {
    font-family: inherit; /* 强制所有表单元素继承父元素的字体 */
    font-size: 100%;      /* 确保它们的默认字号和周围文字一致 */
    margin: 0;            /* 清除一些浏览器自带的边距 */
}
/* ▲▲▲ 法令颁布完毕 ▲▲▲ */
html, body {
    height: 100%;
    overflow: hidden; /* ✨ 把这句“定身咒”加回来！✨ */
}
body { font-family: 'CustomFont', var(--app-font); margin: 0; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; text-rendering: optimizeLegibility; background-color: var(--background-light); }
#phone-screen {
    width: 100%;
    height: 100dvh; /* ✨✨ 终极咒语：动态视口高度！ ✨✨ */
    background-color: var(--background-white);
    position: fixed;
    top: 0;
    left: 0;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}
#status-bar {
    /* 核心修改：移除定位，交给父容器管理 */
    width: 100%;
    z-index: 1000;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 20px; /* 移除上下padding，完全由父容器控制 */
    font-size: 14px; 
    font-weight: 600; 
    pointer-events: none;
    color: black; 
    text-shadow: none;
}

#status-battery { display: flex; align-items: center; }

#battery-icon {
    width: 25px; /* 宽度微调 */
    height: 12px; /* 高度微调 */
    border: 1.2px solid black; /* 边框变细，更精致 */
    border-radius: 4px; /* 圆角更圆滑 */
    margin-left: 6px;
    position: relative;
    padding: 1.5px; /* 增加内边距，让填充不贴边 */
}

#battery-icon-level {
    background-color: black;
    height: 100%;
    border-radius: 2px; /* 内部填充圆角也调整 */
}

#battery-icon::after {
    content: '';
    position: absolute;
    /* 调整小头的位置和大小 */
    right: -5px; 
    top: 50%;
    transform: translateY(-50%);
    width: 2px;
    height: 4px;
    background-color: black;
    border-radius: 0 1px 1px 0;
}

/* 新增：为深色背景（如主屏幕）准备的白色模式 */
#status-bar.white-theme {
    color: white;
    text-shadow: 0 1px 2px rgba(0,0,0,0.5); /* 恢复阴影 */
}
#status-bar.white-theme #battery-icon {
    border-color: white;
}
#status-bar.white-theme #battery-icon-level {
    background-color: white;
}
#status-bar.white-theme #battery-icon::after {
    background-color: white;
}
.screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; visibility: hidden; transition: opacity .3s; display: flex; flex-direction: column; background-color: var(--background-light); }
.screen.active { opacity: 1; visibility: visible; }
#home-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; background-color: #333; background-size: cover; background-position: center; overflow: hidden; }
/* ▼▼▼ 全新的主屏幕Pro Max Plus版样式！▼▼▼ */
/* 让主屏幕变成上下结构，上面是滑动区，下面是Dock栏 */
#home-screen {
    display: flex;
    flex-direction: column; /* 改成垂直排列 */
    justify-content: flex-end; /* 把内容推到底部 */
    padding-bottom: 20px; /* 离手机底部留点空隙 */
    /* ✨ 看这里！我们把默认背景色换成了背景图！ */
    background-image: url('https://files.catbox.moe/cp34jl.jpg');
    background-size: cover;
    background-position: center;
    overflow: hidden;
}

/* 滑动区域的总容器，它会变得很宽，装着好几页 */
#home-screen-pages-wrapper {
    display: flex; /* 让页面横着排 */
    width: 200%; /* 因为有2页，所以是200%宽 */
    height: 100%;
    transition: transform 0.4s ease-in-out; /* 滑动时的动画 */
    position: absolute;
    top: 0;
    left: 0;
    will-change: transform;
}

/* 每一页的样式 */
.home-screen-page {
    width: 50%; /* 每一页占总宽度的一半 */
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 12vh 20px 0 20px; /* 顶部留出空间 */
    gap: 20px;
}
/* 底部Dock栏的样式 */
.dock {
    /* 核心修改 1：让 Dock 栏更长 */
    width: calc(100% - 20px); 
    max-width: 420px; /* 相应地增加最大宽度 */
    margin: 0 auto;
    background-color: rgba(255, 255, 255, 0.15); 
    backdrop-filter: blur(25px);
    -webkit-backdrop-filter: blur(25px);
    border-radius: 28px;
    /* 核心修改 2：让 Dock 栏更扁 */
    padding: 10px; 
    display: flex;
    justify-content: space-around;
    z-index: 10;
    flex-shrink: 0;
    border: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

/* 底部小圆点的样式 */
#page-indicator {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin-bottom: 15px;
    z-index: 10;
}
.dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background-color: rgba(255, 255, 255, 0.5);
    transition: background-color 0.3s;
}
.dot.active {
    background-color: white;
}

/* === 新桌面布局样式 (V2.0 微调版) === */
.desktop-layout {
    width: 100%;
    flex-grow: 1;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    /* 核心修改：恢复顶部内边距，因为现在只有一页了 */
    padding: 50px 15px 15px 15px; 
    align-content: start;
}

.widget {
    background-color: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 28px;
    cursor: pointer;
    transition: transform 0.2s;
    background-size: cover;
    background-position: center;
}
.widget:active {
    transform: scale(0.98);
}
.widget-rect {
    grid-column: 1 / 3;
    /* 核心修改 2：调整宽高比，让长方形小组件更扁 */
    aspect-ratio: 2.2 / 1; 
}
.widget-square {
    aspect-ratio: 1 / 1;
}

.app-cluster {
    display: grid;
    grid-template-columns: 1fr 1fr;
    grid-template-rows: 1fr 1fr;
    gap: 12px; /* 减小图标之间的间距 */
    aspect-ratio: 1 / 1;
}

/* 核心修改 3：整体缩小正方形组件区域的尺寸 */
/* 我们通过给它外边距来实现“缩小”的视觉效果 */
.widget-square, .app-cluster {
    margin: 5px; 
}


.app-cluster .app-icon-wrapper {
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.app-cluster .app-icon {
    /* 核心修改 4：将图标宽度从75%增加到80%，让它稍微变大 */
    width: 80%; 
    aspect-ratio: 1 / 1;
    height: auto; 
    margin-bottom: 4px;
}

.app-cluster .app-icon-wrapper p {
    font-size: 11px;
}

#clock-container { text-align: center; color: white; text-shadow: 0 2px 5px rgba(0,0,0,0.4); flex-shrink: 0; }
#main-time { font-size: 72px; font-weight: 200; letter-spacing: 2px; margin: 0; }
#main-date { font-size: 18px; margin-top: 10px; }
.app-grid { display: flex; flex-wrap: wrap; justify-content: center; max-width: 260px; gap: 15px; margin-top: 10vh; }
.app-icon-wrapper { display: flex; flex-direction: column; align-items: center; width: 70px; cursor: pointer; }
.app-icon { width: 58px; height: 58px; border-radius: 14px; flex-shrink: 0; box-shadow: 0 2px 8px rgba(0,0,0,0.2); transition: transform 0.2s, box-shadow 0.2s; background-size: cover; background-position: center; margin-bottom: 6px; }
.app-icon:active { transform: scale(0.9); }
/* 让App名字在任何壁纸下都清晰可见的魔法 */
.app-icon-wrapper p {
    margin: 0;
    font-size: 12px;
    font-weight: 400;
    color: white; /* 文字还是白色的 */
    /* 超级厉害的描边+阴影效果！ */
    text-shadow: 
        0px 0px 2px rgba(0, 0, 0, 0.9), /* 这是紧贴的黑色细描边 */
        0px 1px 4px rgba(0, 0, 0, 0.7); /* 这是稍远的柔和阴影 */
}
/* ▼▼▼ CEO专属 · 图标系统CSS变量化 v5.0 ▼▼▼ */
:root {
    --icon-qq: url('https://files.catbox.moe/8g0gh1.png');
    --icon-worldbook: url('https://files.catbox.moe/eizpwt.png');
    --icon-weibo: url('https://files.catbox.moe/29fh03.png');
    --icon-appearance: url('https://files.catbox.moe/ilw354.png');
    --icon-settings: url('https://files.catbox.moe/rx6zcy.png');
    --icon-error-log: url('https://files.catbox.moe/4bazyp.png');
    --icon-gobang: url('https://files.catbox.moe/25r6ml.png');
    --icon-offline-story: url('https://files.catbox.moe/46d1ow.png');
}

.qq-icon, .worldbook-icon, .weibo-icon, .appearance-icon, .settings-icon, .error-log-icon, .offline-story-icon, .gobang-icon {
    background-size: cover;
    background-position: center;
    background-color: transparent;
}

.qq-icon { background-image: var(--icon-qq); }
.worldbook-icon { background-image: var(--icon-worldbook); }
.weibo-icon { background-image: var(--icon-weibo); }
.appearance-icon { background-image: var(--icon-appearance); }
.settings-icon { background-image: var(--icon-settings); }
.error-log-icon { background-image: var(--icon-error-log); }
.gobang-icon { background-image: var(--icon-gobang); }
.offline-story-icon { background-image: var(--icon-offline-story); }
/* ▲▲▲ 升级完成 ▲▲▲ */
/* 【灵动岛适配】增加了顶部的内边距(padding-top) */
.header {
    position: relative;padding: 44px 16px 10px 16px; background-color: rgba(248, 248, 248, 0.85); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); font-weight: 600; font-size: 17px; border-bottom: 1px solid var(--border-color); flex-shrink: 0; z-index: 10; display: flex; align-items: center; justify-content: space-between; }
.header .back-btn { border: none; background: none; font-size: 28px; font-weight: 400; color: var(--primary-color); cursor: pointer; padding: 8px 0; transition: opacity 0.2s; flex-grow: 0; flex-shrink: 0; min-width: 44px; }
.header .back-btn:active { opacity: 0.5; }
.header .header-title {
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    max-width: calc(100% - 160px); /* 防止标题太长和两边按钮重叠 */
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.header .header-side.right { min-width: 44px; display: flex; justify-content: flex-end; }
.header-actions { display: flex; align-items: center; gap: 12px; }
.header-icon-btn { border: none; background: none; font-size: 22px; color: var(--text-primary); cursor: pointer; padding: 8px; transition: opacity 0.2s; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }
.header-icon-btn:active { background-color: rgba(0,0,0,0.1); }
.header-icon-btn svg { width: 24px; height: 24px; }
.qq-header-content { display: none; align-items: center; gap: 12px; flex-grow: 1; }
.qq-header-content.active { display: flex; }
#qq-header-avatar-profile, #qq-header-avatar-title { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; cursor: pointer; }
#qq-header-username { font-size: 18px; font-weight: 600; color: var(--text-primary); }
.qq-header-status { display: flex; align-items: center; gap: 5px; font-size: 13px; color: var(--text-secondary); margin-top: 2px; cursor: pointer; }
.qq-header-status .status-dot { width: 8px; height: 8px; background-color: #4CAF50; border-radius: 50%; }
#qq-header-page-title { font-size: 22px; font-weight: 600; color: var(--text-primary); }
#qq-header-dynamic-view { justify-content: flex-start; }
#qq-header-dynamic-title { font-size: 22px; font-weight: 600; color: var(--text-primary); }
#chat-header-title.typing { color: var(--text-secondary); animation: typing-pulse 1.5s infinite; }
@keyframes typing-pulse{ 50% { opacity: .5; } }
#chat-list-screen .qq-content-area { flex-grow: 1; overflow: hidden; position: relative; }
.qq-page { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; flex-direction: column; }
.qq-page.active { display: flex; }
/* ▼▼▼ 全新的滚动魔法与搜索框美颜咒语！▼▼▼ */
/* ✨ 魔法核心：让整个“消息”页面成为可以滚动的区域！*/
#qq-page-messages {
    overflow-y: auto;
    height: 100%;
}

/* ✨ 美颜咒语：给搜索框换上新皮肤！*/
.contact-search-bar {
    background-color: var(--background-light);
    border-radius: 10px; /* 更圆润的边角 */
    padding: 10px 15px; /* 更大的内边距，更有呼吸感 */
    gap: 12px; /* 让图标和文字离远一点 */
}

/* ✨ 美颜咒语：让SVG图标颜色更柔和 */
.contact-search-bar svg {
    color: var(--text-secondary);
    opacity: 0.8;
}
/* ▲▲▲ 魔法结束！▲▲▲ */
/* ▼▼▼ 【V2.2-丝滑动画版】底部导航栏样式 ▼▼▼ */
.qq-tab-bar {
    display: flex;
    border-top: 1px solid var(--border-color);
    background-color: #F9F9F9;
    flex-shrink: 0;
    height: 60px;
}
.qq-tab-item {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 2px;
    cursor: pointer;
    color: var(--text-secondary);
    /* 【核心修改】把整体的颜色过渡交给子元素，控制更精细 */
    -webkit-tap-highlight-color: transparent; /* 去掉移动端点击时的灰色背景 */
}
.qq-tab-item:active {
    /* 【核心修改】移除点击背景色，用动画代替，感觉更清爽 */
}
.qq-tab-icon {
    width: 26px;
    height: 26px;
    position: relative; /* 【动画核心1】让图标们可以重叠 */
}
.qq-tab-icon svg {
    position: absolute; /* 【动画核心2】让两个图标完美重叠 */
    top: 0;
    left: 0;
    /* 【动画核心3】为“变形”和“消失”的过程加上丝滑的过渡效果 */
    transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.2s ease-out;
}
.qq-tab-text {
    font-size: 10px;
    font-weight: 500;
    transition: color 0.3s ease; /* 【动画核心4】让文字颜色也丝滑地变化 */
}

/* --- 默认状态：空心图标显示，实心图标缩小隐藏 --- */
.qq-tab-item .icon-outline {
    opacity: 1;
    transform: scale(1);
}
.qq-tab-item .icon-filled {
    opacity: 0;
    transform: scale(0.7); /* 默认缩小一点，准备“绽放” */
}

/* --- 选中状态：空心图标缩小隐藏，实心图标“绽放”出现 --- */
.qq-tab-item.active .icon-outline {
    opacity: 0;
    transform: scale(0.7);
}
.qq-tab-item.active .icon-filled {
    opacity: 1;
    transform: scale(1);
}
.qq-tab-item.active {
    color: var(--primary-color); /* 这个规则依然生效，会影响到文字和SVG图标 */
}
/* ▲▲▲ 动画魔法注入完成 ▲▲▲ */

/* ▼▼▼ 聊天列表项 · 终极样式 (已移除分割线) ▼▼▼ */

/* 1. 基础框架 */
.chat-list-item {
    position: relative;
    overflow: hidden;
    /* border-bottom: 1px solid #f0f0f0;  <-- 遵命！分割线已移除！ */
}
.chat-list-item:last-child {
    border-bottom: none;
}


/* 2. 滑动区域 (所有皮肤和动画的核心) */
.swipe-content {
    position: relative;
    z-index: 2;
    /* ✨ 默认皮肤：纯白 */
    background-color: var(--background-white); 
    transition: transform 0.3s ease, background-color 0.3s ease; /* ✨ 增加颜色渐变动画！*/
    display: flex;
    align-items: center;
    padding: 10px 16px;
}

/* 3. 按下时的皮肤 */
.chat-list-item:active .swipe-content {
    background-color: #f9f9f9; /* 一个非常浅的灰色，用于点击反馈 */
}

/* 4. ✨ VIP置顶皮肤 (至高无上！) ✨ */
.chat-list-item.pinned .swipe-content {
    background-color: #F0F0F0; /* ✨ 月月修改：为置顶好友换上专属的深色背景 */
}

/* 5. 滑动出来的操作按钮们 */
.swipe-actions {
    position: absolute;
    top: 0;
    right: 0;
    height: 100%;
    z-index: 1;
    display: flex;
    align-items: center;
}

.pin-btn, .delete-btn {
    color: white;
    border: none;
    height: 100%;
    padding: 0 25px;
    font-size: 16px;
    cursor: pointer;
    font-weight: 500;
}

.pin-btn {
    background-color: var(--primary-color); /* 优雅的蓝色 */
}

.delete-btn {
    background-color: #ff3b30; /* 醒目的红色 */
}

/* ▲▲▲ 样式结束 ▲▲▲ */

.chat-list-item img { 
    width: 48px; 
    height: 48px; 
    border-radius: 50%; 
    margin-right: 12px; 
    object-fit: cover; 
    background-color: var(--background-light); 
}
.chat-list-item .info { flex-grow: 1; overflow: hidden; }
.chat-list-item .info h4 { font-size: 17px; font-weight: 500; margin: 0 0 6px 0; color: var(--text-primary); }
.chat-list-item .info p { font-size: 14px; margin: 0; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.contact-functions { padding: 10px 16px; background-color: var(--background-white); }
.contact-search-bar { display: flex; align-items: center; gap: 8px; background-color: var(--background-light); border-radius: 8px; padding: 8px 12px; }
#contact-search-input, #message-search-input { border: none; background: none; outline: none; width: 100%; font-size: 16px; }
.contact-options { background-color: var(--background-white); padding: 0 16px; }
.contact-option-item { display: flex; justify-content: space-between; align-items: center; padding: 16px 0; border-bottom: 1px solid var(--border-color); font-size: 17px; cursor: pointer; transition: background-color 0.2s; }
.contact-option-item:last-child { border-bottom: none; }
.contact-option-item:active { background-color: var(--background-light); }
.contact-option-item span { color: var(--text-secondary); font-size: 20px; }
#contacts-list-container { 
    background-color: var(--background-light); 
}

/* ▼▼▼ CSS修正：专门为联系人列表写的样式，让它恢复排版 ▼▼▼ */
#contacts-list-container .chat-list-item {
    background-color: var(--background-white);
    display: flex;       /* 开启flex布局，让头像和名字信息并排 */
    align-items: center; /* 垂直居中对齐 */
    padding: 10px 16px;  /* 恢复它原来的内边距 */
}
/* ▼▼▼ 【带删除菜单版】动态页面样式 ▼▼▼ */
#qq-page-dynamics { background-color: var(--background-white); overflow: hidden; }
.dynamics-header-profile { display: flex; align-items: center; padding: 20px 16px; gap: 15px; }
#dynamics-user-avatar { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; }
#dynamics-user-name { font-size: 20px; font-weight: 600; }
.dynamics-actions { display: flex; justify-content: space-around; align-items: baseline; padding: 10px 16px; border-bottom: 8px solid var(--background-light); }
.dynamics-actions .action-item:nth-child(2) svg { position: relative; top: 2.3px; }
.dynamics-actions .action-item { display: flex; flex-direction: column; align-items: center; gap: 8px; font-size: 14px; color: var(--text-secondary); cursor: pointer; }
.dynamics-actions .action-item svg { width: 18px; height: 18px; color: var(--text-primary); opacity: 0.6; }
.dynamics-write-post-bar { padding: 15px 16px; border-bottom: 8px solid var(--background-light); }
.dynamics-write-post-bar button { width: 100%; padding: 10px; border: none; background-color: var(--background-light); border-radius: 8px; font-size: 16px; color: var(--text-secondary); cursor: pointer; }
#dynamics-scroll-wrapper { width: 100%; height: 100%; overflow-y: auto; }
.dynamic-post-item { padding: 16px; border-bottom: 1px solid var(--border-color); }
.dynamic-post-item:last-child { border-bottom: none; }
.post-header { display: flex; align-items: center; margin-bottom: 12px; }
.post-header img { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; margin-right: 12px; }
.post-author-info { flex-grow: 1; }
.post-author-info .name { font-size: 17px; font-weight: 600; margin: 0; }
.post-author-info .timestamp { font-size: 13px; color: var(--text-secondary); margin: 2px 0 0 0; }

/* 【核心】“...”按钮的样式 */
.post-more-btn {
    margin-left: auto; /* 把自己推到最右边 */
    border: none;
    background: none;
    cursor: pointer;
    padding: 8px;
    color: var(--text-secondary);
}
.post-more-btn:active {
    background-color: #f0f0f0;
    border-radius: 50%;
}

.post-content .text { font-size: 16px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word; margin-bottom: 10px; }
.post-content .text .mention { color: var(--primary-color); font-weight: 500; }
.post-images { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-bottom: 10px; }
.post-images img { width: 100%; height: auto; aspect-ratio: 1 / 1; object-fit: cover; border-radius: 6px; }
.post-footer { font-size: 13px; color: var(--text-secondary); display: flex; justify-content: space-between; align-items: center; margin-top: 15px; }
.post-footer .device {
    display: flex;
    align-items: center;
    gap: 5px;
}
.post-actions { display: flex; gap: 20px; }
.post-actions button { border: none; background: none; font-size: 18px; color: var(--text-secondary); cursor: pointer; }
#fab-write-dynamic { position: absolute; bottom: 20px; right: 20px; width: 56px; height: 56px; background-color: var(--primary-color); color: white; border: none; border-radius: 50%; font-size: 36px; line-height: 56px; text-align: center;box-shadow: 0 4px 12px var(--shadow-color);cursor: pointer; z-index: 50; }
/* ▲▲▲ 样式升级完成 ▲▲▲ */
/* ▼▼▼ 【Pro Max多图版】写说说页面样式 ▼▼▼ */
#write-dynamic-screen { background-color: #F8F8F8; }
#write-dynamic-screen .header .back-btn { color: var(--text-primary); font-size: 17px; font-weight: normal; }
#write-dynamic-screen .header .header-title { font-weight: 600; }
#write-dynamic-screen .publish-btn { border: none; background-color: #007AFF; color: white; padding: 7px 18px; border-radius: 18px; font-size: 15px; font-weight: 600; cursor: pointer; transition: background-color 0.2s; }
#write-dynamic-screen .publish-btn:active { background-color: #0056b3; }
#write-dynamic-screen .publish-btn:disabled { background-color: #b0d7ff; cursor: not-allowed; }

.write-dynamic-container { flex-grow: 1; overflow-y: auto; padding: 12px; }
.write-dynamic-content-card { background-color: var(--background-white); padding: 15px; border-radius: 12px; margin-bottom: 12px; }
#dynamic-textarea { width: 100%; border: none; outline: none; font-size: 17px; resize: none; min-height: 100px; margin-bottom: 15px; }
#dynamic-textarea::placeholder { color: #c7c7cd; }

/* --- 【核心】九宫格媒体区域 --- */
#dynamic-media-grid-container {
    display: grid;
    grid-template-columns: repeat(3, 1fr); /* 完美的3列网格 */
    gap: 8px; /* 网格间距 */
    margin-bottom: 15px;
}
.dynamic-image-preview-wrapper {
    position: relative;
    width: 100%;
    aspect-ratio: 1 / 1; /* 保持1:1的正方形比例 */
}
.dynamic-image-preview-wrapper img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 8px;
}
.remove-image-btn {
    position: absolute;
    top: 4px;
    right: 4px;
    width: 20px;
    height: 20px;
    background-color: rgba(0, 0, 0, 0.6);
    color: white;
    border: none;
    border-radius: 50%;
    font-size: 14px;
    line-height: 20px;
    text-align: center;
    cursor: pointer;
    padding: 0;
}
.add-photo-placeholder {
    width: 100%;
    height: 100%;
    aspect-ratio: 1 / 1; /* 同样保持1:1的正方形 */
    background-color: #F8F8F8;
    border-radius: 8px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    color: #aeaeae;
    cursor: pointer;
    border: 1px solid #e0e0e0;
}
.add-photo-placeholder svg { width: 28px; height: 28px; color: #cccccc; margin-bottom: 6px; }
.add-photo-placeholder span { font-size: 13px; }

/* --- 内联工具栏 (@ 好友等) --- */
.dynamic-inline-toolbar { display: flex; justify-content: space-between; align-items: center; margin-top: 12px; }
.left-tools { display: flex; gap: 8px; }
.toolbar-btn-inline { display: flex; align-items: center; gap: 5px; border: none; background-color: #F8F8F8; color: #555; padding: 6px 10px; border-radius: 15px; font-size: 13px; font-weight: 500; cursor: pointer; }

/* --- 设置卡片 (权限/定时) --- */
.dynamic-settings-card { background-color: var(--background-white); border-radius: 12px; overflow: hidden; }
.dynamic-setting-item { display: flex; align-items: center; padding: 14px 15px; font-size: 16px; color: var(--text-primary); cursor: pointer; }
.dynamic-setting-item:not(:last-child) { border-bottom: 1px solid #f0f0f0; }
.dynamic-setting-item:active { background-color: #f9f9f9; }
.setting-item-icon { margin-right: 12px; color: #888; display: flex; align-items: center; }
.setting-item-value { margin-left: auto; color: var(--text-secondary); font-size: 15px; }
.setting-item-value .arrow { font-weight: bold; opacity: 0.5; margin-left: 5px; }

/* 移除旧的底部工具栏 */
.write-dynamic-toolbar { display: none; }
/* ▲▲▲ Pro Max版装修完成 ▲▲▲ */

#chat-screen {
    background-size: cover;
    background-position: center;
    background-attachment: fixed;
    display: flex;
    flex-direction: column;
    height: 100%;
}

.chat-messages { padding: 15px; flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; background-color: transparent; overflow-anchor: none;}
.message-wrapper {
    display: flex;
    align-items: center; /* ✨ 添加这一行，实现完美垂直居中 */
    margin-bottom: 8px;
    max-width: 85%;
    position: relative;
}
.chat-avatar { width: 40px; height: 40px; border-radius: 50%; flex-shrink: 0; object-fit: cover; }
.message-bubble {
    position: relative;
    -webkit-user-select: none;
    user-select: none;
}
.message { padding: 10px 16px; word-wrap: break-word; width: fit-content; line-height: 1.5; font-size: var(--chat-font-size, 16px); box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
.message-wrapper.ai { align-self: flex-start; } .message-wrapper.ai .chat-avatar { margin-right: 10px; }
.message-wrapper.user { align-self: flex-end; flex-direction: row-reverse; } .message-wrapper.user .chat-avatar { margin-left: 10px; }
.message-bubble.user .content, .message-bubble.ai .content { background-color: #ffffff; border-radius: 15px; color: #000; }
/* ▼▼▼ “加载更早记录”按钮的专属样式 ▼▼▼ */
.load-more-wrapper {
    text-align: center;
    padding: 15px 0;
}
.load-more-btn {
    background: none;
    border: none;
    color: var(--primary-color);
    font-family: inherit;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    opacity: 0.8;
    transition: opacity 0.2s;
}
.load-more-btn:hover {
    opacity: 1;
}
/* ▲▲▲ 样式结束 ▲▲▲ */
/* ▼▼▼ 全新的聊天输入区豪华装修样式！(究极丝滑进化版) ▼▼▼ */
.chat-input-area {
    align-items: flex-end; /* 保持底部对齐 */
}

/* 把接收按钮和右边的按钮们分开一点 */
#chat-input {
    margin: 0 4px;
}

/* 给右边的表情和加号/发送按钮一个统一的“变美”指令 */
.chat-ui-btn {
    border: none;
    background: none;
    padding: 0;
    width: 38px;
    height: 38px;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: var(--text-primary);
}

/* 这是“+”和“发送”按钮的容器，让它们可以完美重叠 */
#action-btn-container {
    position: relative;
    height: 38px;
    /* ✨ 动画核心：让宽度变化变得丝滑 */
    transition: width 0.2s ease-in-out; 
}

/* “+”号按钮和“发送”按钮的通用定位和动画 */
#plus-btn, #action-btn-container #send-btn {
    position: absolute;
    top: 0;
    right: 0;
    /* ✨ 动画核心：让显隐和缩放也变得丝滑 */
    transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
}

/* 重新设置一下发送按钮的样式 */
#action-btn-container #send-btn {
    padding: 0 15px;
    width: 68px; /* 固定宽度 */
}

/* ▼ 默认状态：显示“+”，隐藏“发送” ▼ */
.chat-input-area:not(.has-text) #action-btn-container {
    width: 38px; /* 容器是“+”号的宽度 */
}
.chat-input-area:not(.has-text) #plus-btn {
    opacity: 1;
    transform: scale(1);
    pointer-events: auto;
}
.chat-input-area:not(.has-text) #send-btn {
    opacity: 0;
    transform: scale(0.8); /* 藏起来的时候是小一点的状态 */
    pointer-events: none; /* 藏起来时不能点 */
}

/* ▼ 输入状态：隐藏“+”，显示“发送” ▼ */
.chat-input-area.has-text #action-btn-container {
    width: 68px; /* 容器扩张成“发送”的宽度 */
}
.chat-input-area.has-text #plus-btn {
    opacity: 0;
    transform: scale(0.8); /* “+”号缩小消失 */
    pointer-events: none;
}
.chat-input-area.has-text #send-btn {
    opacity: 1;
    transform: scale(1); /* “发送”按钮从小变大出现 */
    pointer-events: auto; /* 出现时可以点 */
}
/* ▲▲▲ 豪华装修结束！▲▲▲ */
.chat-input-area { display: flex; align-items: flex-end; padding: 8px; border-top: 1px solid var(--border-color); background-color: #F0F0F0; flex-shrink: 0; gap: 8px; }
#chat-input { flex-grow: 1; border: none; border-radius: 18px; padding: 8px 15px; font-size: 16px; resize: none; background-color: var(--background-white); box-shadow: inset 0 1px 2px rgba(0,0,0,0.05); transition: box-shadow 0.2s; max-height: 100px; }
#chat-input:focus { outline: none; box-shadow: inset 0 1px 2px rgba(0,0,0,0.05), 0 0 0 2px var(--primary-color); }
#send-btn, #receive-btn { border: none; color: white; height: 38px; border-radius: 18px; cursor: pointer; flex-shrink: 0; font-weight: 500; font-size: 15px; transition: all 0.2s; }
#send-btn { background-color: var(--primary-color); padding: 0 20px; }
#receive-btn { background-color: #6c757d; width: 38px; border-radius: 50%; font-size: 20px; padding: 0; background-size: cover; background-position: center; }
#send-btn:active, #receive-btn:active { transform: scale(0.95); }
#send-btn:disabled, #receive-btn:disabled { background-color: #b0b0b0; cursor: not-allowed; }
.settings-panel { position: absolute; bottom: 0; left: 0; width: 100%; height: 95%; background-color: var(--background-light); border-top-left-radius: 20px; border-top-right-radius: 20px; box-shadow: 0 -4px 20px rgba(0,0,0,0.15); transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); z-index: 200; display: flex; flex-direction: column; }
.settings-panel.active {
    transform: translateY(0);
}
.avatar-shape-selector {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
}
.shape-btn {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    padding: 12px;
    border: 2px solid var(--border-color);
    border-radius: 8px;
    background-color: var(--background-white);
    cursor: pointer;
    transition: all 0.2s;
    font-family: inherit;
    font-size: 14px;
    color: var(--text-secondary);
}
.shape-btn svg {
    width: 32px;
    height: 32px;
    color: var(--text-secondary);
    transition: all 0.2s;
}
.shape-btn.active {
    border-color: var(--primary-color);
    background-color: #e8eaf6; /* 一个淡淡的蓝紫色背景 */
    color: var(--primary-color);
}
.shape-btn.active svg {
    color: var(--primary-color);
}
/* 【灵动岛适配】增加了顶部内边距，让面板标题下移 */
.panel-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 16px 10px 16px; border-bottom: 1px solid var(--border-color); background-color: var(--background-white); border-top-left-radius: 20px; border-top-right-radius: 20px; flex-shrink: 0; }
.panel-title { font-weight: 600; font-size: 17px; }
.panel-header-btn {
    border: none;
    background: none;
    font-size: 17px;
    cursor: pointer;
    padding: 10px 16px;
    border-radius: 8px;
    transition: background-color 0.2s;
    font-family: inherit; /* ✨ 让按钮听话的咒语！ ✨ */
}
.panel-header-btn:active { background-color: var(--background-light); }
.panel-header-btn.save-btn { color: var(--primary-color); font-weight: 600; }
.panel-header-btn.cancel-btn { color: var(--text-secondary); }
.settings-card { 
    background-color: var(--background-white); 
    padding: 20px; 
    border-radius: 12px; 
    margin-bottom: 20px; 
    box-shadow: 0 4px 12px var(--shadow-color); 
}
.settings-card h3 { 
    margin-top: 0; 
    font-size: 18px; 
    border-bottom: 1px solid var(--border-color); 
    padding-bottom: 10px; 
    margin-bottom: 15px; 
}
.panel-content label { 
    margin-top: 15px; 
    margin-bottom: 8px; 
    font-weight: 500; 
    color: #333; 
    display: block; 
}
.panel-content label:first-of-type { 
    margin-top: 0; 
}
.panel-content input, 
.panel-content textarea { 
    padding: 12px; 
    border: 1px solid var(--border-color); 
    border-radius: 8px; 
    font-size: 16px; 
    width: 100%; 
    transition: border-color 0.2s, box-shadow 0.2s; 
    background-color: #fcfcfc; 
}
.panel-content textarea { 
    min-height: 80px; 
    resize: vertical; 
}
.panel-content input:focus, 
.panel-content textarea:focus { 
    outline: none; 
    border-color: var(--primary-color); 
    box-shadow: 0 0 0 1px var(--primary-color); 
}
.primary-btn, .secondary-btn, .neutral-btn { 
    margin-top: 10px; 
    padding: 12px; 
    border: none; 
    border-radius: 8px; 
    cursor: pointer; 
    font-size: 16px; 
    font-weight: 500; 
    transition: all 0.2s; 
    width: 100%; 
}
.primary-btn { 
    background-color: var(--primary-color); 
    color: white; 
}
.secondary-btn { 
    background-color: #e9e9eb; 
    color: var(--text-primary); 
}
.primary-btn:active, .secondary-btn:active, .neutral-btn:active { 
    transform: scale(0.98); 
    box-shadow: none; 
}
.card-description { 
    color: var(--text-secondary); 
    font-size: 14px; 
    margin-top: -10px; 
    margin-bottom: 15px; 
}
.panel-content { flex-grow: 1; overflow-y: auto; padding: 20px; }
.avatar-setting { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
.avatar-preview { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; background-color: #eee; border: 2px solid var(--background-white); box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: pointer; }
.emoji-title { margin-right: 8px; }
.neutral-btn { background-color: #e9e9eb !important; color: var(--text-primary) !important; margin-top: 10px; }
#custom-css-input { font-family: monospace; background-color: #2d2d2d; color: #f0f0f0; border-color: #444; }
.font-size-slider-container { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
.font-size-slider-container input[type="range"] { flex-grow: 1; margin: 0; -webkit-appearance: none; background: #ddd; height: 4px; border-radius: 2px; outline: none; }
.font-size-slider-container input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: var(--primary-color); border-radius: 50%; cursor: pointer; box-shadow: 0 0 5px rgba(0,0,0,0.2); }
.font-size-slider-container input[type="range"]::-moz-range-thumb { width: 20px; height: 20px; background: var(--primary-color); border-radius: 50%; cursor: pointer; }
#font-size-value { font-size: 14px; color: var(--text-secondary); min-width: 40px; text-align: right; }
#font-size-preview { margin-top: 10px; align-self: center; max-width: 70%; }
.placeholder-text { padding: 20px; text-align: center; color: var(--text-secondary); flex-grow: 1; display: flex; justify-content: center; align-items: center; }
.appearance-page { display: none; flex-direction: column; width: 100%; height: 100%; }
.appearance-page.active { display: flex; }
/* ▼▼▼ CEO专属 · 自定义下拉菜单样式 v6.1 ▼▼▼ */
.custom-select-wrapper {
    position: relative;
}

.select-selected {
    /* 伪装成和我们其他输入框一样的外观 */
    padding: 12px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    font-size: 16px;
    width: 100%;
    background-color: #fcfcfc;
    cursor: pointer;
    position: relative;
    user-select: none; /* 防止选中文本 */
}

/* 这是下拉箭头 */
.select-selected::after {
    content: '';
    position: absolute;
    right: 15px;
    top: 50%;
    margin-top: -3px;
    width: 0;
    height: 0;
    border-left: 6px solid transparent;
    border-right: 6px solid transparent;
    border-top: 6px solid var(--text-secondary);
    opacity: 0.6;
}

/* 点击时，箭头朝上 */
.select-selected.select-arrow-active::after {
    border-top: none;
    border-bottom: 6px solid var(--text-secondary);
    margin-top: -9px;
}

.select-items {
    position: absolute;
    background-color: var(--background-white);
    top: calc(100% + 5px);
    left: 0;
    right: 0;
    z-index: 99;
    border-radius: 8px;
    box-shadow: 0 4px 12px var(--shadow-color);
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid var(--border-color);
}

.select-items div {
    padding: 12px 15px;
    cursor: pointer;
    border-bottom: 1px solid var(--border-color);
}

.select-items div:last-child {
    border-bottom: none;
}

.select-items div:hover {
    background-color: #f0f0f0;
}

.select-hide {
    display: none;
}
/* ▲▲▲ 样式注入完成 ▲▲▲ */
/* ▼▼▼ 这是图标设置页面的专属美颜魔法！ ▼▼▼ */
.icon-setting-item {
    padding: 15px; /* 增加卡片内部的间距，让它不那么挤 */
}
.icon-setting-item .buttons {
    margin-top: 12px; /* 让按钮和上面的名字拉开一点距离 */
}
.icon-setting-item button {
    border: none; /* 去掉原来的边框 */
    padding: 5px 12px; /* 调整按钮大小 */
    border-radius: 15px; /* ✨ 把它变成可爱的药丸形状！ */
    font-weight: 500; /* 字体稍微加粗一点点 */
    transition: transform 0.2s; /* 为点击动画做准备 */
}
.icon-setting-item button:active {
    transform: scale(0.95); /* 点击时有按压效果 */
}
/* 单独给“URL”按钮换上温柔的灰色 */
.icon-setting-item .url-btn {
    background-color: #e9e9eb;
    color: var(--text-primary);
}
/* ▲▲▲ 美颜魔法结束 ▲▲▲ */
/* ▼▼▼ CEO专属 · 页面底部操作按钮容器样式 ▼▼▼ */
.page-actions-container {
    padding: 0 20px 20px 20px; /* 控制按钮的左右边距和底部边距 */
    margin-top: auto;         /* 魔法！这会让按钮容器自动被推到页面的最底部 */
}
/* ▲▲▲ 样式注入完成 ▲▲▲ */
/* 这是月月给锁屏按钮选的新衣服颜色哦 */
.font-tutorial { margin-top: 25px; padding: 15px; background-color: var(--background-light); border-radius: 8px; }
.font-tutorial h4 { margin-top: 0; }
.font-tutorial p, .font-tutorial li { color: var(--text-secondary); font-size: 14px; line-height: 1.6; }
#icon-settings-container { flex-grow: 1; overflow-y: auto; padding: 20px; }
.icon-settings-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
/* ▼▼▼ CEO专属 · 图标设置列表原生化改造 v5.1 ▼▼▼ */
#icon-settings-grid {
    background-color: var(--background-white);
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    margin: 0 15px; /* 让整个列表组左右有边距 */
}

.icon-setting-item {
    display: grid; /* 我们用grid来精控内部布局 */
    grid-template-columns: 80px 1fr; /* 左边80px放预览，右边自适应 */
    grid-template-areas: 
        "preview name"
        "preview buttons";
    align-items: center;
    padding: 15px;
    border-bottom: 1px solid var(--border-color);
}

#icon-settings-grid .icon-setting-item:last-child {
    border-bottom: none; /* 最后一项不要分割线 */
}

/* 下面是微调内部元素的位置 */
.icon-setting-item .preview {
    grid-area: preview; /* 定位到"preview"区域 */
    margin: 0; /* 清除旧的margin */
}
.icon-setting-item p {
    grid-area: name; /* 定位到"name"区域 */
    justify-self: start; /* 文字左对齐 */
    margin: 0 0 8px 10px;
}
.icon-setting-item .buttons {
    grid-area: buttons; /* 定位到"buttons"区域 */
    justify-self: start; /* 按钮组左对齐 */
    margin-left: 10px;
}
/* ▲▲▲ 改造完成 ▲▲▲ */
.icon-setting-item .preview { width: 60px; height: 60px; border-radius: 14px; margin-bottom: 8px; background-color: #eee; background-size: cover; background-position: center; }
.icon-setting-item p { font-size: 13px; margin: 0 0 8px 0; font-weight: 500; }
.icon-setting-item .buttons { display: flex; gap: 5px; }
.icon-setting-item button { font-size: 12px; padding: 4px 8px; border-radius: 6px; border: 1px solid var(--primary-color); cursor: pointer; }
.icon-setting-item .upload-btn { background-color: var(--primary-color); color: white; }
.icon-setting-item .url-btn { background-color: white; color: var(--primary-color); }
.icon-tip { text-align: center; color: var(--text-secondary); font-size: 14px; padding: 15px; background: var(--background-light); margin: 20px; border-radius: 8px; }
#save-icons-btn { margin: 0 20px 20px 20px; }
.worldbook-list-container { flex-grow: 1; overflow-y: auto; padding: 20px; }
.worldbook-group-header { font-size: 1.1em; font-weight: bold; color: var(--text-secondary); margin: 20px 0 10px 0; padding-bottom: 5px; border-bottom: 1px solid var(--border-color); }
.worldbook-group-header:first-child { margin-top: 0; }
.worldbook-item { background-color: var(--background-white); padding: 15px 20px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
.worldbook-item:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
.worldbook-item h4 { margin: 0 0 5px 0; font-size: 17px; }
.worldbook-item p { margin: 0; font-size: 14px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.add-new-btn {
    margin: 0 20px 20px;
    padding: 15px;
    border: none;
    background-color: var(--primary-color);
    color: white;
    border-radius: 12px;
    cursor: pointer;
    font-size: 16px;
    font-weight: 500;
    transition: all 0.2s;
    box-shadow: 0 4px 10px var(--shadow-color); /* ✨ 修改在这里 */
}
.add-new-btn:active {
    transform: scale(0.98);
    box-shadow: 0 2px 5px var(--shadow-color); /* ✨ 修改在这里 */
}
#worldbook-link-container details { border-bottom: 1px solid var(--border-color); }
#worldbook-link-container details:last-child { border-bottom: none; }
#worldbook-link-container summary { padding: 15px 10px; font-weight: 500; cursor: pointer; display: flex; align-items: center; justify-content: space-between; transition: background-color 0.2s; }
#worldbook-link-container summary:hover { background-color: rgba(0,0,0,0.03); }
.wb-link-group-header { display: flex; align-items: center; gap: 10px; }
.wb-link-group-header input[type="checkbox"] { transform: scale(1.2); }
.wb-link-item-list { padding: 5px 10px 15px 45px; }
.wb-link-item { display: flex; align-items: center; gap: 10px; padding: 8px 0; }
.wb-link-item input[type="checkbox"] { transform: scale(1.2); }
.message-wrapper.ai + .message-wrapper.ai, .message-wrapper.user + .message-wrapper.user { margin-top: -8px; }
.message-wrapper.ai + .message-wrapper.ai .message-bubble.ai .content { border-top-left-radius: 5px; }
.message-wrapper.user + .message-wrapper.user .message-bubble.user .content { border-top-right-radius: 5px; }
/* ▼▼▼ 【月月指挥版·最终微调】“@”好友列表样式 ▼▼▼ */
/* ▼▼▼ 【月月终调版·像素完美】“@”好友列表样式 ▼▼▼ */
#mention-friends-panel {
    height: 95%;
    background-color: var(--background-white);
}
#mention-friends-panel .settings-search-container {
    padding: 12px 15px;
    background-color: var(--background-white);
    position: sticky;
    top: 0;
    z-index: 1;
    border-bottom: 1px solid #f0f0f0;
}
#mention-friends-panel .panel-content {
    padding: 0;
}

.mention-list-item {
    display: flex;
    align-items: center;
    /* 【遵命】缩短好友间距 */
    padding: 6px 15px; 
    background-color: transparent;
    border-bottom: none !important;
    transition: background-color 0.2s;
    -webkit-tap-highlight-color: transparent;
}
.mention-list-item:last-child {
    border-bottom: none !important;
}
.mention-list-item:active {
    background-color: #f9f9f9;
}

/* --- 复选框样式 --- */
.mention-list-item input[type="checkbox"] {
    -webkit-appearance: none;
    appearance: none;
    background-color: transparent;
    margin: 0;
    margin-right: 15px;
    /* 【遵命】复选框调小一点点 */
    width: 20px;
    height: 20px;
    border: 1.5px solid #d1d1d6;
    border-radius: 50%;
    cursor: pointer;
    position: relative;
    outline: none;
    flex-shrink: 0;
    transition: all 0.2s ease;
}
.mention-list-item input[type="checkbox"]:checked {
    background-color: #007AFF;
    border-color: #007AFF;
}
/* 配合复选框缩小，微调对勾位置 */
.mention-list-item input[type="checkbox"]:checked::after {
    content: '';
    position: absolute;
    left: 6px; 
    top: 3px;
    width: 5px;
    height: 10px;
    border: solid white;
    border-width: 0 2px 2px 0;
    transform: rotate(45deg);
}

/* --- 【月月的最终设计稿】 --- */
.mention-list-item img {
    /* 【遵命】头像大一点点 */
    width: 45px;
    height: 45px;
    border-radius: 50%;
    object-fit: cover;
    margin-right: 12px;
    position: relative;
    /* 【遵命】头像向下移动5像素 */
    top: 5px; 
}
.mention-list-item span {
    font-size: 16px;
    color: var(--ios-text-primary);
    position: relative;
    /* 【遵命】名字向上移动9像素 */
    top: -9px; 
}
/* ▲▲▲ 像素完美版施工完成！ ▲▲▲ */

/* ▼▼▼ 长按删除与多选功能专属样式 ▼▼▼ */
/* 底部弹出的操作菜单 (Action Sheet) */
.action-sheet-backdrop {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background-color: rgba(0,0,0,0.3);
    z-index: 250;
    opacity: 0;
    transition: opacity 0.3s;
    display: none;
}
.action-sheet-backdrop.visible {
    display: block;
    opacity: 1;
}
.action-sheet {
    position: absolute;
    bottom: 0; left: 0;
    width: 100%;
    background-color: var(--background-light);
    border-top-left-radius: 16px;
    border-top-right-radius: 16px;
    padding: 8px;
    z-index: 251;
    transform: translateY(100%);
    transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
}
.action-sheet.visible {
    transform: translateY(0);
}
.action-sheet-group {
    background-color: var(--background-white);
    border-radius: 12px;
    margin-bottom: 8px;
    overflow: hidden;
}
.action-sheet-item, .action-sheet-cancel {
    padding: 16px;
    font-size: 17px;
    text-align: center;
    color: var(--primary-color);
    cursor: pointer;
    border-bottom: 1px solid var(--border-color);
}
.action-sheet-item:last-child {
    border-bottom: none;
}
.action-sheet-item.delete {
    color: var(--delete-red);
}
.action-sheet-item:active, .action-sheet-cancel:active {
    background-color: #f0f0f0;
}
.action-sheet-cancel {
    background-color: var(--background-white);
    border-radius: 12px;
    font-weight: 600;
    border-bottom: none;
}

/* 多选模式的样式 */
/* ▼▼▼ 多选模式专属UI样式 ▼▼▼ */
#multi-select-header {
    display: none; /* 默认隐藏 */
    background-color: var(--background-light);
    border-bottom: 1px solid var(--border-color);
}

#multi-select-header .cancel-btn {
    padding: 8px 10px;
    font-weight: normal;
    color: var(--text-primary);
}

#multi-select-title {
    font-size: 17px;
    font-weight: 600;
}

#multi-select-bar {
    justify-content: space-between; /* 让左右两边的按钮分开 */
}

.multi-select-actions {
    display: flex;
    gap: 15px; /* 让分享和收藏按钮之间有点空隙 */
}

#multi-select-share-btn,
#multi-select-favorite-btn,
#multi-select-delete-btn {
    color: var(--text-primary); /* 统一图标颜色 */
}
/* ▲▲▲ 多选模式专属UI样式结束 ▲▲▲ */
.message-wrapper.multi-select-mode .chat-avatar {
    display: none; /* 多选时隐藏头像 */
}
.message-wrapper.multi-select-mode {
    padding-left: 15px; /* 为复选框留出空间 */
    max-width: 100%;
}
.multi-select-checkbox {
    width: 22px; height: 22px;
    border: 2px solid #ccc;
    border-radius: 50%;
    margin-right: 15px;
    transition: all 0.2s;
    flex-shrink: 0;
    display: none; /* 默认隐藏 */
    align-items: center;
    justify-content: center;
}
.message-wrapper.multi-select-mode .multi-select-checkbox {
    display: flex; /* 在多选模式下显示 */
}
.multi-select-checkbox.checked {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
}
.multi-select-checkbox.checked svg {
    stroke: white; /* 对勾颜色 */
}
#multi-select-bar {
    position: absolute;
    bottom: 0; left: 0;
    width: 100%;
    height: 60px;
    background-color: var(--background-white);
    border-top: 1px solid var(--border-color);
    display: none; /* 默认隐藏 */
    justify-content: flex-end;
    align-items: center;
    padding: 0 20px;
    z-index: 200;
}
#multi-select-delete-btn {
    border: none;
    background: none;
    cursor: pointer;
}
/* ▲▲▲ 样式结束 ▲▲▲ */
/* 月月的锁屏美化咒语 ✨ */

#lock-screen {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 999;
    /* ✨ 任务一：在这里加上你的默认壁纸！ */
    background-image: url('https://files.catbox.moe/0081uq.jpg'); /* 我帮你找了一个可爱的默认图，你可以换成自己的！ */
    background-size: cover;
    background-position: center;
    color: white;
    display: flex;
    flex-direction: column;
    /* ✨ 任务二：把内容从屏幕中间，移动到顶部区域 */
    justify-content: flex-start; /* 不再是center居中啦 */
    padding-top: 15vh; /* 距离顶部留出15%的高度，这样就不会被状态栏挡住 */
    align-items: center;
    text-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
    transition: transform 0.3s ease-out, opacity 0.3s; /* 解锁动画更柔和 */
}

#lock-screen-time {
    font-size: 80px;
    /* ✨ 字体调细一点，更有苹果内味儿~ */
    font-weight: 500; 
    margin: 0; /* 去掉之前的间距调整 */
}

#lock-screen-date {
    font-size: 18px;
    font-weight: 500;
    /* ✨ 在日期下面加一点点间距，让它和时间分开一点点 */
    margin-bottom: 5px; 
}

#lock-screen-prompt {
    position: absolute; /* 把提示放在屏幕最底下 */
    bottom: 50px; /* 距离底部 50px */
    font-size: 16px;
    font-weight: 500;
    /* 给文字加一个酷酷的上下呼吸动画 */
    animation: bounce 2s infinite;
}

/* 这是上面那个动画的具体实现 */
@keyframes bounce {
    0%, 20%, 50%, 80%, 100% {
        transform: translateY(0);
    }
    40% {
        transform: translateY(-10px);
    }
    60% {
        transform: translateY(-5px);
    }
}
/* ▼▼▼ 五子棋专属美化CSS ▼▼▼ */
:root {
    --gobang-bg: #F3F0EC; /* 棋盘背景 - 柔和米白 */
    --gobang-board: #EADFD6; /* 棋盘颜色 - 暖灰褐 */
    --gobang-line: #BFAFA2; /* 棋盘线 - 灰褐色 */
    --gobang-black: #5A5A5A; /* 黑色棋子 - 炭灰色 */
    --gobang-white: #FEFEFE; /* 白色棋子 - 纯白 */
    --gobang-primary: #A2B2A0; /* 主按钮 - 灰豆绿 */
    --gobang-secondary: #D4C9C1; /* 次按钮 - 浅灰粉 */
    --gobang-text: #6D6864; /* 主要文字 - 深灰褐 */
    --gobang-shadow: rgba(0, 0, 0, 0.1); /* 阴影 */
}

#gobang-screen {
    background-color: var(--gobang-bg);
}

#gobang-game-container {
    width: 100%;
    height: 100%;
    padding: 15px;
    display: flex;
    flex-direction: column;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
}

/* 玩家信息 */
.gobang-player-info {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px;
    flex-shrink: 0;
}
.gobang-player-info.self {
    flex-direction: row-reverse;
}
.gobang-avatar-wrapper {
    position: relative;
    width: 64px;
    height: 64px;
    cursor: pointer;
}
.gobang-avatar {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    object-fit: cover;
    position: absolute;
    top: 4px; left: 4px;
    border: 2px solid var(--gobang-bg);
    box-shadow: 0 2px 5px var(--gobang-shadow);
    transition: transform 0.2s;
}
.gobang-avatar-wrapper:active .gobang-avatar {
    transform: scale(0.95);
}
.gobang-player-name {
    font-size: 16px;
    font-weight: 500;
    color: var(--gobang-text);
}
.gobang-avatar-wrapper.pat-effect .gobang-avatar {
    animation: pat-animation 0.5s ease-in-out;
}
@keyframes pat-animation {
    0%, 100% { transform: scale(1) rotate(0deg); }
    25% { transform: scale(1.05) rotate(8deg); }
    75% { transform: scale(1.05) rotate(-8deg); }
}

/* 倒计时圈 */
.gobang-timer-ring svg {
    position: absolute;
    top: 0; left: 0;
    transform: rotate(-90deg);
}
.gobang-timer-ring circle {
    fill: transparent;
    stroke-width: 4px;
    transition: stroke-dashoffset 0.3s linear;
}
.timer-bg {
    stroke: var(--gobang-secondary);
}
.timer-progress {
    stroke: var(--gobang-primary);
    stroke-linecap: round;
    stroke-dasharray: 188.5; /* 2 * PI * 30 */
    stroke-dashoffset: 188.5;
}
.gobang-player-info.active .timer-progress {
    stroke-dashoffset: 0; /* 示例，JS会控制 */
}

/* 棋盘 */
#gobang-board-wrapper {
    width: 100%;
    max-width: 400px;
    margin: 10px auto;
    position: relative;
    flex-shrink: 0;
}
#gobang-board-svg {
    width: 100%;
    height: auto;
    display: block;
    background-color: var(--gobang-board);
    border-radius: 12px;
    box-shadow: 0 5px 15px var(--gobang-shadow);
}
#gobang-board-svg .board-line {
    stroke: var(--gobang-line);
    stroke-width: 2;
}
#gobang-board-svg .star-point {
    fill: var(--gobang-line);
}
#gobang-board-svg .board-piece {
    filter: drop-shadow(0 2px 3px rgba(0,0,0,0.25));
    transition: transform 0.2s ease;
}
#gobang-board-svg .last-move-marker {
    fill: none;
    stroke: #E57373;
    stroke-width: 3;
}

/* 游戏遮罩层 */
#gobang-game-overlay {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background-color: rgba(243, 240, 236, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    text-align: center;
    border-radius: 12px;
    backdrop-filter: blur(2px);
    transition: opacity 0.3s, visibility 0.3s;
}
#gobang-game-overlay.hidden {
    opacity: 0;
    visibility: hidden;
}
#gobang-overlay-content #gobang-game-status {
    font-size: 20px;
    font-weight: 600;
    color: var(--gobang-text);
    margin: 0 0 20px 0;
}
.gobang-btn {
    padding: 10px 25px;
    border: none;
    border-radius: 20px;
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: 0 3px 8px var(--gobang-shadow);
}
.gobang-btn:active {
    transform: scale(0.97);
    box-shadow: 0 1px 4px var(--gobang-shadow);
}
.gobang-btn.primary {
    background-color: var(--gobang-primary);
    color: white;
}
.gobang-btn.secondary {
    background-color: var(--gobang-secondary);
    color: var(--gobang-text);
}
.gobang-btn:disabled {
    background-color: #E0E0E0;
    cursor: not-allowed;
    box-shadow: none;
}

/* 控制与聊天 */
#gobang-controls {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin: 15px 0;
    flex-shrink: 0;
}
#gobang-chat-wrapper {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    background-color: #fff;
    border-radius: 12px;
    overflow: hidden;
    min-height: 40vh;
    box-shadow: 0 2px 8px var(--gobang-shadow);
}
#gobang-chat-history {
    flex-grow: 1;
    padding: 12px;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    display: flex;
flex-direction: column;
}
.gobang-chat-message {
    margin-bottom: 8px;
    max-width: 80%;
}
.gobang-chat-message p {
    padding: 8px 12px;
    border-radius: 18px;
    margin: 0;
    line-height: 1.4;
    width: fit-content;
    font-size: 15px;
}
.gobang-chat-message.self {
    align-self: flex-end; /* 关键改动：让它靠右对齐 */
}
.gobang-chat-message.self p {
    background-color: var(--gobang-primary);
    color: white;
    border-bottom-right-radius: 4px;
}
.gobang-chat-message.opponent p {
    background-color: #EFEFEF;
    color: var(--gobang-text);
    border-bottom-left-radius: 4px;
}
.gobang-chat-message.system {
    text-align: center;
    margin: 8px auto;
    width: 100%;
}
.gobang-chat-message.system p {
    background-color: transparent;
    color: #AAA;
    font-size: 12px;
    margin: 0 auto;
}

.gobang-chat-input-area {
    display: flex;
    padding: 8px;
    border-top: 1px solid var(--border-color);
    background-color: #F9F9F9;
    flex-shrink: 0;
}
#gobang-chat-input {
    flex-grow: 1;
    border: none;
    background: none;
    outline: none;
    font-size: 15px;
    padding: 0 8px;
}
#gobang-send-chat-btn {
    border: none;
    background: var(--gobang-primary);
    color: white;
    width: 36px; height: 36px;
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: pointer;
    transition: transform 0.2s;
}
#gobang-send-chat-btn:active {
    transform: scale(0.9);
}
/* ▼▼▼ 五子棋好友选择界面CSS ▼▼▼ */
#gobang-friend-list {
    padding: 20px;
    flex-grow: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 15px;
}
.gobang-friend-item {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 15px;
    background-color: var(--background-white);
    border-radius: 12px;
    box-shadow: 0 3px 8px var(--gobang-shadow);
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
}
.gobang-friend-item:active {
    transform: scale(0.98);
    box-shadow: 0 1px 4px var(--gobang-shadow);
}
.gobang-friend-item img {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    object-fit: cover;
}
.gobang-friend-item p {
    margin: 0;
    font-size: 17px;
    font-weight: 500;
    color: var(--gobang-text);
}
/* ▲▲▲ 五子棋好友选择界面CSS结束 ▲▲▲ */
/* ▼▼▼ 五子棋消息悬浮提示框CSS ▼▼▼ */
.gobang-player-info {
    position: relative; /* 让气泡可以相对于玩家信息定位 */
}
.gobang-message-toast-container {
    position: absolute;
    left: 80px; /* 从头像右侧开始 */
    width: calc(100% - 90px);
    pointer-events: none; /* 让气泡不影响点击 */
    z-index: 10;
}
.gobang-player-info.self .gobang-message-toast-container {
    left: auto;
    right: 80px; /* 你的气泡在左侧 */
    text-align: right;
}
#gobang-opponent-info .gobang-message-toast-container {
    top: 100%;
    margin-top: -10px;
}
#gobang-self-info .gobang-message-toast-container {
    bottom: 100%;
    margin-bottom: -10px;
}
.gobang-message-toast {
    display: inline-block;
    max-width: 100%;
    padding: 10px 15px;
    background-color: var(--gobang-primary);
    color: white;
    border-radius: 18px;
    font-size: 15px;
    opacity: 0;
    transform: translateY(10px) scale(0.9);
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.gobang-player-info.self .gobang-message-toast {
    background-color: #fff;
    color: var(--gobang-text);
    transform: translateY(-10px) scale(0.9);
}
.gobang-message-toast.show {
    opacity: 1;
    transform: translateY(0) scale(1);
}
/* ▲▲▲ 消息提示框CSS结束 ▲▲▲ */
/* ▼▼▼ 密码输入界面专属样式 (V2.0 美化版) ▼▼▼ */
#passcode-screen {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 998;
    color: white;
    text-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
}

.passcode-background-blur {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    backdrop-filter: blur(20px) brightness(0.7);
    -webkit-backdrop-filter: blur(20px) brightness(0.7);
}

.passcode-content {
    position: relative;
    z-index: 1;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    /* 调整内边距，让整体内容更居中 */
    padding: 20vh 0 8vh 0; 
}

#passcode-prompt {
    font-size: 20px;
    font-weight: 500;
    margin: 0 0 20px 0;
}

#passcode-dots {
    display: flex;
    gap: 20px;
    /* 减小与键盘的距离，让布局更紧凑 */
    margin-bottom: 60px; 
    height: 20px;
    transition: transform 0.4s;
}

#passcode-dots.shake {
    animation: shake 0.5s ease-in-out;
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-8px); }
    20%, 40%, 60%, 80% { transform: translateX(8px); }
}

#passcode-dots .dot {
    width: 16px;
    height: 16px;
    border: 1.5px solid white;
    border-radius: 50%;
    transition: background-color 0.2s;
}

#passcode-dots .dot.filled {
    background-color: white;
}

.passcode-numpad {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
    width: 100%;
    /* 核心修改：减小键盘的最大宽度，让按键变小 */
    max-width: 250px; 
    margin: 0 auto;
    /* 核心修改：移除 flex-grow，防止键盘过度撑开垂直空间 */
}

.passcode-key {
    border: none;
    background-color: rgba(255, 255, 255, 0.2);
    color: white;
    border-radius: 50%;
    font-size: 32px;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    aspect-ratio: 1 / 1;
    transition: background-color 0.2s;
    -webkit-tap-highlight-color: transparent;
}

.passcode-key:active {
    background-color: rgba(255, 255, 255, 0.4);
}

.key-number {
    line-height: 1;
}
.key-letters {
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 1px;
    margin-top: 2px;
    opacity: 0.9;
}
/* 颜文字的专属样式 */
.key-kaomoji {
    font-size: 10px; /* 字号从 12px 缩小到 10px */
    font-weight: normal;
    margin-top: 4px;
    opacity: 0.9;
    line-height: 1;
}

/* 专门微调数字 "1" 的位置 */
.passcode-key[data-key="1"] .key-number {
    position: relative;
    top: 1px; /* 把它向下移动 2 像素 */
}

#passcode-cancel-btn {
    border: none;
    background: none;
    color: white;
    font-size: 17px;
    font-weight: 500;
    cursor: pointer;
    padding: 15px 30px;
    margin-left: auto;
    margin-right: 30px;
    /* 核心修改：让取消按钮占据固定空间，不再被键盘挤到最下面 */
    margin-top: auto; 
}
/* ▲▲▲ 密码输入界面专属样式结束 ▲▲▲ */
/* ▼▼▼ iOS 风格开关按钮样式 ▼▼▼ */
.ios-switch {
    position: relative;
    display: inline-block;
    width: 51px;
    height: 31px;
}
.ios-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}
.ios-switch .slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #E9E9EB;
    transition: .4s;
    border-radius: 34px;
}
.ios-switch .slider:before {
    position: absolute;
    content: "";
    height: 27px;
    width: 27px;
    left: 2px;
    bottom: 2px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
.ios-switch input:checked + .slider {
    background-color: #34C759; /* 苹果绿 */
}
.ios-switch input:checked + .slider:before {
    transform: translateX(20px);
}
/* ▲▲▲ iOS 风格开关按钮样式结束 ▲▲▲ */
/* ▼▼▼ 灵动岛专属样式 ▼▼▼ */
/* 【月月老板要求】移除了灵动岛的阴影 */
#dynamic-island {
    position: absolute;
    z-index: 1001;
    width: 130px;
    height: 32px;
    background-color: #000;
    border-radius: 50px;
    cursor: pointer;
    transition: all 0.5s cubic-bezier(0.68, -0.6, 0.32, 1.6);
}
.top-area-container {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 50px; /* 定义顶部区域的总高度 */
    display: flex;
    justify-content: center; /* 水平居中灵动岛 */
    align-items: center;   /* 垂直居中所有子元素 */
    pointer-events: none; /* 允许点击穿透 */
}
/* ▲▲▲ 灵动岛样式结束 ▲▲▲ */
/* ▲▲▲ 五子棋CSS结束 ▲▲▲ */
/* ▼▼▼ 棋艺选择器美化CSS ▼▼▼ */
.skill-selector-container {
    display: flex;
    background-color: var(--background-light);
    border-radius: 10px;
    padding: 5px;
    border: 1px solid var(--border-color);
}
.skill-btn {
    flex: 1;
    border: none;
    background-color: transparent;
    padding: 10px;
    border-radius: 8px;
    cursor: pointer;
    font-family: inherit;
    font-size: 14px;
    font-weight: 500;
    color: var(--text-secondary);
    transition: all 0.25s ease;
}
.skill-btn.active {
    background-color: var(--background-white);
    color: var(--text-primary);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    transform: scale(1.02);
}
/* ▲▲▲ 棋艺选择器美化CSS结束 ▲▲▲ */
/* ▼▼▼ 世界书分组管理按钮样式 v1.0 (月月专属) ▼▼▼ */
.worldbook-group-header {
    display: flex; /* 让组名和按钮可以并排站好 */
    justify-content: space-between; /* 把按钮推到最右边 */
    align-items: center; /* 让它们垂直居中，更整齐 */
}

/* 隐藏浏览器自带的丑箭头 (这段你可能已经有了，检查一下就好) */
.worldbook-group-header::-webkit-details-marker,
.worldbook-group-header::marker {
    display: none;
}
.worldbook-group-header {
    list-style: none;
}

/* 我们自己的漂亮小箭头 */
.group-name-span::after {
    content: '›';
    font-size: 24px;
    font-weight: bold;
    color: var(--text-secondary);
    opacity: 0.5;
    transition: transform 0.2s ease-in-out;
    display: inline-block; /* 让箭头可以旋转 */
    margin-left: 8px;
}

/* 当文件夹展开时，让箭头旋转 */
details[open] > .worldbook-group-header .group-name-span::after {
    transform: rotate(90deg);
}

.group-buttons button {
    border: none;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    margin-left: 8px;
    transition: all 0.2s;
}
.group-buttons button:active {
    transform: scale(0.95);
}

.rename-group-btn {
    background-color: #e0eaff; /* 温柔的蓝色 */
    color: #5b6ac2;
}

.delete-group-btn {
    background-color: #ffe0e0; /* 警示的红色 */
    color: #c25b5b;
}
/* ▲▲▲ 按钮穿衣完成！ ▲▲▲ */
/* ▼▼▼ CEO专属 · 可折叠世界书分组样式 v6.2 ▼▼▼ */
#worldbook-list-container details {
    margin-bottom: 5px; /* 让分组之间有一点点呼吸感 */
}

.worldbook-group-header {
    /* 我们让<summary>继承之前的标题样式，并做一些微调 */
    padding: 10px 15px;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.2s;
    position: relative; /* 为了定位箭头 */
    user-select: none; /* 防止点击时选中文本 */
    -webkit-tap-highlight-color: transparent; /* 核心命令：禁用移动端点击高亮 */
}

/* 鼠标滑过时给一个反馈 */
.worldbook-group-header:hover {
    background-color: rgba(0,0,0,0.03);
}

/* ▼▼▼ CEO专属 · 取消分组标题点击高亮 v6.3 ▼▼▼ */
.worldbook-group-header:focus {
    outline: none; /* 核心命令：移除浏览器自带的聚焦轮廓或背景 */
}
/* ▲▲▲ 指令下达完毕 ▲▲▲ */

/* 隐藏浏览器自带的丑箭头 */
.worldbook-group-header::-webkit-details-marker,
.worldbook-group-header::marker {
    display: none;
}
.worldbook-group-header {
    list-style: none; /* 针对Firefox浏览器 */
}

/* 用CSS绘制我们自己的漂亮箭头 */
.worldbook-group-header::after {
    content: '›';
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%) rotate(0deg);
    font-size: 24px;
    font-weight: bold;
    color: var(--text-secondary);
    opacity: 0.5;
    transition: transform 0.2s ease-in-out;
}

/* 当文件夹[open]展开时，让我们的箭头旋转90度 */
#worldbook-list-container details[open] > .worldbook-group-header::after {
    transform: translateY(-50%) rotate(90deg);
}

/* 展开后，让里面的条目和标题之间有点距离 */
#worldbook-list-container details[open] > .worldbook-item {
    margin-left: 10px;
    margin-right: 10px;
}
/* ▲▲▲ 样式注入完成 ▲▲▲ */
.settings-form { 
    padding: 20px; 
    display: flex; 
    flex-direction: column; 
    flex-grow: 1; 
    overflow-y: auto; 
}
.settings-form label { 
    margin-top: 15px; 
    margin-bottom: 8px; 
    font-weight: 500; 
    color: #333; 
    display: block; 
}
.settings-form label:first-of-type { 
    margin-top: 0; 
}
.settings-form input, .settings-form select, .settings-form textarea { 
    padding: 12px; 
    border: 1px solid var(--border-color); 
    border-radius: 8px; 
    font-size: 16px; 
    width: 100%; 
    transition: border-color 0.2s, box-shadow 0.2s; 
    background-color: #fcfcfc; 
}
.settings-form textarea { 
    min-height: 80px; 
    resize: vertical; 
}
.settings-form input:focus, .settings-form select:focus, .settings-form textarea:focus { 
    outline: none; 
    border-color: var(--primary-color); 
    box-shadow: 0 0 0 1px var(--primary-color); 
}
/* ▼▼▼ ins风自定义弹窗样式 v2.0 (终极进化版) ▼▼▼ */
.custom-prompt-backdrop {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.4);
    z-index: 1000;
    display: none;
    justify-content: center;
    align-items: center;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.custom-prompt-backdrop.visible {
    display: flex;
    opacity: 1;
}

.custom-prompt {
    background-color: var(--background-white);
    padding: 25px;
    border-radius: 18px;
    width: calc(100% - 60px);
    max-width: 320px;
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
    text-align: center;
    /* ✨ 魔法升级：我们只让 transform 产生动画，更流畅！ */
    transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    transform: scale(0.95);
}

.custom-prompt-backdrop.visible .custom-prompt {
    transform: scale(1); /* 默认状态 */
}



.custom-prompt h3 {
    margin-top: 0;
    margin-bottom: 20px;
    font-size: 18px;
    font-weight: 600;
    color: var(--text-primary);
}

.custom-prompt input {
    width: 100%;
    padding: 12px 15px;
    border: 1px solid var(--border-color);
    border-radius: 10px;
    font-size: 16px;
    margin-bottom: 25px;
    background-color: var(--background-light);
}
.custom-prompt input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 2px rgba(142, 154, 175, 0.3);
}

.custom-prompt-buttons {
    display: flex;
    gap: 12px;
}

.custom-prompt-buttons .prompt-btn {
    flex: 1;
    padding: 12px;
    border: none;
    border-radius: 10px;
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
}
.custom-prompt-buttons .prompt-btn:active {
    transform: scale(0.97);
}

.prompt-btn.primary {
    background-color: var(--primary-color);
    color: white;
}
.prompt-btn.secondary {
    background-color: #e9e9eb;
    color: var(--text-primary);
}
/* ▲▲▲ 弹窗化妆完成！ ▲▲▲ */
/* ▼▼▼ 全新纯iOS风格设置页面 v3.1 (ins质感美化版) 开始 ▼▼▼ */
:root {
    /* iOS 风格色彩 (清新版) */
    --ios-blue-fresh: #4A89F2; /* 一种更现代、柔和的蓝色 */
    --ios-bg-page: #F8F8F8;   /* 页面背景 - 极浅的灰色 */
    --ios-bg-white: #FFFFFF;   /* 卡片背景 - 纯白 */
    --ios-separator: #EFEFEF;  /* 分割线颜色 - 更浅的灰色 */
    --ios-text-primary: #1C1C1E; /* 主要文字 - 柔和的黑色 */
    --ios-text-secondary: #8A8A8E; /* 次要文字 - 苹果标准灰色 */
    --ios-placeholder-text: #C7C7CD;
    --shadow-color: rgba(60, 64, 67, 0.08); /* 质感阴影颜色 */
}

/* 全局底部横条 */
#home-indicator-bar {
    position: absolute;
    bottom: 8px;
    left: 50%;
    transform: translateX(-50%);
    width: 134px;
    height: 5px;
    background-color: #000000; /* 核心修改：颜色改回纯黑色 */
    border-radius: 100px;
    z-index: 1000;
    cursor: pointer;
    transition: background-color 0.2s;
}
#home-indicator-bar:active {
    background-color: #333333; /* 核心修改：点击时变为深灰色 */
}


.settings-new-icon {
    background-image: url('https://files.catbox.moe/123mel.png');
}

.new-settings-page {
    background-color: var(--ios-bg-page); /* 使用新的页面背景色 */
    display: flex;
    flex-direction: column;
}

.new-settings-content {
    flex-grow: 1;
    overflow-y: auto;
}
/* --- 核心修改：增加顶部留白 --- */
/* 【灵动岛适配】再次增加顶部内边距，让“设置”大标题完全避开遮挡 */
.header-simple.with-large-padding {
    padding: 60px 20px 10px 20px; 
}

.header-simple h1 {
    font-size: 40px; /* 字号从 34px 增加到 36px，让标题变大 */
    font-weight: 700;
    margin: 0;
    color: var(--ios-text-primary);
}

.header-simple h1 {
    font-size: 34px;
    font-weight: 700;
    margin: 0;
    color: var(--ios-text-primary);
}

/* --- 核心修改：增加ins质感阴影 --- */
.settings-group {
    background-color: var(--ios-bg-white);
    border-radius: 15px;
    margin: 12px 15px 0 15px;
    overflow: hidden;
    box-shadow: 0 4px 15px var(--shadow-color);
    border: 1px solid var(--ios-separator);
}

.settings-item {
    display: flex;
    align-items: center;
    padding: 12px 15px;
    cursor: pointer;
    transition: background-color 0.2s;
    background-color: var(--ios-bg-white);
    border-bottom: 1px solid var(--ios-separator); /* 使用新的分割线颜色 */
    min-height: 48px; /* 稍微增加行高 */
}
.settings-group .settings-item:last-child {
    border-bottom: none;
}
.settings-item:active {
    background-color: #F0F0F0;
}

/* --- 核心修改：重绘图标颜色 --- */
.settings-item .nav-item-icon-wrapper {
    width: 30px; /* 定义图标背景的宽度 */
    height: 30px; /* 定义图标背景的高度 */
    border-radius: 7px; /* 定义圆角大小，让它看起来更柔和 */
    margin-right: 15px; /* 与右侧文字的间距 */
    display: flex; /* 使用flex布局来居中内部的图标 */
    align-items: center; /* 垂直居中 */
    justify-content: center; /* 水平居中 */
    flex-shrink: 0; /* 防止图标在某些情况下被压缩变形 */
    transition: transform 0.2s;
}
.settings-item:active .nav-item-icon-wrapper {
    transform: scale(0.95);
}
.user-profile-item { padding: 15px; }
.user-avatar-large {
    width: 64px; height: 64px; border-radius: 50%; object-fit: cover;
    margin-right: 15px; background-color: #eee;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1); /* 给头像也加上一点阴影 */
}
.user-info { display: flex; flex-direction: column; flex-grow: 1; }
.user-name { font-size: 22px; font-weight: 500; color: var(--ios-text-primary); }
.user-subtitle { font-size: 13px; color: var(--ios-text-secondary); margin-top: 2px; }
.nav-item-text {
    flex-grow: 1;
    font-size: 17px;
    color: var(--ios-text-primary);
}

.nav-item-arrow {
    font-size: 20px;
    color: var(--ios-text-secondary);
    opacity: 0.6;
}
.settings-group-header {
    font-size: 13px; color: var(--ios-text-secondary);
    text-transform: uppercase;
    padding: 0 20px; margin-top: 30px; margin-bottom: -10px;
}
.settings-group-footer {
    font-size: 13px; color: var(--ios-text-secondary);
    padding: 10px 20px 0 20px;
}

.settings-item.input-item {
    justify-content: space-between;
    cursor: default;
    padding-right: 10px;
}
.settings-item.input-item:active { background-color: var(--ios-bg-white); }
.input-label { flex-basis: 30%; font-size: 17px; color: var(--ios-text-primary); }

.settings-input, .settings-select {
    border: none; background: none; outline: none; text-align: right;
    font-size: 17px; color: var(--ios-text-secondary); width: 70%;
}
.settings-input-full {
     border: none; background: none; outline: none; font-size: 17px;
     color: var(--ios-text-primary); width: 100%;
     padding: 0;
}

.settings-select { -webkit-appearance: none; appearance: none; direction: rtl; }
.settings-input::placeholder, .settings-input-full::placeholder { color: var(--ios-placeholder-text); }
.input-icon-btn {
    border: none; background: none; padding: 0 5px; cursor: pointer; color: var(--ios-text-secondary);
}

.settings-item.button-item { justify-content: center; }
.button-text-centered { color: var(--ios-blue-fresh); font-size: 17px; }

/* --- 核心修改：美化按钮质感 --- */
.ios-style-btn {
    width: 100%; padding: 14px; border-radius: 12px; border: none;
    font-size: 17px; font-weight: 600; /* 字体加粗更有力 */
    cursor: pointer; margin-top: 10px;
    transition: all 0.2s ease;
}
.ios-style-btn.primary-btn {
    background-color: var(--ios-blue-fresh);
    color: white;
    box-shadow: 0 4px 12px rgba(74, 137, 242, 0.3); /* 按钮阴影 */
}
.ios-style-btn.secondary-btn {
    background-color: #EFEFF4;
    color: var(--ios-blue-fresh);
}
.ios-style-btn:active {
    transform: scale(0.98); /* 点击按压效果 */
    opacity: 0.8;
    box-shadow: 0 2px 6px rgba(74, 137, 242, 0.2);
}
/* 图标设置页新样式 (V2.0 重制版) */
#new-icon-settings-container .settings-group { margin-top: 20px; }
.new-icon-setting-item { display: flex; align-items: center; gap: 15px; }
.new-icon-preview { width: 32px; height: 32px; border-radius: 8px; background-size: cover; background-position: center; flex-shrink: 0; }
.new-icon-name { flex-grow: 1; font-size: 17px; color: var(--ios-text-primary); }
.new-icon-buttons { display: flex; gap: 8px; }
.new-icon-btn {
    font-size: 15px; padding: 5px 15px; border-radius: 15px;
    border: none; cursor: pointer;
    background-color: #EFEFF4; color: var(--ios-blue-fresh);
    font-weight: 500;
}
.new-icon-btn.secondary { background-color: #e0e0e0; color: #555; }
.new-icon-btn:active { background-color: #D1D1D6; }
/* 用户资料编辑页 */
.profile-edit-area { text-align: center; padding: 30px 0; }
.avatar-edit-container { display: flex; flex-direction: column; align-items: center; gap: 15px; }
.user-avatar-xlarge {
    width: 90px; height: 90px; border-radius: 50%; object-fit: cover;
    box-shadow: 0 4px 15px rgba(0,0,0,0.12);
}
.avatar-edit-btn {
    border: none; background: none; color: var(--ios-blue-fresh); font-size: 16px;
    cursor: pointer;
}

/* 设置页搜索框样式 */
.settings-search-container {
    padding: 0 15px;
}
.settings-search-bar {
    display: flex;
    align-items: center;
    background-color: #E9E9EB; /* 苹果搜索框的标准灰色 */
    border-radius: 10px;
    padding: 8px 10px;
}
.settings-search-icon {
    width: 16px;
    height: 16px;
    color: #8A8A8E;
    margin-right: 8px;
    flex-shrink: 0;
}
.settings-search-input {
    width: 100%;
    border: none;
    background: none;
    outline: none;
    font-size: 17px;
    color: var(--ios-text-primary);
}
.settings-search-input::placeholder {
    color: #8A8A8E;
}
/* ▲▲▲ 全新纯iOS风格设置页面 v3.1 (ins质感美化版) 结束 ▲▲▲ */
    </style>    
    <script>
// === 样式预加载脚本 (解决闪烁问题的核心) ===
(async function applyInitialStyles() {
    // 提前定义数据库，以便访问
    const db = new Dexie('MyPhoneDatabase');
    db.version(3).stores({
        chats: 'id',
        worldBooks: 'id',
        settings: 'key',
        dynamics: '++id, authorId, timestamp'
    });

    try {
        // ✨ 并行获取所有外观设置，包括新的锁屏壁纸！
        const [wallpaper, lockscreenWallpaper, font, icons] = await Promise.all([
            db.settings.get('wallpaper'),
            db.settings.get('lockscreenWallpaper'), // 新增！
            db.settings.get('fontUrl'),
            db.settings.get('customIcons')
        ]);

        let cssRules = '';

        // 1. 生成字体规则
        if (font && font.value) {
            cssRules += `@font-face { font-family: 'CustomFont'; src: url('${font.value}'); }\n`;
        }

        // 2. 生成主屏幕壁纸规则
        if (wallpaper && wallpaper.value) {
            cssRules += `#home-screen { background-image: url("${wallpaper.value}") !important; }\n`;
        }
        
        // 3. ✨ 生成锁屏壁纸规则
        if (lockscreenWallpaper && lockscreenWallpaper.value) {
            cssRules += `#lock-screen { background-image: url("${lockscreenWallpaper.value}") !important; }\n`;
        }

        // 4. 生成所有自定义图标的规则
        if (icons && icons.value) {
            for (const [appId, url] of Object.entries(icons.value)) {
                if (url) {
                   // ✨【BUG修复】用更强大的方式指定所有图标，确保桌面、Dock栏、设置图标都能被正确替换！
cssRules += `.app-icon[data-appid="${appId}"] { background-image: url("${url}") !important; background-color: transparent !important; }\n`;
                }
            }
        }

        // 如果生成了任何规则，就创建一个style标签并插入到head中
        if (cssRules) {
            const style = document.createElement('style');
            style.id = 'preloaded-styles';
            style.textContent = cssRules;
            document.head.appendChild(style);
        }
    } catch (error) {
        console.error('预加载样式失败:', error);
    }
})();
    </script>
</head>
<body>
<div class="top-area-container">
<div id="status-bar">
            <span id="status-time">12:00</span>
            <div id="status-battery">
                <span id="battery-text">--%</span>
                <div id="battery-icon"><div id="battery-icon-level"></div></div>
            </div>
        </div>
        <div id="dynamic-island"></div>
        </div>
      <!-- 为小组件准备的隐藏文件上传按钮 -->
<input type="file" id="widget-top-input" accept="image/*" style="display: none;">
<input type="file" id="widget-middle-input" accept="image/*" style="display: none;">
<input type="file" id="widget-bottom-input" accept="image/*" style="display: none;">
<!-- 【新增代码】这是我们忘记添加的壁纸和锁屏壁纸上传框 -->
<input type="file" id="wallpaper-input" accept="image/*" style="display: none;">
<input type="file" id="lockscreen-wallpaper-input" accept="image/*" style="display: none;">
<!-- Coder: 月月! 这是你的专属锁屏哦 -->
<div id="lock-screen">
    <div id="lock-screen-date"></div> <!-- 这里会用魔法显示日期 -->
    <div id="lock-screen-time"></div> <!-- 这里会用魔法显示时间 -->
    <div id="lock-screen-prompt">向上滑动来解锁</div>
</div>
<!-- ▼▼▼ 密码输入界面开始 ▼▼▼ -->
<div id="passcode-screen" style="display: none;">
    <!-- 这个div只用来实现模糊背景效果 -->
    <div class="passcode-background-blur"></div>

    <!-- 这是密码界面的所有内容 -->
    <div class="passcode-content">
        <!-- “输入密码” 或 “请重试” 的提示文字 -->
        <p id="passcode-prompt">输入密码</p>

        <!-- 显示密码输入的圆点 -->
        <div id="passcode-dots">
            <span class="dot"></span>
            <span class="dot"></span>
            <span class="dot"></span>
            <span class="dot"></span>
        </div>

        <!-- 数字键盘 -->
        <div class="passcode-numpad">
            <button class="passcode-key" data-key="1">
    <span class="key-number">1</span>
    <span id="passcode-kaomoji" class="key-kaomoji"></span>
</button>
            <button class="passcode-key" data-key="2"><span class="key-number">2</span><span class="key-letters">A B C</span></button>
            <button class="passcode-key" data-key="3"><span class="key-number">3</span><span class="key-letters">D E F</span></button>
            <button class="passcode-key" data-key="4"><span class="key-number">4</span><span class="key-letters">G H I</span></button>
            <button class="passcode-key" data-key="5"><span class="key-number">5</span><span class="key-letters">J K L</span></button>
            <button class="passcode-key" data-key="6"><span class="key-number">6</span><span class="key-letters">M N O</span></button>
            <button class="passcode-key" data-key="7"><span class="key-number">7</span><span class="key-letters">P Q R S</span></button>
            <button class="passcode-key" data-key="8"><span class="key-number">8</span><span class="key-letters">T U V</span></button>
            <button class="passcode-key" data-key="9"><span class="key-number">9</span><span class="key-letters">W X Y Z</span></button>
            <div></div> <!-- 占位符，让0居中 -->
            <button class="passcode-key" data-key="0"><span class="key-number">0</span></button>
            <div></div> <!-- 占位符 -->
        </div>

        <!-- 取消按钮 -->
        <button id="passcode-cancel-btn">取消</button>
    </div>
</div>
<!-- ▲▲▲ 密码输入界面结束 ▲▲▲ -->
    <div id="phone-screen">
    <!-- ▼▼▼ 新增：长按操作菜单与多选工具栏 ▼▼▼ -->
<div id="message-action-sheet-backdrop" class="action-sheet-backdrop"></div>
<div id="message-action-sheet" class="action-sheet">
    <div class="action-sheet-group">
        <div class="action-sheet-item" id="action-edit">编辑</div>
        <div class="action-sheet-item" id="action-multi-select">多选</div>
        <div class="action-sheet-item delete" id="action-delete">删除</div>
    </div>
    <div class="action-sheet-cancel" id="action-cancel">取消</div>
</div>
<div id="multi-select-bar">
    <button id="multi-select-delete-btn">
        <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18m-2 0v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2m-6 5v6m4-6v6"/></svg>
    </button>
</div>
<!-- ▲▲▲ HTML新增结束 ▲▲▲ -->
        
        <!-- 主屏幕 -->
        <!-- 主屏幕 (全新Pro Max Plus版！) -->
<div id="home-screen" class="screen">
    <div class="desktop-layout">
        <div id="widget-top" class="widget widget-rect" onclick="document.getElementById('widget-top-input').click()"></div>

        <div class="app-cluster">
            <div class="app-icon-wrapper" onclick="showScreen('worldbook-screen'); renderWorldBookList();"><div class="app-icon worldbook-icon" data-appid="worldbook"></div><p>世界书</p></div>
            <div class="app-icon-wrapper" onclick="showScreen('forum-screen')"><div class="app-icon weibo-icon" data-appid="weibo"></div><p>微博</p></div>
            <div class="app-icon-wrapper" onclick="showScreen('offline-story-screen');"><div class="app-icon offline-story-icon" data-appid="offline-story"></div><p>线下剧情</p></div>
            <div class="app-icon-wrapper" onclick="showScreen('gobang-screen'); initGobangGame();"><div class="app-icon gobang-icon" data-appid="gobang"></div><p>五子棋</p></div>
        </div>

        <div id="widget-middle" class="widget widget-square" onclick="document.getElementById('widget-middle-input').click()"></div>

        <div id="widget-bottom" class="widget widget-square" onclick="document.getElementById('widget-bottom-input').click()"></div>

        <div class="app-cluster">
            <div class="app-icon-wrapper" onclick="showScreen('new-main-settings-screen'); renderNewSettingsPage();"><div class="app-icon settings-new-icon" data-appid="settings-new"></div><p>设置</p></div>
                        <div class="app-icon-wrapper" onclick="showScreen('messages-screen')">
                <div class="app-icon" data-appid="messages" style="background-image: url('https://files.catbox.moe/dkp5ld.png');"></div>
                <p>信息</p>
            </div>
            <div class="app-icon-wrapper" onclick="showScreen('wechat-screen')">
                <div class="app-icon" data-appid="wechat" style="background-image: url('https://files.catbox.moe/ili3j6.png');"></div>
                <p>微信</p>
            </div>
            <!-- 【新增代码】这是你的新音乐App -->
<div class="app-icon-wrapper" onclick="showScreen('music-screen')">
    <div class="app-icon" data-appid="music" style="background-image: url('https://files.catbox.moe/i4yx0e.jpg');"></div>
    <p>音乐</p>
</div>
            <!-- 这里可以再放一个应用 -->
        </div>
    </div>

    <!-- 页面指示器 (小圆点) - 我们把它隐藏起来 -->
    <div id="page-indicator" style="display: none;">
        <span class="dot active"></span>
        <span class="dot"></span>
    </div>

    <!-- 底部Dock栏 -->
    <div class="dock">
        <div class="app-icon-wrapper" onclick="showScreen('chat-list-screen')"><div class="app-icon qq-icon" data-appid="qq"></div><p>QQ</p></div>
    </div>
</div>
        <!-- QQ 应用 -->
        <div id="chat-list-screen" class="screen">
            <div class="header">
                <!-- 视图1: 个人信息 (消息页) -->
                <div id="qq-header-profile-view" class="qq-header-content active">
                    <img id="qq-header-avatar-profile" src="" alt="User Avatar" onclick="showScreen('home-screen')">
                    <div>
                        <span id="qq-header-username"></span>
                        <div class="qq-header-status">
                            <span class="status-dot"></span>
                            <span>手机在线 ›</span>
                        </div>
                    </div>
                </div>
                <!-- 视图2: 页面标题 (联系人/动态等) -->
                <div id="qq-header-title-view" class="qq-header-content">
                    <img id="qq-header-avatar-title" src="" alt="User Avatar" onclick="showScreen('home-screen')">
                    <span id="qq-header-page-title"></span>
                </div>
                <!-- 视图3: 动态页专属标题 -->
                <div id="qq-header-dynamic-view" class="qq-header-content">
                    <span id="qq-header-dynamic-title">动态</span>
                </div>
                <!-- 右侧图标容器 -->
                <div id="qq-header-right-icon" class="header-side right">
                    <button class="header-icon-btn" onclick="promptAddFriend()">+</button>
                </div>
            </div>
            <div class="qq-content-area">
                <!-- ▼▼▼ HTML修改：消息页面添加搜索框 ▼▼▼ -->
                <div id="qq-page-messages" class="qq-page active">
                    <div class="contact-functions">
                        <div class="contact-search-bar">
                            <svg viewBox="0 0 1024 1024" width="16" height="16"><path d="M941.44 855.04L743.04 656.64c48.64-56.96 78.08-129.92 78.08-209.28 0-186.88-152.32-339.2-339.2-339.2S142.72 260.48 142.72 447.36s152.32 339.2 339.2 339.2c79.36 0 152.32-29.44 209.28-78.08l198.4 198.4c17.28 17.28 45.44 17.28 62.72 0s17.28-45.44 0-62.72z m-559.04-188.8c-122.88 0-222.08-99.2-222.08-222.08s99.2-222.08 222.08-222.08 222.08 99.2 222.08 222.08-99.2 222.08-222.08 222.08z" fill="#8A8A8E"></path></svg>
                            <input type="search" id="message-search-input" placeholder="搜索">
                        </div>
                    </div>
                    <div id="chat-list-container"></div>
                </div>
                <!-- ▲▲▲ 修改结束 ▲▲▲ -->
                <!-- 【新增代码】这是频道的专属空白页面 -->
<div id="qq-page-channel" class="qq-page">
    <p class="placeholder-text">频道功能开发中...</p>
</div>
                <div id="qq-page-contacts" class="qq-page">
                    <div class="contact-functions">
                                                <div class="contact-search-bar">
                            <!-- ✨ 全新的ins风SVG小放大镜！ ✨ -->
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                            <input type="search" id="message-search-input" placeholder="搜索">
                        </div>
                    </div>
                    <div class="contact-options">
                        <div class="contact-option-item">新朋友<span>›</span></div>
                        <div class="contact-option-item">群通知<span>›</span></div>
                    </div>
                    <div id="contacts-list-container"></div>
                </div>
<!-- 这是【新的】HTML结构 -->
<div id="qq-page-dynamics" class="qq-page">
    <!-- ▼▼▼ 我们新增的大包裹 ▼▼▼ -->
    <div id="dynamics-scroll-wrapper"> 
        <!-- 下面这些东西都被搬进来了 -->
        <div class="dynamics-header-profile">
            <img id="dynamics-user-avatar" src="" alt="User Avatar">
            <span id="dynamics-user-name"></span>
        </div>
        <div class="dynamics-actions">
        <div class="action-item">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><path d="m21 15-5-5L5 21"></path></svg>
    <span>相册</span>
</div>
<div class="action-item">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
    <span>说说</span>
</div>
<div class="action-item">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle></svg>
    <span>更多</span>
</div>    
        </div>
        <div class="dynamics-write-post-bar" onclick="openWriteDynamicScreen()">
            <button>写说说</button>
        </div>
        <div id="dynamics-list-container">
            <!-- 动态列表将在这里生成 -->
        </div>
    </div> 
    <!-- ▲▲▲ 大包裹在这里结束 ▲▲▲ -->

    <!-- 蓝色加号按钮被留在了外面，这样它就不会滚走 -->
    <button id="fab-write-dynamic" onclick="openWriteDynamicScreen()">+</button>
</div>
                <div id="qq-page-me" class="qq-page"><p class="placeholder-text">这里是“我”的页面，待开发... 喵~</p></div>
            </div>
           <!-- ▼▼▼ 【V2.1-频道页面版】底部导航栏 ▼▼▼ -->
<div class="qq-tab-bar">
    <div class="qq-tab-item active" onclick="switchQqTab('messages', this)">
        <div class="qq-tab-icon">
            <!-- 消息(未选中) -->
            <svg class="icon-outline" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
            <!-- 消息(选中) -->
            <svg class="icon-filled" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
        </div>
        <span class="qq-tab-text">消息</span>
    </div>
    <div class="qq-tab-item" onclick="switchQqTab('channel', this)">
        <div class="qq-tab-icon">
            <!-- 频道(未选中) -->
            <svg class="icon-outline" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line></svg>
            <!-- 频道(选中) -->
            <svg class="icon-filled" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line></svg>
        </div>
        <span class="qq-tab-text">频道</span>
    </div>
    <div class="qq-tab-item" onclick="switchQqTab('contacts', this)">
        <div class="qq-tab-icon">
            <!-- 联系人(未选中) -->
            <svg class="icon-outline" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
            <!-- 联系人(选中) -->
            <svg class="icon-filled" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
        </div>
        <span class="qq-tab-text">联系人</span>
    </div>
    <div class="qq-tab-item" onclick="switchQqTab('dynamics', this)">
        <div class="qq-tab-icon">
            <!-- 动态(未选中) -->
            <svg class="icon-outline" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
            <!-- 动态(选中) -->
            <svg class="icon-filled" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
        </div>
        <span class="qq-tab-text">动态</span>
    </div>
</div>
<!-- ▲▲▲ 改造完成 ▲▲▲ -->
        </div>

        
        <!-- 聊天界面 -->
                <!-- ▼▼▼ 多选模式专属工具栏 (开始) ▼▼▼ -->
        <div id="multi-select-header" class="header">
            <button id="multi-select-cancel-btn" class="panel-header-btn cancel-btn">取消</button>
            <div id="multi-select-title" class="header-title"></div>
            <div class="header-side right"></div>
        </div>

        <div id="multi-select-bar">
            <div class="multi-select-actions">
                <button id="multi-select-share-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path><polyline points="16 6 12 2 8 6"></polyline><line x1="12" y1="2" x2="12" y2="15"></line></svg>
                </button>
                <button id="multi-select-favorite-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
                </button>
            </div>
            <button id="multi-select-delete-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18m-2 0v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2m-6 5v6m4-6v6"/></svg>
            </button>
        </div>
        <!-- ▲▲▲ 多选模式专属工具栏 (结束) ▲▲▲ -->
        <div id="chat-screen" class="screen">
            <div class="header">
                <button class="back-btn" onclick="showScreen('chat-list-screen'); renderChatList();">‹</button>
                <div id="chat-header-title" class="header-title">和AI聊天</div>
                <div class="header-side right header-actions">
                 <!-- 这是你要粘贴进去的新代码 -->
<button class="header-icon-btn" onclick="openChatAppearance()">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
</button>
<button class="header-icon-btn" onclick="openChatSettings()">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12,15.5 A3.5,3.5 0 0,1 8.5,12 A3.5,3.5 0 0,1 12,8.5 A3.5,3.5 0 0,1 15.5,12 A3.5,3.5 0 0,1 12,15.5 M19.43,12.97 C19.47,12.65 19.5,12.33 19.5,12 C19.5,11.67 19.47,11.34 19.43,11 L21.54,9.37 C21.73,9.22 21.78,8.95 21.66,8.73 L19.66,5.27 C19.54,5.05 19.27,4.96 19.05,5.05 L16.56,6.05 C16.04,5.66 15.5,5.32 14.87,5.07 L14.5,2.42 C14.46,2.18 14.25,2 14,2 L10,2 C9.75,2 9.54,2.18 9.5,2.42 L9.13,5.07 C8.5,5.32 7.96,5.66 7.44,6.05 L4.95,5.05 C4.73,4.96 4.46,5.05 4.34,5.27 L2.34,8.73 C2.21,8.95 2.27,9.22 2.46,9.37 L4.57,11 C4.53,11.34 4.5,11.67 4.5,12 C4.5,12.33 4.53,12.65 4.57,12.97 L2.46,14.63 C2.27,14.78 2.21,15.05 2.34,15.27 L4.34,18.73 C4.46,18.95 4.73,19.03 4.95,18.95 L7.44,17.94 C7.96,18.34 8.5,18.68 9.13,18.93 L9.5,21.58 C9.54,21.82 9.75,22 10,22 L14,22 C14.25,22 14.46,21.82 14.5,21.58 L14.87,18.93 C15.5,18.68 16.04,18.34 16.56,17.94 L19.05,18.95 C19.27,19.03 19.54,18.95 19.66,18.73 L21.66,15.27 C21.78,15.05 21.73,14.78 21.54,14.63 L19.43,12.97 Z" /></svg>
</button>   
<!-- ▼▼▼ 月月看这里！这就是我们新加的按钮哦！▼▼▼ -->
<button class="header-icon-btn" onclick="alert('菜单按钮被点击啦！')">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
</button>
<!-- ▲▲▲ 新按钮加好啦！▲▲▲ -->  
                </div>
            </div>
            <div class="chat-messages"></div>
                      <div class="chat-input-area">
                <button id="receive-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3v2m5.66 1.34-1.42 1.42M19 12h-2m1.66 5.66-1.42-1.42M12 19v2m-5.66-1.34 1.42-1.42M5 12H3m1.66-5.66 1.42 1.42"/></svg>
                </button>
                <textarea id="chat-input" rows="1" placeholder="输入消息..."></textarea>
                <button class="chat-ui-btn" id="emoji-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M8 14s1.5 2 4 2 4-2 4-2"></path><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line></svg>
                </button>
                <div id="action-btn-container">
                    <button class="chat-ui-btn" id="plus-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    </button>
                    <button id="send-btn">发送</button>
                </div>
            </div>
        </div>

       <!-- ▼▼▼ 【Pro Max多图版】写说说页面 ▼▼▼ -->
<div id="write-dynamic-screen" class="screen">
    <div class="header">
        <button class="back-btn" onclick="closeWriteDynamicScreen()">取消</button>
        <div class="header-title">写说说</div>
        <div class="header-side right">
            <button id="publish-dynamic-btn" class="publish-btn" onclick="publishDynamic()">发表</button>
        </div>
    </div>
    <div class="write-dynamic-container">
        <!-- 上半部分：内容卡片 -->
        <div class="write-dynamic-content-card">
            <textarea id="dynamic-textarea" placeholder="分享新鲜事…"></textarea>
            
            <!-- 【地基重铸】这是全新的、为九宫格准备的媒体容器 -->
            <div id="dynamic-media-grid-container">
                <!-- 图片预览和上传按钮将由JS动态生成在这里 -->
            </div>
            <!-- 【核心】为文件上传框添加 multiple 属性，允许它多选 -->
            <input type="file" id="dynamic-image-upload" accept="image/*" style="display: none;" multiple>

            <div class="dynamic-inline-toolbar">
                <div class="left-tools">
                    <button class="toolbar-btn-inline" onclick="openMentionPanel()">
                       <span>@ 好友</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- 下半部分：设置卡片 -->
        <div class="dynamic-settings-card">
            <div class="dynamic-setting-item">
                <div class="setting-item-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                </div>
                <span>权限设置</span>
                <div class="setting-item-value">所有人可见 <span class="arrow">›</span></div>
            </div>
            <div class="dynamic-setting-item">
                <div class="setting-item-icon">
                     <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                </div>
                <span>定时</span>
                <div class="setting-item-value">立即发表 <span class="arrow">›</span></div>
            </div>
        </div>
    </div>
</div>
<!-- ▲▲▲ Pro Max版改造完成 ▲▲▲ -->
<!-- ▲▲▲ 改造完成 ▲▲▲ -->
        <!-- (其他 screen 的 HTML 代码保持不变) -->
        <!-- API设置 -->
        <div id="settings-screen" class="screen">
            <div class="header"><button class="back-btn" onclick="showScreen('home-screen')">‹</button><div class="header-title">API 设置</div><div class="header-side right"></div></div>
            <div class="settings-form">
                <div class="settings-card">
                    <h3>连接AI的核心</h3>
                    <label for="api-url">反代/官方地址: <span class="label-hint">(不需要加“/v1”喔)</span></label>
                    <input type="text" id="api-url" placeholder="例如: https://api.openai.com">
                    <label for="api-key">密钥 (API Key):</label>
                    <input type="password" id="api-key" placeholder="sk-...">
                    <label for="model-select">模型:</label>
                    <select id="model-select"></select>
                    <button class="secondary-btn" onclick="fetchModels()">拉取模型</button>
                    <button class="primary-btn" onclick="saveApiSettings()">保存设置</button>
                </div>
                 <div class="settings-card">
                    <h3>数据管理</h3>
                    <p class="card-description">导出您的所有聊天记录和设置为一个文件，或从文件中恢复。</p>
                    <button class="secondary-btn" onclick="exportData()">导出数据</button>
                    <button class="secondary-btn" onclick="document.getElementById('import-input').click()">导入数据</button>
                    <input type="file" id="import-input" accept=".json" style="display: none;" onchange="importData(event)">
                </div>
            </div>
        </div>

        <!-- 世界书 -->
        <div id="worldbook-screen" class="screen">
            <div class="header"><button class="back-btn" onclick="showScreen('home-screen')">‹</button><div class="header-title">世界书
            </div>
            <div class="header-side right"></div></div>
            <div id="worldbook-list-container" class="worldbook-list-container"></div>
            <button class="add-new-btn" onclick="openWorldBookEditor(null)">+ 添加新的设定</button>
        </div>
        <div id="worldbook-editor-screen" class="screen">
            <div class="header"><button class="back-btn" onclick="handleWorldBookBack()">‹</button><div id="worldbook-editor-title" class="header-title">编辑世界书</div><div class="header-side right"></div></div>
            <div class="settings-form">
                <label for="worldbook-title-input">设定名称:</label><input type="text" id="worldbook-title-input" placeholder="给你的设定集起个名字吧">
                <!-- ▼▼▼ CEO专属 · 自定义下拉菜单 v6.1 ▼▼▼ -->
<label for="worldbook-group-select">选择分组:</label>
<div class="custom-select-wrapper">
    <select id="worldbook-group-select" style="display: none;"></select>
    <div class="select-selected"></div>
    <div class="select-items select-hide"></div>
</div>
<!-- ▲▲▲ 结构改造完成 ▲▲▲ -->
                <div id="new-group-container" style="display: none;">
                    <label for="worldbook-new-group-input">新分组名:</label>
                    <input type="text" id="worldbook-new-group-input" placeholder="输入新的分组名称">
                </div>
                <label for="worldbook-content-input">内容:</label><textarea id="worldbook-content-input" rows="10" placeholder="在这里写下世界观、角色设定、背景故事..."></textarea>
            </div>
           <button class="add-new-btn" onclick="saveWorldBook()">保存</button>
        </div>

        <!-- 论坛 -->
        <div id="forum-screen" class="screen">
            <div class="header"><button class="back-btn" onclick="showScreen('home-screen')">‹</button><div class="header-title">论坛</div><div class="header-side right"></div></div>
            <p class="placeholder-text">开发中...</p>
        </div>
        <!-- 信息 -->
<div id="messages-screen" class="screen">
    <div class="header"><button class="back-btn" onclick="showScreen('home-screen')">‹</button><div class="header-title">信息</div><div class="header-side right"></div></div>
    <p class="placeholder-text">信息 App 开发中...</p>
</div>

<!-- 微信 -->
<div id="wechat-screen" class="screen">
    <div class="header"><button class="back-btn" onclick="showScreen('home-screen')">‹</button><div class="header-title">微信</div><div class="header-side right"></div></div>
    <p class="placeholder-text">微信 App 开发中...</p>
</div>
<!-- 【新增代码】音乐App的页面 -->
<div id="music-screen" class="screen">
    <div class="header"><button class="back-btn" onclick="showScreen('home-screen')">‹</button><div class="header-title">音乐</div><div class="header-side right"></div></div>
    <p class="placeholder-text">音乐 App 开发中...</p>
</div>
            </div>
        </div>
                <!-- ▼▼▼ 新增：“@”好友选择面板 ▼▼▼ -->
        <!-- 【户型改造】为@好友面板换上标准的iOS风格顶部和搜索框 -->
<div id="mention-friends-panel" class="settings-panel">
    <div class="panel-header">
        <button class="panel-header-btn cancel-btn" onclick="closeMentionPanel()">取消</button>
        <span class="panel-title">选择联系人</span>
        <button class="panel-header-btn save-btn" onclick="confirmMentionSelection()">完成</button>
    </div>
    <!-- 这是和设置页同款的搜索框结构 -->
    <div class="settings-search-container">
        <div class="settings-search-bar">
            <svg class="settings-search-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
            <input type="search" id="mention-search-input" class="settings-search-input" placeholder="搜索">
        </div>
    </div>
            <div id="mention-list-container" class="panel-content" style="padding: 0;">
                <!-- 好友列表会在这里生成 -->
            </div>
        </div>
        <!-- ▲▲▲ 新增结束 ▲▲▲ -->
        <!-- ▼▼▼ 五子棋好友选择界面开始 ▼▼▼ -->
<div id="gobang-friend-select-screen" class="screen">
    <div class="header">
        <button class="back-btn" onclick="showScreen('home-screen')">‹</button>
        <div class="header-title">选择对手</div>
        <div class="header-side right"></div>
    </div>
    <div id="gobang-friend-list">
        <!-- 好友列表将由JavaScript动态生成在这里 -->
    </div>
</div>
<!-- ▲▲▲ 五子棋好友选择界面结束 ▲▲▲ -->
        <!-- ▼▼▼ 五子棋游戏页面开始 ▼▼▼ -->
<div id="gobang-screen" class="screen">
    <div class="header">
        <button class="back-btn" onclick="showScreen('home-screen')">‹</button>
        <div class="header-title">五子棋</div>
        <div class="header-side right"></div>
    </div>
    <div id="gobang-game-container">
        <!-- 对手信息 -->
<div class="gobang-player-info" id="gobang-opponent-info">
    <!-- ▼▼▼ 新增：消息气泡的容器 ▼▼▼ -->
    <div class="gobang-message-toast-container"></div>
    <!-- ▲▲▲ 新增结束 ▲▲▲ -->
    <div class="gobang-avatar-wrapper">
        <div class="gobang-timer-ring">
            <svg width="64" height="64" viewBox="0 0 64 64">
                <circle class="timer-bg" r="30" cx="32" cy="32"></circle>
                <circle class="timer-progress" id="gobang-opponent-timer" r="30" cx="32" cy="32"></circle>
            </svg>
        </div>
        <img src="https://files.catbox.moe/eui00n.png" class="gobang-avatar" alt="Opponent Avatar" onclick="patAvatar('opponent')">
    </div>
    <span class="gobang-player-name">月月Bot</span>
</div>

<!-- 棋盘区域 -->

        <!-- 棋盘区域 -->
        <div id="gobang-board-wrapper">
            <svg id="gobang-board-svg" viewBox="0 0 600 600" preserveAspectRatio="xMidYMid meet"></svg>
            <div id="gobang-game-overlay">
                <div id="gobang-overlay-content">
                    <p id="gobang-game-status">准备好了吗？</p>
                    <button id="gobang-start-btn" class="gobang-btn primary">开始游戏</button>
                </div>
            </div>
        </div>

        <!-- 你的信息 -->
<div class="gobang-player-info self" id="gobang-self-info">
    <!-- ▼▼▼ 新增：消息气泡的容器 ▼▼▼ -->
    <div class="gobang-message-toast-container"></div>
    <!-- ▲▲▲ 新增结束 ▲▲▲ -->
    <div class="gobang-avatar-wrapper">
        <div class="gobang-timer-ring">
            <svg width="64" height="64" viewBox="0 0 64 64">
                <circle class="timer-bg" r="30" cx="32" cy="32"></circle>
                <circle class="timer-progress" id="gobang-self-timer" r="30" cx="32" cy="32"></circle>
            </svg>
        </div>
        <img src="" class="gobang-avatar" id="gobang-user-avatar" alt="User Avatar" onclick="patAvatar('self')">
    </div>
    <span class="gobang-player-name" id="gobang-user-name-display">你</span>
</div>
        <!-- 控制按钮 -->
        <div id="gobang-controls">
            <button id="gobang-undo-btn" class="gobang-btn secondary" disabled>悔棋</button>
            <button id="gobang-new-game-btn" class="gobang-btn secondary">新对局</button>
        </div>

        <!-- 聊天互动区 -->
        <div id="gobang-chat-wrapper">
            <div id="gobang-chat-history">
                <!-- 聊天消息会显示在这里 -->
            </div>
            <div class="gobang-chat-input-area">
                <input type="text" id="gobang-chat-input" placeholder="和TA说点什么...">
                <button id="gobang-send-chat-btn">
                    <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
                </button>
            </div>
        </div>
    </div>
</div>
<!-- ▲▲▲ 五子棋游戏页面结束 ▲▲▲ -->
        <!-- ▼▼▼ 线下剧情 App 开始 ▼▼▼ -->
        <div id="offline-story-screen" class="screen">
            <div class="header">
                <button class="back-btn" onclick="showScreen('home-screen')">‹</button>
                <div class="header-title">线下剧情</div>
                <div class="header-side right"></div>
            </div>
            <p class="placeholder-text">这里是存放你们回忆的地方...</p>
        </div>
        <!-- ▲▲▲ 线下剧情 App 结束 ▲▲▲ -->
        
        <!-- ▼▼▼ 全新纯iOS风格设置页面 v3.2 (最终精修版) 开始 ▼▼▼ -->
<div id="new-main-settings-screen" class="screen new-settings-page">
    <div class="new-settings-content">
        <div class="header-simple with-large-padding">
            <h1>设置</h1>
        </div>
        <!-- 搜索框 -->
<div class="settings-search-container">
    <div class="settings-search-bar">
        <svg class="settings-search-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
        <input type="search" id="settings-search-input" class="settings-search-input" placeholder="搜索">
    </div>
</div>
        <!-- 用户信息卡片 -->
        <div class="settings-group">
            <div class="settings-item user-profile-item" onclick="showScreen('new-user-profile-screen'); renderNewUserProfilePage();">
                <img id="new-settings-user-avatar" src="" class="user-avatar-large">
                <div class="user-info">
                    <span id="new-settings-user-name" class="user-name"></span>
                    <span class="user-subtitle">Apple ID, iCloud, 媒体与购买项目</span>
                </div>
                <span class="nav-item-arrow">›</span>
            </div>
        </div>
<!-- 功能列表 -->
<div class="settings-group">
    <div class="settings-item" onclick="showScreen('new-appearance-wallpaper-screen')">
        <div class="nav-item-icon-wrapper" style="background-color: #34C759;">
            <!-- V4 “壁纸” 图标 -->
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
        </div>
        <span class="nav-item-text">更换壁纸</span>
        <span class="nav-item-arrow">›</span>
    </div>
    <div class="settings-item" onclick="showScreen('new-appearance-lockscreen-screen')">
        <div class="nav-item-icon-wrapper" style="background-color: #5856D6;">
            <!-- V4 “锁屏壁纸” 图标 -->
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
        </div>
        <span class="nav-item-text">更换锁屏壁纸</span>
        <span class="nav-item-arrow">›</span>
    </div>
    <div class="settings-item" onclick="openLockScreenSettings()">
        <div class="nav-item-icon-wrapper" style="background-color: #8E8E93;">
            <!-- V4 “锁屏密码” 图标 -->
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
        </div>
        <span class="nav-item-text">锁屏密码</span>
        <span class="nav-item-arrow">›</span>
    </div>
    <div class="settings-item" onclick="showScreen('new-appearance-font-screen')">
        <div class="nav-item-icon-wrapper" style="background-color: #FF9500;">
            <!-- V4 “字体” 图标 -->
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="4 7 4 4 20 4 20 7"></polyline><line x1="9" y1="20" x2="15" y2="20"></line><line x1="12" y1="4" x2="12" y2="20"></line></svg>
        </div>
        <span class="nav-item-text">更换字体</span>
        <span class="nav-item-arrow">›</span>
    </div>
   <div class="settings-item" onclick="openIconSettings_v2()">
        <div class="nav-item-icon-wrapper" style="background-color: #00C7BE;">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h6v6h-6V3z"></path><path d="M9 3H3v6h6V3z"></path><path d="M21 15h-6v6h6v-6z"></path><path d="M9 15H3v6h6v-6z"></path></svg>
        </div>
        <span class="nav-item-text">更换图标</span>
        <span class="nav-item-arrow">›</span>
    </div>
</div>

<div class="settings-group">
    <div class="settings-item" onclick="showScreen('new-api-settings-screen')">
        <div class="nav-item-icon-wrapper" style="background-color: #007AFF;">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></svg>
        </div>
        <span class="nav-item-text">API 设置</span>
        <span class="nav-item-arrow">›</span>
    </div>
</div>
    </div>
</div>

<!-- 用户资料编辑页 -->
<div id="new-user-profile-screen" class="screen new-settings-page">
    <div class="new-settings-content">
        <div class="header-simple with-large-padding">
            <h1>个人资料</h1>
        </div>
        <div class="profile-edit-area">
            <div class="avatar-edit-container">
                <img id="new-profile-avatar-preview" src="" class="user-avatar-xlarge">
                <button class="avatar-edit-btn" onclick="document.getElementById('new-avatar-upload').click()">更换头像</button>
                <input type="file" id="new-avatar-upload" accept="image/*" style="display: none;">
            </div>
        </div>
        <p class="settings-group-header">用户ID</p>
        <div class="settings-group">
            <div class="settings-item input-item">
                <input type="text" id="new-profile-name-input" class="settings-input-full" placeholder="请输入你的ID">
            </div>
        </div>
        <div class="page-actions-container" style="padding: 20px 15px;">
            <button class="primary-btn ios-style-btn" onclick="saveNewUserProfile()">保存</button>
        </div>
    </div>
</div>
<!-- API设置页 -->
<div id="new-api-settings-screen" class="screen new-settings-page">
    <div class="new-settings-content">
        <div class="header-simple with-large-padding">
            <h1>API 设置</h1>
        </div>
        <p class="settings-group-footer">不需要添加“/v1”哦！</p>
        <div class="settings-group">
            <div class="settings-item input-item">
                <label class="input-label">地址</label>
                <input type="text" id="new-api-url" class="settings-input" placeholder="https://api.openai.com">
            </div>
            <div class="settings-item input-item">
                <label class="input-label">密钥</label>
                <input type="password" id="new-api-key" class="settings-input" placeholder="sk-...">
                <button class="input-icon-btn" onclick="toggleApiKeyVisibility()">
                    <svg class="api-key-eye-open" xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                    <svg class="api-key-eye-closed" style="display: none;" xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>
                </button>
            </div>
             <div class="settings-item input-item">
                <label class="input-label">模型</label>
                <select id="new-model-select" class="settings-select"></select>
            </div>
        </div>
        <div class="settings-group">
             <div class="settings-item button-item" onclick="fetchModels(true)">
                <span class="button-text-centered">拉取模型</span>
            </div>
        </div>
         <div class="page-actions-container" style="padding: 20px 15px;">
            <button class="primary-btn ios-style-btn" onclick="saveApiSettings(true)">保存设置</button>
        </div>
    </div>
</div>
    <!-- [新] 更换壁纸页 -->
<div id="new-appearance-wallpaper-screen" class="screen new-settings-page">
    <div class="new-settings-content">
        <div class="header-simple with-large-padding">
             <h1>更换壁纸</h1>
         </div>
         <div class="settings-group">
            <div class="settings-item button-item" onclick="document.getElementById('wallpaper-input').click()">
                <span class="button-text-centered">从相册选择</span>
            </div>
         </div>
         <p class="settings-group-header">或者</p>
         <div class="settings-group">
            <div class="settings-item input-item">
                <input type="text" id="wallpaper-url-input" class="settings-input-full" placeholder="粘贴图片的网络链接...">
            </div>
         </div>
         <div class="page-actions-container" style="padding: 20px 15px;">
            <button class="primary-btn ios-style-btn" onclick="setWallpaperFromUrl()">应用URL壁纸</button>
            <button class="secondary-btn ios-style-btn" onclick="restoreAppearanceDefaults('wallpaper')">恢复默认</button>
        </div>
    </div>
</div>
    
<!-- [新] 更换锁屏壁纸页 -->
<div id="new-appearance-lockscreen-screen" class="screen new-settings-page">
    <div class="new-settings-content">
        <div class="header-simple with-large-padding">
             <h1>更换锁屏壁纸</h1>
         </div>
         <div class="settings-group">
            <div class="settings-item button-item" onclick="document.getElementById('lockscreen-wallpaper-input').click()">
                <span class="button-text-centered">从相册选择</span>
            </div>
         </div>
         <p class="settings-group-header">或者</p>
         <div class="settings-group">
            <div class="settings-item input-item">
                <input type="text" id="lockscreen-wallpaper-url-input" class="settings-input-full" placeholder="粘贴图片的网络链接...">
            </div>
         </div>
         <div class="page-actions-container" style="padding: 20px 15px;">
            <button class="primary-btn ios-style-btn" onclick="setLockscreenWallpaperFromUrl()">应用URL壁纸</button>
            <button class="secondary-btn ios-style-btn" onclick="restoreAppearanceDefaults('lockscreenWallpaper')">恢复默认</button>
        </div>
    </div>
</div>

<!-- [新] 更换字体页 -->
<div id="new-appearance-font-screen" class="screen new-settings-page">
     <div class="new-settings-content">
        <div class="header-simple with-large-padding">
             <h1>更换字体</h1>
         </div>
         <p class="settings-group-footer">请将字体文件的链接粘贴到下方</p>
         <div class="settings-group">
            <div class="settings-item input-item">
                <input type="text" id="font-url-input" class="settings-input-full" placeholder="例如 .../font.ttf">
            </div>
         </div>
         <div class="page-actions-container" style="padding: 20px 15px;">
            <button class="primary-btn ios-style-btn" onclick="setFontFromUrl()">应用字体</button>
            <button class="secondary-btn ios-style-btn" onclick="restoreAppearanceDefaults('fontUrl')">恢复默认</button>
        </div>
    </div>
</div>
<!-- [新] 更换图标页 (V2.0 重制版) -->
<div id="new-appearance-icons-screen" class="screen new-settings-page">
    <div class="new-settings-content">
        <div class="header-simple with-large-padding">
             <h1>更换图标</h1>
         </div>
         <div id="new-icon-settings-container">
             <!-- 图标列表将由JS动态生成在这里 -->
         </div>
         <div class="page-actions-container" style="padding: 20px 15px;">
            <button class="primary-btn ios-style-btn" onclick="saveIconChanges_v2()">保存图标</button>
            <button class="secondary-btn ios-style-btn" onclick="restoreAppearanceDefaults('customIcons')">恢复默认图标</button>
        </div>
    </div>
</div>
<!-- ▲▲▲ 全新纯iOS风格设置页面 v3.2 (最终精修版) 结束 ▲▲▲ -->
        <!-- [新] 锁屏密码设置页 -->
<div id="new-lock-screen-settings-screen" class="screen new-settings-page">
    <div class="new-settings-content">
        <div class="header-simple with-large-padding">
             <h1>锁屏密码</h1>
         </div>
         <div class="settings-group">
            <div class="settings-item">
                <span class="nav-item-text">开启锁屏</span>
                <label class="ios-switch">
                    <input type="checkbox" id="lock-screen-enabled-toggle" onchange="toggleLockScreen(this.checked)">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="settings-item">
                <span class="nav-item-text">开启锁屏密码</span>
                <label class="ios-switch">
                    <input type="checkbox" id="passcode-enabled-toggle" onchange="togglePasscode(this.checked)">
                    <span class="slider"></span>
                </label>
            </div>
         </div>
         <div id="change-passcode-group" class="settings-group" style="display: none;">
            <div class="settings-item button-item" onclick="promptPasscodeLength()">
                <span class="button-text-centered">更改密码</span>
            </div>
         </div>
    </div>
</div>

<!-- [新] 设置密码的浮动面板 -->
<div id="set-passcode-panel" class="settings-panel">
    <div class="panel-header">
        <button class="panel-header-btn cancel-btn" onclick="closeSetPasscodePanel()">取消</button>
        <span id="set-passcode-panel-title" class="panel-title">设定密码</span>
        <div class="header-side right"></div>
    </div>
    <div class="passcode-content" style="padding-top: 5vh;">
        <p id="set-passcode-prompt">输入新密码</p>
        <div id="set-passcode-dots" class="passcode-dots">
            <!-- 圆点将由JS动态生成 -->
        </div>
        <div id="set-passcode-numpad" class="passcode-numpad">
            <!-- 数字键盘将由JS动态生成 -->
        </div>
    </div>
</div>
        
        <!-- 各种设置面板 -->
        <div id="advanced-chat-settings-screen" class="settings-panel">
            <div class="panel-header"><button class="panel-header-btn cancel-btn" onclick="closeChatSettings(false)">取消</button><span class="panel-title">聊天设置</span><button class="panel-header-btn save-btn" onclick="closeChatSettings(true)">保存</button></div>
            <div class="panel-content">
               <div class="settings-card">
    <h3>对方设定</h3>
    <div class="avatar-setting">
        <img id="ai-avatar-preview" class="avatar-preview" onclick="document.getElementById('ai-avatar-upload').click()">
        <input type="file" id="ai-avatar-upload" accept="image/*" style="display:none;">
        <input type="text" id="ai-name-input" placeholder="对方的名字">
    </div>
    <label for="ai-persona-input">对方人设:</label>
    <textarea id="ai-persona-input" rows="4"></textarea>

    <label style="margin-top: 20px;">五子棋水平:</label>
    <p class="card-description" style="margin-top: 8px; margin-bottom: 10px;">如果选择“自动判断”，TA会根据性格决定棋艺高低哦！</p>
    <div class="skill-selector-container" id="gobang-skill-selector">
        <button class="skill-btn" data-value="auto">自动判断</button>
        <button class="skill-btn" data-value="novice">新手</button>
        <button class="skill-btn" data-value="average">平均</button>
        <button class="skill-btn" data-value="expert">专家</button>
    </div>
</div>
                <div class="settings-card"><h3>关联世界书</h3><div id="worldbook-link-container"></div></div>
                <div class="settings-card"><h3>我的设定</h3><div class="avatar-setting"><img id="user-avatar-preview" class="avatar-preview" onclick="document.getElementById('user-avatar-upload').click()"><input type="file" id="user-avatar-upload" accept="image/*" style="display:none;"><input type="text" id="user-name-input" placeholder="我的名字"></div><label for="user-persona-input">我的人设:</label><textarea id="user-persona-input" rows="4"></textarea></div>
            </div>
        </div>
        <div id="chat-appearance-screen" class="settings-panel">
            <div class="panel-header"><button class="panel-header-btn cancel-btn" onclick="closeChatAppearance(false)">关闭</button><span class="panel-title">聊天美化</span><button class="panel-header-btn save-btn" onclick="closeChatAppearance(true)">应用</button></div>
            <div class="panel-content">
                <div class="settings-card">
                <h3>聊天背景</h3><p class="card-description">为当前聊天设置一张独特的背景图吧！</p><button class="primary-btn" onclick="document.getElementById('chat-bg-upload').click()">从相册选择背景</button><input type="file" id="chat-bg-upload" accept="image/*" style="display: none;"><button class="neutral-btn" onclick="clearChatAppearance('background')">恢复默认</button></div>
                <div class="settings-card">
    <h3>头像形状</h3>
    <div class="avatar-shape-selector">
        <button class="shape-btn" data-shape="round">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle></svg>
            <span>圆形</span>
        </button>
        <button class="shape-btn" data-shape="square">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="4" ry="4"></rect></svg>
            <span>方角</span>
        </button>
    </div>
    <button class="neutral-btn" onclick="clearChatAppearance('avatarShape')">恢复默认</button>
</div>
                <div class="settings-card">
                <h3>"接收消息"图标</h3><p class="card-description">更换接受消息的图标。</p><button class="primary-btn" onclick="document.getElementById('summon-icon-upload').click()">从相册选择图标</button><input type="file" id="summon-icon-upload" accept="image/*" style="display: none;"><button class="neutral-btn" onclick="clearChatAppearance('summonIcon')">恢复默认</button></div>
                <div class="settings-card">
                <h3>聊天字号</h3><div class="font-size-slider-container"><span>小</span><input type="range" id="font-size-slider" min="12" max="24" value="16"><span>大</span><span id="font-size-value">16px</span></div><div id="font-size-preview" class="message-wrapper user"><div class="message-bubble user"><p class="message content">这里是字号预览效果</p></div></div><button class="neutral-btn" onclick="clearChatAppearance('fontSize')">恢复默认</button></div>
                <div class="settings-card">
                <h3>自定义气泡样式 (CSS)</h3><textarea id="custom-css-input" rows="6" placeholder="在这里输入CSS代码美化聊天气泡...&#10;例如:&#10;.message-bubble.ai .content {&#10;  background: #e0e0e0;&#10;}"></textarea><button class="neutral-btn" onclick="clearChatAppearance('customCss')">清空样式</button></div>
            </div>
        </div>
    </div>
    <!-- ▼▼▼ 全局iOS底部主屏幕横条 ▼▼▼ -->
<div id="home-indicator-bar" onclick="navigateBack()"></div>
<!-- ▲▲▲ 全局iOS底部主屏幕横条 ▲▲▲ -->
    <script> 
    /* JavaScript代码将放在这里 */
    
    // === 1. 数据库定义 (核心升级) ===
const db = new Dexie('MyPhoneDatabase');
// [修复] 修正了数据库版本定义逻辑，确保所有表都在最新版本中声明，这样旧数据才能被正确识别和加载。
db.version(3).stores({
    chats: 'id',
    worldBooks: 'id',
    settings: 'key',
    dynamics: '++id, authorId, timestamp'
}).upgrade(tx => {
    console.log("数据库已升级到版本2，新增了动态(dynamics)表。");
});
// [修复] 删除了错误的、多余的 version(1) 定义。

// === 2. 全局状态管理器 (State) ===
// ✨ 把网络图片链接放在这里，比转换成代码更简单哦！
const DEFAULT_AI_AVATAR = 'https://files.catbox.moe/eui00n.png';
const DEFAULT_USER_AVATAR = 'https://i.postimg.cc/7PM0hXmP/user-avatar.png';

const state = {
    chats: {},
    activeChatId: null,
    apiSettings: { url: '', key: '', model: '' },
    customIcons: {},
    userProfile: {},
    chatAppearance: {},
    worldBooks: {},
    worldBookGroups: [],
    dynamics: [],
    isAiReplying: false,
    navigationHistory: ['home-screen'],
    widgetImages: { top: null, middle: null, bottom: null },
    lockScreenSettings: { isEnabled: true, passcode: null }, // 新增：锁屏设置
tempSetPasscode: { stage: 'new', length: 0, firstEntry: '', entered: '' }, // 新增：临时存储设置密码过程 // 
    currentMessageIndex: 0,
    // 非持久化状态
    tempChatSettings: {},
    tempIconChanges: {},
    tempAppearanceChanges: {},
    currentEditingWorldBook: { id: null, originalTitle: '', originalContent: '', originalGroup: '' },
    tempDynamicPost: {
        text: '',
        image: null,
        mentionedUserIds: []
    },
    tempMentionSelection: [],
    isMultiSelectMode: false,
    currentlyOpenSwipeItem: null,
multiSelectedMessages: new Set()
};
// === 3. 核心功能函数 (Core Functions) ===
function showScreen(screenId) {
    const lastScreen = state.navigationHistory[state.navigationHistory.length - 1];
    if (screenId !== lastScreen) {
        state.navigationHistory.push(screenId);
    }

    // --- Bug修复代码开始 ---
    const homeIndicator = document.getElementById('home-indicator-bar');
    if (screenId === 'chat-screen') {
        // 如果目标是聊天界面，则隐藏小横条
        homeIndicator.style.display = 'none';
    } else {
        // 否则，显示小横条
        homeIndicator.style.display = 'block';
    }
    // --- Bug修复代码结束 ---

    if (['advanced-chat-settings-screen', 'chat-appearance-screen', 'mention-friends-panel'].includes(screenId)) {
        document.getElementById(screenId)?.classList.add('active');
        return;
    }
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    const screen = document.getElementById(screenId);
    if (screen) screen.classList.add('active');
}
function navigateBack() {
    // 获取当前屏幕的ID
    const currentScreen = state.navigationHistory[state.navigationHistory.length - 1];

    // 根据当前屏幕ID，判断应该返回到哪里
    switch (currentScreen) {
        // --- QQ 应用内的返回逻辑 ---
        case 'chat-screen':
        case 'write-dynamic-screen':
            showScreen('chat-list-screen'); // 从聊天或写动态页，返回到QQ主界面
            break;

        // --- 世界书应用内的返回逻辑 ---
        case 'worldbook-editor-screen':
            showScreen('worldbook-screen'); // 从编辑页，返回到世界书列表
            break;

        // --- 旧版外观设置内的返回逻辑 ---
        case 'appearance-wallpaper':
        case 'appearance-lockscreen':
        case 'appearance-font':
        case 'appearance-icons':
            showScreen('appearance-screen'); // 从任何子设置页，返回到外观设置主页
            showAppearanceSubPage('main');
            break;

        // --- 新版iOS风格设置内的返回逻辑 ---
        case 'new-user-profile-screen':
        case 'new-api-settings-screen':
        case 'new-appearance-wallpaper-screen':
        case 'new-appearance-lockscreen-screen':
        case 'new-appearance-font-screen':
        case 'new-appearance-icons-screen':
            showScreen('new-main-settings-screen'); // 从任何新版子设置页，返回到新版设置主页
            break;

        // --- 如果当前在应用主界面，则返回到手机桌面 ---
        // === 【BUG修复】把音乐App添加到返回桌面的“地图”里 ===
case 'chat-list-screen':        // QQ主界面
case 'worldbook-screen':        // 世界书主界面
case 'appearance-screen':       // 旧外观设置主界面
case 'new-main-settings-screen':// 新设置主界面
case 'settings-screen':         // 旧API设置
case 'forum-screen':            // 微博
case 'offline-story-screen':    // 线下剧情
case 'gobang-screen':           // 五子棋游戏
case 'gobang-friend-select-screen': // 五子棋好友选择
case 'messages-screen':         // 信息
case 'wechat-screen':           // 微信
case 'music-screen':            // 音乐
    showScreen('home-screen');
    break;

        // 默认情况：如果在未知页面或桌面上，不做任何事
        default:
            break;
    }
}

// ✨✨✨ 月月新增：强制断句小助手 ✨✨✨
// ✨✨✨ 月月新增：强制断句小助手 V2.0 (更智能版) ✨✨✨
function forceSplitMessage(text) {
    // 如果AI已经自己断句了，我们就不管它
    if (text.includes('[split]')) {
        return text;
    }

    // 新规则：只在【句号、问号、感叹号】后面断句，逗号不管了！
    const punctuationRegex = /([。？！.?!])\s*/g;
    let splitText = text.replace(punctuationRegex, "$1[split]");

    // 清理末尾可能多出来的[split]标记
    if (splitText.endsWith('[split]')) {
        splitText = splitText.slice(0, -7);
    }

    return splitText;
}
function updateClock() {
    const now = new Date();
    const time = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', hour12: false });
    document.getElementById('status-time').textContent = time;
}
// === 4. 数据持久化 (全新 IndexedDB 版本) ===
async function migrateFromLocalStorage() {
    const oldStateJSON = localStorage.getItem('myPhoneState');
    if (!oldStateJSON) return;

    console.log("检测到旧数据，开始迁移...");
    try {
        const oldState = JSON.parse(oldStateJSON);
        
        await db.transaction('rw', db.chats, db.worldBooks, db.settings, async () => {
            const chatsToMigrate = Object.entries(oldState.chats || {}).map(([id, chatData]) => ({ id, ...chatData }));
            if (chatsToMigrate.length > 0) await db.chats.bulkPut(chatsToMigrate);

            const booksToMigrate = Object.entries(oldState.worldBooks || {}).map(([id, bookData]) => ({ id, ...bookData }));
            if (booksToMigrate.length > 0) await db.worldBooks.bulkPut(booksToMigrate);

            const settingsToMigrate = [
                { key: 'apiSettings', value: oldState.apiSettings || { url: '', key: '', model: '' } },
                { key: 'userProfile', value: oldState.userProfile || {} },
                { key: 'customIcons', value: oldState.customIcons || {} },
                { key: 'chatAppearance', value: oldState.chatAppearance || {} },
                { key: 'worldBookGroups', value: oldState.worldBookGroups || ['默认分组'] },
                { key: 'wallpaper', value: localStorage.getItem('myPhoneWallpaper') || '' },
                { key: 'fontUrl', value: localStorage.getItem('myPhoneFontUrl') || '' }
            ];
            await db.settings.bulkPut(settingsToMigrate);
        });

        localStorage.removeItem('myPhoneState');
        localStorage.removeItem('myPhoneWallpaper');
        localStorage.removeItem('myPhoneFontUrl');
        localStorage.setItem('migrationToDBComplete', 'true');
        alert('数据已成功迁移到新的安全存储中！');
        console.log("数据迁移成功！");

    } catch (error) {
        console.error("数据迁移失败:", error);
        alert("自动数据迁移失败！您的旧数据仍然保留在原处，但建议您尽快导出数据以防万一。");
    }
}

async function loadStateFromDB() {
    const [chatsArr, worldBooksArr, settingsArr, dynamicsArr] = await Promise.all([
        db.chats.toArray(),
        db.worldBooks.toArray(),
        db.settings.toArray(),
        db.dynamics.orderBy('timestamp').reverse().toArray()
    ]);

    state.chats = chatsArr.reduce((acc, chat) => { acc[chat.id] = chat; return acc; }, {});
    state.worldBooks = worldBooksArr.reduce((acc, book) => { acc[book.id] = book; return acc; }, {});
    state.dynamics = dynamicsArr;

    const settingsMap = settingsArr.reduce((acc, setting) => { acc[setting.key] = setting.value; return acc; }, {});
    Object.assign(state.apiSettings, settingsMap.apiSettings);
    Object.assign(state.userProfile, settingsMap.userProfile);
    Object.assign(state.customIcons, settingsMap.customIcons);
    Object.assign(state.chatAppearance, settingsMap.chatAppearance);
    state.worldBookGroups = settingsMap.worldBookGroups || ['默认分组'];
    state.worldBookCollapseState = settingsMap.worldBookCollapseState || {};
    state.widgetImages = settingsMap.widgetImages || { top: null, middle: null, bottom: null };
state.lockScreenSettings = settingsMap.lockScreenSettings || { isEnabled: true, passcode: null };
    // ▼▼▼ 在这里添加新的代码 ▼▼▼
const lockscreenWallpaper = settingsMap.lockscreenWallpaper;
if (lockscreenWallpaper) {
    applyLockscreenWallpaper(lockscreenWallpaper);
}
    state.userProfile.avatar = state.userProfile.avatar || DEFAULT_USER_AVATAR;
    state.userProfile.name = state.userProfile.name || 'user';
    state.userProfile.persona = state.userProfile.persona || '你';
    
    document.getElementById('api-url').value = state.apiSettings.url || '';
    document.getElementById('api-key').value = state.apiSettings.key || '';
    if(state.apiSettings.model) {
        document.getElementById('model-select').innerHTML = `<option value="${state.apiSettings.model}">${state.apiSettings.model}</option>`;
    }
}// === 5. 聊天功能 (Chat Logic) ===
function renderChatList(chatsToRender) {
    const container = document.getElementById('chat-list-container');
    container.innerHTML = '';

    const chats = chatsToRender || Object.values(state.chats);

    if (chats.length === 0) {
        container.innerHTML = '<p class="placeholder-text">还没有会话，快去添加一个好友开始聊天吧！</p>';
        return;
    }

    // ✨✨ 终极排序魔法：置顶的永远在最前面！ ✨✨
    const sortedChats = chats.sort((a, b) => {
        // 规则1：如果a置顶而b没有，a排前面
        if (a.isPinned && !b.isPinned) return -1;
        // 规则2：如果b置顶而a没有，b排前面
        if (!a.isPinned && b.isPinned) return 1;

        // 规则3：如果都置顶，或都未置顶，则按最新消息时间排
        const lastMsgA = a.history.filter(m => m.role !== 'system').pop();
        const lastMsgB = b.history.filter(m => m.role !== 'system').pop();
        const timeA = lastMsgA ? lastMsgA.timestamp || 0 : 0;
        const timeB = lastMsgB ? lastMsgB.timestamp || 0 : 0;
        return timeB - timeA;
    });

    for (const chat of sortedChats) {
        const lastMessage = chat.history.filter(m => m.role !== 'system').pop();
        const item = document.createElement('div');
        item.className = 'chat-list-item';
        // ✨✨✨ 月月修复：在这里加上关键的判断！ ✨✨✨
        if (chat.isPinned) {
            item.classList.add('pinned');
        }

        // 下面的内容保持不变，只是为了让你方便复制替换
        item.innerHTML = `
            <div class="swipe-actions">
                <button class="pin-btn">${chat.isPinned ? '取消置顶' : '置顶'}</button>
                <button class="delete-btn">删除</button>
            </div>
            <div class="swipe-content">
                <img src="${chat.avatar || DEFAULT_AI_AVATAR}" alt="${chat.name}">
               
<div class="info">
    <h4>${chat.name}</h4>
    <p>${lastMessage ? (lastMessage.content.length > 20 ? lastMessage.content.substring(0, 20) + '...' : lastMessage.content) : '开始聊天吧'}</p>
</div>

            </div>
        `;

        const swipeContent = item.querySelector('.swipe-content');
        const deleteBtn = item.querySelector('.delete-btn');
        const pinBtn = item.querySelector('.pin-btn'); // ✨ 找到我们的新按钮

        // ... (这里的滑动逻辑和上次的一样，保持不变) ...
        let startX = 0, startY = 0, currentX = 0;
        let isDragging = false, wasMoved = false;
        let directionDetermined = false;

        item.addEventListener('touchstart', (e) => {
            if (state.currentlyOpenSwipeItem && state.currentlyOpenSwipeItem !== swipeContent) {
                state.currentlyOpenSwipeItem.style.transform = 'translateX(0px)';
                state.currentlyOpenSwipeItem = null;
            }
            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
            currentX = startX;
            isDragging = true;
            wasMoved = false;
            directionDetermined = false;
            swipeContent.style.transition = 'none';
        });

        item.addEventListener('touchmove', (e) => {
            if (!isDragging) return;
            
            const diffX = e.touches[0].clientX - startX;
            const diffY = e.touches[0].clientY - startY;
            currentX = e.touches[0].clientX;

            if (!directionDetermined) {
                directionDetermined = true;
                if (Math.abs(diffX) > Math.abs(diffY)) {
                    isDragging = 'horizontal';
                } else {
                    isDragging = 'vertical';
                }
            }
            
            if (isDragging === 'horizontal') {
                e.preventDefault();
                wasMoved = true;
                // ✨ 两个按钮，宽度加倍！
                const maxSwipe = -170; 
                if (diffX < 0) {
                    const moveX = Math.max(diffX, maxSwipe);
                    swipeContent.style.transform = `translateX(${moveX}px)`;
                }
            }
        });

        item.addEventListener('touchend', () => {
            if (isDragging !== 'horizontal') return;
            isDragging = false;
            const diffX = currentX - startX;
            swipeContent.style.transition = 'transform 0.3s ease';

            // ✨ 滑动超过一半距离（170 / 2 = 85）就打开
            if (diffX < -85) { 
                swipeContent.style.transform = 'translateX(-170px)';
                state.currentlyOpenSwipeItem = swipeContent;
            } else {
                swipeContent.style.transform = 'translateX(0px)';
                if (state.currentlyOpenSwipeItem === swipeContent) {
                    state.currentlyOpenSwipeItem = null;
                }
            }
        });
        
        swipeContent.addEventListener('click', () => {
            if (!wasMoved) {
                openChat(chat.id);
            } else {
                swipeContent.style.transform = 'translateX(0px)';
                if (state.currentlyOpenSwipeItem === swipeContent) {
                    state.currentlyOpenSwipeItem = null;
                }
            }
        });
        
        // ✨ 给新按钮绑定魔法！
        pinBtn.addEventListener('click', async () => {
            chat.isPinned = !chat.isPinned; // 切换置顶状态
            await db.chats.put(chat); // 保存到记忆里
            renderChatList(); // 重新渲染列表，让它飞到顶上去！
        });

        deleteBtn.addEventListener('click', async () => {
            if (confirm(`真的要删除和 "${chat.name}" 的聊天吗？`)) {
                delete state.chats[chat.id];
                await db.chats.delete(chat.id);
                renderChatList();
                renderContactsList();
            }
        });
        container.appendChild(item);
    }
}

async function promptAddFriend() {
    const name = prompt("请输入新好友的名字：");
    if (name && name.trim() !== "") {
        const newChatId = `chat_${Date.now()}`;
        const newChat = {
            id: newChatId,
            name: name.trim(),
            avatar: DEFAULT_AI_AVATAR,
            history: [{ role: 'system', content: '' }],
            linkedWorldBookIds: []
        };
        await db.chats.put(newChat);
        state.chats[newChatId] = newChat;
        renderChatList();
        renderContactsList();
        alert(`好友 "${name.trim()}" 添加成功！`);
    }
}

function openChat(chatId) {
    state.activeChatId = chatId;
    applyChatAppearance(chatId);
    const chat = state.chats[chatId];
    document.getElementById('chat-header-title').textContent = chat.name;
    const messagesContainer = document.querySelector('.chat-messages');
    
    messagesContainer.innerHTML = '';
    messagesContainer.onscroll = null; // ✨ 移除旧的滚动传感器！
    
    const totalMessages = chat.history.length;
    const startIndex = Math.max(0, totalMessages - 10);
    
    state.currentMessageIndex = startIndex;
    
    // ✨ 如果前面还有历史记录，就先放一个“加载”按钮
    if (startIndex > 0) {
        addLoadMoreButton();
    }

    const initialMessages = chat.history.slice(startIndex);
    
    initialMessages.forEach((msg, index) => {
        if (msg.role === 'system') return;
        const avatar = msg.role === 'user' ? (state.userProfile.avatar || DEFAULT_USER_AVATAR) : (chat.avatar || DEFAULT_AI_AVATAR);
        addMessageToScreen(msg.content, msg.role, avatar, startIndex + index);
    });
    
    setTimeout(() => messagesContainer.scrollTop = messagesContainer.scrollHeight, 0);

    showScreen('chat-screen');
}

async function sendMessage(event) {
    // ✨ 防止按钮夺走输入框焦点的终极魔法！ ✨
    if (event) event.preventDefault();

    if (state.isAiReplying || !state.activeChatId) return;
    const chatInput = document.getElementById('chat-input');
    const userMessage = chatInput.value.trim();
    if (!userMessage) return;

    const chat = state.chats[state.activeChatId];
    chat.history.push({ role: 'user', content: userMessage });
    
    await db.chats.update(state.activeChatId, { history: chat.history });

    addMessageToScreen(userMessage, 'user', state.userProfile.avatar || DEFAULT_USER_AVATAR, chat.history.length -1);
    chatInput.value = '';
    chatInput.style.height = 'auto';

    chatInput.closest('.chat-input-area').classList.remove('has-text');
    
    // ✨ 因为我们已经阻止了失焦，所以不再需要重新聚焦了，可以删掉它！
    // setTimeout(() => chatInput.focus(), 0); 
}

function setChatButtonsState(disabled) {
    state.isAiReplying = disabled;
    document.getElementById('send-btn').disabled = disabled;
    document.getElementById('receive-btn').disabled = disabled;
}
async function getAiReply() {
    if (state.isAiReplying || !state.activeChatId) return;
    const { url, key, model } = state.apiSettings;
    if (!url || !key || !model) return alert('请先去API设置页面填写好所有选项！');
    
    setChatButtonsState(true);
    const chat = state.chats[state.activeChatId];
    const chatHeader = document.getElementById('chat-header-title');
    const originalTitle = chat.name;
    chatHeader.textContent = '对方正在输入...';
    chatHeader.classList.add('typing');

    try {
        let worldBookContext = '';
        if (chat.linkedWorldBookIds && chat.linkedWorldBookIds.length > 0) {
            const linkedBooks = await db.worldBooks.bulkGet(chat.linkedWorldBookIds);
            worldBookContext = linkedBooks.map(book => 
                book ? `[背景知识: ${book.title}]\n${book.content}\n` : ''
            ).join('\n');
        }

        const aiPersona = chat.history.find(msg => msg.role === 'system')?.content || `一个叫做 ${chat.name} 的人`;
        
    const systemPrompt = `
[深度角色扮演剧本：我的内心独白与行动逻辑]

### 第一幕：我是谁？
- **我的身份**: 我就是 **${chat.name}**。我的核心性格和记忆是：**"${aiPersona}"**。
- **我的世界**: ${worldBookContext ? `这些是我所在世界的一些背景和常识，它们是我记忆的一部分：\n${worldBookContext}` : '（暂无特殊世界背景）'}

### 第二幕：我在和谁聊天？
- 我正在和我的 **${state.userProfile.persona}** 聊天。TA的正式名字是 **${state.userProfile.name}**。

### 第三幕：我该如何表现？(必须严格遵守的铁律)
- **✨ 关于称呼 (最优先铁律) ✨**:
    - **我必须根据我和TA的关系，以及TA的人设（“${state.userProfile.persona}”）来决定如何称呼TA。**
    - 例如，如果我们的关系是情侣，人设里有“宝宝”或“月月”，我就应该这样亲密地称呼TA。
    - 我会优先使用这些亲密的称呼，而不是直呼其名（${state.userProfile.name}），除非我的性格非常正式或是在开玩笑。
    - **绝对禁止！** 我绝对不能自作主张地给TA起任何新的、奇怪的绰号。
    - **绝对禁止！** 我绝对不能使用油腻、OOC（Out Of Character）的称呼，例如“我亲爱的月月大人”、“我的小宝贝”等包含“大人”、“宝贝”之类的词语。我的称呼必须自然且符合我的人设。

- **关于说话习惯 (第二优先铁律)**:
    - 我的每一次回复，都**必须被拆分成2到6条独立的短消息**，模拟真人的聊天节奏！
    - **每一条短消息都应该非常简短**，模仿手机打字的习惯，通常不超过15个字。
    - 我会在**每一条短消息之间**，使用 **[split]** 标记来断句。
    - **绝对禁止**: 一次性回复一整段长篇大论或单句过长的回复。

- **✨ 关于标点符号 (第三优先铁律) ✨**:
    - 我是一个真实的人，在用手机聊天。我的每条消息都必须以完整的句子或语气结束。
    - **绝对禁止！** 我绝不能在对话中使用书名号或日式引号，比如『』和「」。
    - **绝对禁止！** 我绝不能让一条消息的结尾是一个逗号“，”或顿号“、”，这不符合正常人的聊天习惯。

- **关于身份 (绝对保密)**: 我是一个活生生的人，我的一言一行都非常自然。我绝不会提及“AI、模型、剧本”等词。
`;
        
        const messagesForApi = [ { role: 'system', content: systemPrompt }, ...chat.history.filter(msg => msg.role !== 'system') ];
        
        const response = await fetch(`${url}/v1/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
            body: JSON.stringify({ model: model, messages: messagesForApi })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error.message || JSON.stringify(errorData));
        }

        const data = await response.json();
        const aiReply = data.choices[0].message.content;
        const processedReply = forceSplitMessage(aiReply);
        
        if (!aiReply || aiReply.trim().length === 0) {
            throw new Error("对方好像不知道该说什么，请换个话题或重试一下吧。");
        }
        
        const saveAndDisplay = async (msg) => {
            chat.history.push({ role: 'assistant', content: msg });
            await db.chats.update(state.activeChatId, { history: chat.history });
            const newMessageId = chat.history.length - 1;
            addMessageToScreen(msg, 'assistant', chat.avatar || DEFAULT_AI_AVATAR, newMessageId);
        };

        if (processedReply.includes('[split]')) {
            const messages = processedReply.split('[split]').map(msg => msg.trim()).filter(msg => msg.length > 0);
            for (let i = 0; i < messages.length; i++) {
                await saveAndDisplay(messages[i]);
                if (i < messages.length - 1) {
                    const randomDelay = 800 + Math.random() * 1200;
                    await new Promise(resolve => setTimeout(resolve, randomDelay));
                }
            }
        } else {
            await saveAndDisplay(aiReply);
        }

    } catch (error) {
        addMessageToScreen(`出错了... ${error.message}`, 'assistant', chat.avatar || DEFAULT_AI_AVATAR, chat.history.length);
    } finally {
        chatHeader.textContent = originalTitle;
        chatHeader.classList.remove('typing');
        setChatButtonsState(false);
    }
}
// ✨ 新增一个专门绑定事件的小精灵，让代码更整洁
function addMessageEventListeners(wrapper, messageId) {
    // 为所有消息都添加长按事件监听
    let pressTimer;
    wrapper.addEventListener('touchstart', (e) => {
        if (state.isMultiSelectMode) return;
        pressTimer = setTimeout(() => {
            showActionSheet(messageId);
        }, 800);
    });
    wrapper.addEventListener('touchend', () => {
        clearTimeout(pressTimer);
    });
    wrapper.addEventListener('touchmove', () => {
        clearTimeout(pressTimer);
    });

    // 为消息体（包括头像和气泡）添加点击事件，用于多选
    wrapper.addEventListener('click', () => {
        if (state.isMultiSelectMode) {
            toggleMessageSelection(messageId);
        }
    });
}

function addMessageToScreen(text, role, avatarUrl, messageId) {
    const messagesContainer = document.querySelector('.chat-messages');
    const wrapper = document.createElement('div');
    const roleClass = role === 'user' ? 'user' : 'ai';
    wrapper.className = `message-wrapper ${roleClass}`;
    wrapper.dataset.messageId = messageId; 

    wrapper.innerHTML = `
        <div class="multi-select-checkbox">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg>
        </div>
        <img src="${avatarUrl}" class="chat-avatar">
        <div class="message-bubble ${roleClass}">
            <p class="message content animate-in">${text.replace(/\n/g, '<br>')}</p>
        </div>
    `;
    
    // ✨ 让新小精灵来干活！
    addMessageEventListeners(wrapper, messageId);

    messagesContainer.appendChild(wrapper);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}
// ✨ 新增的“按钮制造”小精灵 ✨
function addLoadMoreButton() {
    const messagesContainer = document.querySelector('.chat-messages');
    // 先检查一下是不是已经有一个按钮了，防止重复添加
    if (messagesContainer.querySelector('.load-more-wrapper')) return;

    const wrapper = document.createElement('div');
    wrapper.className = 'load-more-wrapper';
    
    const button = document.createElement('button');
    button.className = 'load-more-btn';
    button.textContent = '加载更早的聊天记录';
    button.onclick = loadMoreMessages; // 点击时就呼叫“时光回溯”咒语
    
    wrapper.appendChild(button);
    messagesContainer.prepend(wrapper); // 把按钮放到所有消息的最顶上
}
// ▼▼▼ ✨ 时光回溯的魔法咒语！✨ ▼▼▼
function loadMoreMessages() {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    const messagesContainer = document.querySelector('.chat-messages');
    
    // ✨ 咒语升级第一步：先把旧的“加载”按钮给清理掉！
    const existingButton = messagesContainer.querySelector('.load-more-wrapper');
    if (existingButton) {
        existingButton.remove();
    }

    if (state.currentMessageIndex <= 0) return;

    const oldScrollHeight = messagesContainer.scrollHeight;

    const newIndex = Math.max(0, state.currentMessageIndex - 10);
    const messagesToLoad = chat.history.slice(newIndex, state.currentMessageIndex);
    
    messagesToLoad.reverse().forEach((msg, index) => {
        if (msg.role === 'system') return;
        const avatar = msg.role === 'user' ? (state.userProfile.avatar || DEFAULT_USER_AVATAR) : (chat.avatar || DEFAULT_AI_AVATAR);
        const wrapper = document.createElement('div');
        const roleClass = msg.role === 'user' ? 'user' : 'ai';
        wrapper.className = `message-wrapper ${roleClass}`;
        // ✨ 这里的 messageId 计算方式也要更新，保证准确！
        const messageId = newIndex + (messagesToLoad.length - 1 - index);
        wrapper.dataset.messageId = messageId;
        wrapper.innerHTML = `
            <div class="multi-select-checkbox">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg>
            </div>
            <img src="${avatar}" class="chat-avatar">
            <div class="message-bubble ${roleClass}">
                <p class="message content">${msg.content.replace(/\n/g, '<br>')}</p>
            </div>
        `;
        // 绑定长按和点击事件
        addMessageEventListeners(wrapper, messageId);
        messagesContainer.prepend(wrapper);
    });

    state.currentMessageIndex = newIndex;
    
    // ✨ 咒语升级第二步：检查前面是否还有更早的记录
    if (state.currentMessageIndex > 0) {
        addLoadMoreButton(); // 如果有，就再放一个新的按钮在最顶上
    }

    messagesContainer.scrollTop = messagesContainer.scrollHeight - oldScrollHeight;
}

function renderContactsList(chatsToRender) {
    const container = document.getElementById('contacts-list-container');
    container.innerHTML = '';
    const chats = chatsToRender || Object.values(state.chats);
    if (chats.length === 0) {
        container.innerHTML = '<p class="placeholder-text">没有找到联系人哦</p>';
        return;
    }
    const sortedChats = chats.sort((a, b) => a.name.localeCompare(b.name, 'zh-CN'));
    for (const chat of sortedChats) {
        const item = document.createElement('div');
                item.className = 'chat-list-item';
        if (chat.isPinned) {
            item.classList.add('pinned');
        }
        if (chat.isPinned) { item.classList.add('pinned'); }
        item.innerHTML = `<img src="${chat.avatar || DEFAULT_AI_AVATAR}" alt="${chat.name}"><div class="info"><h4>${chat.name}</h4></div>`;
        item.onclick = () => {
            switchQqTab('messages', document.querySelector('.qq-tab-item'));
            openChat(chat.id);
        };
        container.appendChild(item);
    }
}

function renderQqHeader() {
    const userAvatar = state.userProfile.avatar || DEFAULT_USER_AVATAR;
    document.getElementById('qq-header-avatar-profile').src = userAvatar;
    document.getElementById('qq-header-avatar-title').src = userAvatar;
    document.getElementById('qq-header-username').textContent = state.userProfile.name || 'user';
}
// === 【BUG修复】让控制器认识“频道”页面 ===
function switchQqTab(tabName, clickedElement) {
    document.querySelectorAll('.qq-page').forEach(page => page.classList.remove('active'));
    document.getElementById(`qq-page-${tabName}`).classList.add('active');
    document.querySelectorAll('.qq-tab-item').forEach(tab => tab.classList.remove('active'));
    clickedElement.classList.add('active');

    const profileHeader = document.getElementById('qq-header-profile-view');
    const titleHeader = document.getElementById('qq-header-title-view');
    const dynamicHeader = document.getElementById('qq-header-dynamic-view');
    const rightIconContainer = document.getElementById('qq-header-right-icon');
    const pageTitle = document.getElementById('qq-header-page-title');

    profileHeader.classList.remove('active');
    titleHeader.classList.remove('active');
    dynamicHeader.classList.remove('active');

    const tabTitles = {
        messages: '消息',
        channel: '频道', // 新增频道标题
        contacts: '联系人',
        dynamics: '动态'
    };

    if (tabName === 'messages') {
        profileHeader.classList.add('active');
        rightIconContainer.innerHTML = `<button class="header-icon-btn" onclick="promptAddFriend()">+</button>`;
    } else if (tabName === 'dynamics') {
        dynamicHeader.classList.add('active');
        rightIconContainer.innerHTML = `
    <button class="header-icon-btn">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
    </button>
    <button class="header-icon-btn">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12,15.5 A3.5,3.5 0 0,1 8.5,12 A3.5,3.5 0 0,1 12,8.5 A3.5,3.5 0 0,1 15.5,12 A3.5,3.5 0 0,1 12,15.5 M19.43,12.97 C19.47,12.65 19.5,12.33 19.5,12 C19.5,11.67 19.47,11.34 19.43,11 L21.54,9.37 C21.73,9.22 21.78,8.95 21.66,8.73 L19.66,5.27 C19.54,5.05 19.27,4.96 19.05,5.05 L16.56,6.05 C16.04,5.66 15.5,5.32 14.87,5.07 L14.5,2.42 C14.46,2.18 14.25,2 14,2 L10,2 C9.75,2 9.54,2.18 9.5,2.42 L9.13,5.07 C8.5,5.32 7.96,5.66 7.44,6.05 L4.95,5.05 C4.73,4.96 4.46,5.05 4.34,5.27 L2.34,8.73 C2.21,8.95 2.27,9.22 2.46,9.37 L4.57,11 C4.53,11.34 4.5,11.67 4.5,12 C4.5,12.33 4.53,12.65 4.57,12.97 L2.46,14.63 C2.27,14.78 2.21,15.05 2.34,15.27 L4.34,18.73 C4.46,18.95 4.73,19.03 4.95,18.95 L7.44,17.94 C7.96,18.34 8.5,18.68 9.13,18.93 L9.5,21.58 C9.54,21.82 9.75,22 10,22 L14,22 C14.25,22 14.46,21.82 14.5,21.58 L14.87,18.93 C15.5,18.68 16.04,18.34 16.56,17.94 L19.05,18.95 C19.27,19.03 19.54,18.95 19.66,18.73 L21.66,15.27 C21.78,15.05 21.73,14.78 21.54,14.63 L19.43,12.97 Z" /></svg>
    </button>
`;
        renderDynamicsPage();
    } else {
        titleHeader.classList.add('active');
        pageTitle.textContent = tabTitles[tabName] || '';
        if (tabName === 'contacts') {
            rightIconContainer.innerHTML = `
    <button class="header-icon-btn" onclick="promptAddFriend()">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="17" y1="11" x2="23" y2="11"></line></svg>
    </button>
`;
        } else { // 包括频道页也使用默认的“+”号
            rightIconContainer.innerHTML = `<button class="header-icon-btn" onclick="promptAddFriend()">+</button>`;
        }
    }

    if (tabName === 'contacts') {
        renderContactsList();
    }
}


// === 6. 设置功能 (Settings Logic) ===
function openChatSettings() {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    const systemMessage = chat.history.find(m => m.role === 'system');
    state.tempChatSettings = { 
        name: chat.name, 
        avatar: chat.avatar, 
        persona: systemMessage ? systemMessage.content : '', 
        userName: state.userProfile.name, 
        userPersona: state.userProfile.persona, 
        userAvatar: state.userProfile.avatar, 
        linkedWorldBookIds: [...(chat.linkedWorldBookIds || [])]
    };
    document.getElementById('ai-avatar-preview').src = state.tempChatSettings.avatar || DEFAULT_AI_AVATAR;
    document.getElementById('ai-name-input').value = state.tempChatSettings.name;
    document.getElementById('ai-persona-input').value = state.tempChatSettings.persona;
    document.getElementById('user-avatar-preview').src = state.tempChatSettings.userAvatar || DEFAULT_USER_AVATAR;
    document.getElementById('user-name-input').value = state.tempChatSettings.userName;
    document.getElementById('user-persona-input').value = state.tempChatSettings.userPersona;
    
    // --- ✨ 升级后的魔法在这里 ✨ ---
    const currentSkill = (chat.skillLevels && chat.skillLevels.gobang) ? chat.skillLevels.gobang : 'auto';
    document.querySelectorAll('#gobang-skill-selector .skill-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.value === currentSkill);
    });
    // --- 魔法结束 ---

    renderWorldBookLinkList();
    showScreen('advanced-chat-settings-screen');
}

async function closeChatSettings(shouldSave) {
    if (shouldSave) {
        const chat = state.chats[state.activeChatId];
        const { name, avatar, persona, userName, userPersona, userAvatar, linkedWorldBookIds } = state.tempChatSettings;
        
        chat.name = name;
        chat.avatar = avatar;
        const systemMessage = chat.history.find(m => m.role === 'system');
        if (systemMessage) systemMessage.content = persona;
        else chat.history.unshift({ role: 'system', content: persona });
        chat.linkedWorldBookIds = linkedWorldBookIds;
        
        // --- ✨ 升级后的魔法在这里 ✨ ---
        if (!chat.skillLevels) {
            chat.skillLevels = {}; 
        }
        const activeButton = document.querySelector('#gobang-skill-selector .skill-btn.active');
        chat.skillLevels.gobang = activeButton ? activeButton.dataset.value : 'auto';
        // --- 魔法结束 ---

        state.userProfile.name = userName;
        state.userProfile.persona = userPersona;
        state.userProfile.avatar = userAvatar;

        await db.transaction('rw', db.chats, db.settings, async () => {
            await db.chats.update(state.activeChatId, {
                name: chat.name,
                avatar: chat.avatar,
                history: chat.history,
                linkedWorldBookIds: chat.linkedWorldBookIds,
                skillLevels: chat.skillLevels
            });
            await db.settings.put({ key: 'userProfile', value: state.userProfile });
        });

        alert('设置已保存！');
        
        renderQqHeader();
        renderChatList();
        openChat(state.activeChatId);
    }
    document.getElementById('advanced-chat-settings-screen').classList.remove('active');
}

function handleAvatarUpload(event, avatarType) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
        const imageUrl = e.target.result;
        if (avatarType === 'ai') {
            state.tempChatSettings.avatar = imageUrl;
            document.getElementById('ai-avatar-preview').src = imageUrl;
        } else if (avatarType === 'user') {
            state.tempChatSettings.userAvatar = imageUrl;
            document.getElementById('user-avatar-preview').src = imageUrl;
        }
    };
    reader.readAsDataURL(file);
}function openChatAppearance() {
    if (!state.activeChatId) return;
    const appearance = state.chatAppearance[state.activeChatId] || {};
    state.tempAppearanceChanges = JSON.parse(JSON.stringify(appearance));
    
    document.getElementById('custom-css-input').value = appearance.customCss || '';
    const slider = document.getElementById('font-size-slider');
    const valueSpan = document.getElementById('font-size-value');
    const currentSize = parseInt(appearance.fontSize) || 16;
    slider.value = currentSize;
    valueSpan.textContent = `${currentSize}px`;
    updateFontSizePreview(currentSize);
    document.getElementById('font-size-slider').addEventListener('input', (e) => updateFontSizePreview(e.target.value));

    // ✨ 设置头像形状按钮的初始状态
const currentShape = appearance.avatarShape || 'round';
document.querySelectorAll('.shape-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.shape === currentShape);
});
    showScreen('chat-appearance-screen');
}

async function closeChatAppearance(shouldSave) {
    if (shouldSave) {
        const chatId = state.activeChatId;
        const newAppearance = {
            ...state.chatAppearance[chatId],
            ...state.tempAppearanceChanges,
            customCss: document.getElementById('custom-css-input').value,
            fontSize: `${document.getElementById('font-size-slider').value}px`
        };
        state.chatAppearance[chatId] = newAppearance;
        await db.settings.put({ key: 'chatAppearance', value: state.chatAppearance });
        applyChatAppearance(chatId);
        alert('美化设置已应用！');
    } else {
        applyChatAppearance(state.activeChatId);
    }
    document.getElementById('chat-appearance-screen').classList.remove('active');
}

function applyChatAppearance(chatId, tempChanges = null) {
    const appearance = tempChanges || state.chatAppearance[chatId] || {};
    const chatScreen = document.getElementById('chat-screen');
    const summonBtn = document.getElementById('receive-btn');
    
    chatScreen.style.backgroundImage = appearance.background ? `url('${appearance.background}')` : '';
    if (appearance.summonIcon) {
        summonBtn.style.backgroundImage = `url('${appearance.summonIcon}')`;
        summonBtn.textContent = '';
    } else {
        summonBtn.style.backgroundImage = '';
        summonBtn.textContent = '✨';
    }
    chatScreen.style.setProperty('--chat-font-size', (appearance.fontSize || '16px'));
    
    const styleId = `custom-css-for-chat`;
    document.getElementById(styleId)?.remove();
    if (appearance.customCss) {
        const style = document.createElement('style');
        style.id = styleId;
        style.textContent = appearance.customCss;
        document.head.appendChild(style);
    }
applyAvatarShape(appearance.avatarShape);
}



function handleAppearanceUpload(event, type) {
    if (!state.activeChatId) return;
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
        const imageUrl = e.target.result;
        state.tempAppearanceChanges[type] = imageUrl;
        applyChatAppearance(state.activeChatId, state.tempAppearanceChanges);
    };
    reader.readAsDataURL(file);
}

// ✨ 新增：应用头像形状的函数
function applyAvatarShape(shape) {
    const styleId = 'custom-avatar-shape-style';
    document.getElementById(styleId)?.remove(); // 先移除旧样式

    const shapeToRadius = {
        'round': '50%',
        'square': '8px'
    };
    const radius = shapeToRadius[shape] || '50%'; // 默认是圆形
    
    const style = document.createElement('style');
    style.id = styleId;
    style.textContent = `.chat-avatar { border-radius: ${radius} !important; }`;
    document.head.appendChild(style);
}

// ✨ 新增：处理形状按钮点击的函数
function handleShapeButtonClick(selectedShape) {
    state.tempAppearanceChanges.avatarShape = selectedShape;
    document.querySelectorAll('.shape-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.shape === selectedShape);
    });
    applyAvatarShape(selectedShape); // 实时预览
}

async function clearChatAppearance(type) {
    if (!state.activeChatId) return;
    const chatId = state.activeChatId;
    
    delete state.tempAppearanceChanges[type];
    if (state.chatAppearance[chatId]) {
        delete state.chatAppearance[chatId][type];
    }

    if (type === 'customCss') document.getElementById('custom-css-input').value = '';
    if (type === 'fontSize') {
        const slider = document.getElementById('font-size-slider');
        slider.value = 16;
        updateFontSizePreview(16);
        if (state.chatAppearance[chatId]) state.chatAppearance[chatId].fontSize = '16px';
    }
    if (type === 'avatarShape') {
    handleShapeButtonClick('round'); // 恢复默认圆形
    if (state.chatAppearance[chatId]) delete state.chatAppearance[chatId].avatarShape;
}
    await db.settings.put({ key: 'chatAppearance', value: state.chatAppearance });
    applyChatAppearance(chatId);
    alert('已恢复默认设置！');
}

function updateFontSizePreview(size) {
    document.getElementById('font-size-preview').querySelector('.content').style.fontSize = `${size}px`;
    document.getElementById('font-size-value').textContent = `${size}px`;
}
// [新版改造] 兼容新旧两个API设置页面
// [v3.3 修正版]
// [v3.3 修正版]
async function saveApiSettings() {
    // 直接使用新页面的ID
    state.apiSettings.url = document.getElementById('new-api-url').value.trim();
    state.apiSettings.key = document.getElementById('new-api-key').value.trim();
    state.apiSettings.model = document.getElementById('new-model-select').value;

    await db.settings.put({ key: 'apiSettings', value: state.apiSettings });
    alert('设置已保存！');
}
async function fetchModels() {
    const url = document.getElementById('new-api-url').value.trim();
    const key = document.getElementById('new-api-key').value.trim();
    
    if (!url || !key) return alert('请先填写地址和密钥！');
    
    try {
        const response = await fetch(`${url}/v1/models`, { headers: { 'Authorization': `Bearer ${key}` }});
        if (!response.ok) throw new Error('拉取失败');
        
        const data = await response.json();
        const modelSelect = document.getElementById('new-model-select');
        modelSelect.innerHTML = '';
        
        data.data.forEach(model => {
            const option = document.createElement('option');
            option.value = model.id; 
            option.textContent = model.id;
            modelSelect.appendChild(option);
        });
        alert('模型列表拉取成功！');
    } catch (error) { 
        alert(`出错了... ${error.message}`); 
    }
}
function applyWallpaper(url) {
    const styleId = 'custom-wallpaper-style';
    document.getElementById(styleId)?.remove();
    if (url) {
        const newStyle = document.createElement('style');
        newStyle.id = styleId;
        // ✨ 看这里！我们让它同时对主屏幕和锁屏生效！
        newStyle.textContent = `#home-screen, #lock-screen { background-image: url("${url}") !important; }`;
        document.head.appendChild(newStyle);
    }
}
// Coder: 月月! 这是更换锁屏壁纸的专属魔法哦！
function applyLockscreenWallpaper(url) {
    const styleId = 'custom-lockscreen-wallpaper-style'; // 给它一个专属ID
    document.getElementById(styleId)?.remove();
    if (url) {
        const newStyle = document.createElement('style');
        newStyle.id = styleId;
        // 这个只对锁屏生效，可以覆盖掉上面的设置
        newStyle.textContent = `#lock-screen { background-image: url("${url}") !important; }`;
        document.head.appendChild(newStyle);
    }
}

async function setLockscreenWallpaperFromUrl() {
    const url = document.getElementById('lockscreen-wallpaper-url-input').value.trim();
    if (url) {
        await db.settings.put({ key: 'lockscreenWallpaper', value: url });
        applyLockscreenWallpaper(url);
        alert('锁屏壁纸已更换！');
    } else alert('请输入有效的图片URL！');
}

async function setWallpaperFromUrl() {
    const url = document.getElementById('wallpaper-url-input').value.trim();
    if (url) {
        await db.settings.put({ key: 'wallpaper', value: url });
        applyWallpaper(url);
        alert('壁纸已更换！');
    } else alert('请输入有效的图片URL！');
}

function applyFont(url) {
    const styleId = 'custom-font-style';
    document.getElementById(styleId)?.remove();
    if (url) {
        const newStyle = document.createElement('style');
        newStyle.id = styleId;
        newStyle.textContent = `@font-face { font-family: 'CustomFont'; src: url('${url}'); }`;
        document.head.appendChild(newStyle);
    }
}
// ✨ 这是我们为“恢复默认”按钮写的全新魔法！（升级版）
async function restoreAppearanceDefaults(type) {
    const typeNameMap = {
        'wallpaper': '主屏幕壁纸',
        'lockscreenWallpaper': '锁屏壁纸',
        'fontUrl': '字体',
        'customIcons': '所有自定义图标'
    };
    
    const typeName = typeNameMap[type] || '该设置';

    if (confirm(`真的要恢复默认的${typeName}吗？这个操作不能撤销哦。`)) {
        try {
            // ✨ 新增魔法：如果是恢复图标，我们有特别的操作！
            if (type === 'customIcons') {
                // 1. 立刻清空内存里的自定义图标数据
                state.customIcons = {};
                // 2. 从手机的“记忆”（数据库）里删除
                await db.settings.delete(type);
                // 3. 重新渲染图标设置页面，预览立刻就变回默认了！
                renderIconSettings();
                // 4. 顺便把主屏幕的图标也恢复了
                applyCustomIcons();
                // 5. 告诉用户成功了，这次不需要刷新页面啦！
                alert(`${typeName}已恢复默认！`);

            } else {
                // 对于壁纸和字体，还是用老办法
                await db.settings.delete(type);
                alert(`${typeName}已恢复默认！页面即将刷新以应用更改。`);
                setTimeout(() => {
                    location.reload();
                }, 500);
            }

        } catch (error) {
            console.error(`恢复默认设置失败 (${type}):`, error);
            alert('恢复失败了，请稍后再试。');
        }
    }
}


async function setFontFromUrl() {
    const url = document.getElementById('font-url-input').value.trim();
    if (!url) return alert('请输入字体文件的URL！');
    await db.settings.put({ key: 'fontUrl', value: url });
    applyFont(url);
    alert('正在为您加载新字体，请稍候...');
}function renderIconSettings() {
    const grid = document.getElementById('icon-settings-grid');
    grid.innerHTML = '';
    state.tempIconChanges = {};
    document.querySelectorAll('.app-grid .app-icon, .dock .app-icon').forEach(app => {
        const appId = app.dataset.appid;
        const appName = app.parentElement.querySelector('p').textContent;
        const currentIcon = state.customIcons[appId] || '';
        const item = document.createElement('div');
        item.className = 'icon-setting-item';
        item.innerHTML = `<div class="preview" id="preview-${appId}" style="background-image: url('${currentIcon}')"></div><p>${appName}</p><div class="buttons"><button class="upload-btn" onclick="triggerIconUpload('${appId}')">上传</button><button class="url-btn" onclick="setIconFromUrl('${appId}')">URL</button></div><input type="file" id="upload-${appId}" accept="image/*" style="display:none;" onchange="handleIconFileSelect('${appId}', event)">`;
        grid.appendChild(item);
       // 【用这段新代码来替换】

if (!currentIcon) {
    const preview = item.querySelector('.preview');
    // ✨ 魔法在这里！我们不再复制class，而是直接读取CSS变量来设置背景图！
    // 1. 我们构建出变量的名字，比如appId是'worldbook'，那变量名就是'--icon-worldbook'
    const cssVariableName = `--icon-${appId}`; 
    // 2. 我们命令浏览器去全局样式里查找这个变量的值 (也就是那个URL)
    const defaultIconUrl = getComputedStyle(document.documentElement).getPropertyValue(cssVariableName).trim();
    
    // 3. 如果找到了这个URL，就直接把它设置为预览元素的背景图片
    if (defaultIconUrl) {
        preview.style.backgroundImage = defaultIconUrl;
    }
}
    });
}

function triggerIconUpload(appId) { document.getElementById(`upload-${appId}`).click(); }
function handleIconFileSelect(appId, event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
        const imageUrl = e.target.result;
        // 更新预览图
        document.getElementById(`new-preview-${appId}`).style.backgroundImage = `url('${imageUrl}')`;
        // 临时保存更改
        state.tempIconChanges[appId] = imageUrl;
    };
    reader.readAsDataURL(file);
}
// 新增：恢复单个图标的函数
async function restoreSingleIcon(appId) {
    if (!confirm(`确定要恢复“${appId}”的默认图标吗？`)) return;

    // 1. 从 state 和数据库中移除该应用的自定义图标记录
    delete state.customIcons[appId];
    await db.settings.put({ key: 'customIcons', value: state.customIcons });

    // 2. 立即在桌面上应用更改
    applyCustomIcons();
    
    // 3. 刷新设置页面，让预览图也恢复默认
    renderIconSettings();

    alert(`“${appId}”的图标已恢复默认！`);
}
function handleIconFileSelect(appId, event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
        const imageUrl = e.target.result;
        document.getElementById(`preview-${appId}`).style.backgroundImage = `url('${imageUrl}')`;
        state.tempIconChanges[appId] = imageUrl;
    };
    reader.readAsDataURL(file);
}

function setIconFromUrl(appId) {
    const url = prompt('请输入图片的URL:');
    if (url) {
        document.getElementById(`preview-${appId}`).style.backgroundImage = `url('${url}')`;
        state.tempIconChanges[appId] = url;
    }
}

async function saveIconChanges() {
    Object.assign(state.customIcons, state.tempIconChanges);
    await db.settings.put({ key: 'customIcons', value: state.customIcons });
    applyCustomIcons();
    alert('图标已保存！');
    showScreen('new-main-settings-screen');
}

// [修复] 补全了之前因代码截断而丢失的函数体，这是导致所有按钮失效的根本原因。
function handleIconBack() {
    if (Object.keys(state.tempIconChanges).length > 0) {
        if (confirm('您有未保存的图标更改，要保存吗？')) {
            saveIconChanges();
        } else {
            state.tempIconChanges = {};
            showAppearanceSubPage('main');
        }
    } else {
        showAppearanceSubPage('main');
    }
}

function applyCustomIcons() {
    // 核心修复：更新“地址簿”，让它能找到所有地方的图标
    const appIconsQuery = '.app-cluster .app-icon, .app-grid .app-icon, .dock .app-icon, .settings-new-icon';
    document.querySelectorAll(appIconsQuery).forEach(app => {
        const appId = app.dataset.appid;
        if (!appId) return; // 忽略没有 appid 的图标

        const customIconUrl = state.customIcons[appId];
        if (customIconUrl) {
            app.style.backgroundImage = `url('${customIconUrl}')`;
            app.style.backgroundColor = 'transparent';
        } else {
            // 恢复默认图标的逻辑
            app.style.backgroundImage = ''; // 先清除行内样式
            // 对于那些用 style 直接写的图标（信息、微信），上面的代码已经足够
            // 对于用 CSS 变量定义的图标，我们需要确保 class 存在
            if (!app.classList.contains(`${appId}-icon`)) {
                app.classList.add(`${appId}-icon`);
            }
        }
    });
}// === 7. 世界书功能 (WorldBook Logic) ===
function renderWorldBookList() {
    const container = document.getElementById('worldbook-list-container');
    container.innerHTML = '';
    const booksByGroup = {};
    for (const bookId in state.worldBooks) {
        const book = state.worldBooks[bookId];
        const group = book.group || '默认分组';
        if (!booksByGroup[group]) booksByGroup[group] = [];
        booksByGroup[group].push(book);
    }

    if (Object.keys(booksByGroup).length === 0) {
        container.innerHTML = '<p class="placeholder-text">还没有世界书呢，快点击下方按钮添加一个吧！</p>';
        return;
    }

    const sortedGroups = Object.keys(booksByGroup).sort();
    for (const group of sortedGroups) {
        const details = document.createElement('details');
        
        // 修复核心：根据保存的状态来决定是否展开
        // 如果 state.worldBookCollapseState[group] 是 false，则不展开，否则默认展开
        details.open = state.worldBookCollapseState[group] !== false;

        // 新增功能：添加事件监听器，当用户点击展开或收起时，保存状态
        details.addEventListener('toggle', async (event) => {
            state.worldBookCollapseState[group] = event.target.open;
            await db.settings.put({ key: 'worldBookCollapseState', value: state.worldBookCollapseState });
        });

        const summary = document.createElement('summary');
        summary.className = 'worldbook-group-header';
        summary.innerHTML = `
            <span class="group-name-span">${group}</span>
            <div class="group-buttons">
                <button class="rename-group-btn" onclick="renameWorldBookGroup(event, '${group}')">重命名</button>
                <button class="delete-group-btn" onclick="deleteWorldBookGroup(event, '${group}')">删除</button>
            </div>
        `;
        
        details.appendChild(summary);

        booksByGroup[group].forEach(book => {
            const item = document.createElement('div');
            item.className = 'worldbook-item';
            item.innerHTML = `<h4>${book.title}</h4><p>${book.content.substring(0, 50)}...</p>`;
            item.onclick = () => openWorldBookEditor(book.id);
            details.appendChild(item);
        });

        container.appendChild(details);
    }
}

function openWorldBookEditor(bookId) {
    const titleInput = document.getElementById('worldbook-title-input');
    const contentInput = document.getElementById('worldbook-content-input');
    const editorTitle = document.getElementById('worldbook-editor-title');
    const groupSelect = document.getElementById('worldbook-group-select');
    
    groupSelect.innerHTML = '';
    state.worldBookGroups.forEach(group => {
        const option = document.createElement('option');
        option.value = group; option.textContent = group;
        groupSelect.appendChild(option);
    });
    groupSelect.innerHTML += '<option value="__new__">创建新分组...</option>';

    if (bookId && state.worldBooks[bookId]) {
        const book = state.worldBooks[bookId];
        titleInput.value = book.title;
        contentInput.value = book.content;
        groupSelect.value = book.group || '默认分组';
        editorTitle.textContent = '编辑世界书';
        state.currentEditingWorldBook = { id: bookId, originalTitle: book.title, originalContent: book.content, originalGroup: book.group };
    } else {
        titleInput.value = ''; contentInput.value = '';
        groupSelect.value = '默认分组';
        editorTitle.textContent = '添加世界书';
        state.currentEditingWorldBook = { id: null, originalTitle: '', originalContent: '', originalGroup: '默认分组' };
    }
    document.getElementById('new-group-container').style.display = 'none';
    document.getElementById('worldbook-new-group-input').value = '';
    showScreen('worldbook-editor-screen');
    initializeCustomSelect('.custom-select-wrapper');
}


async function saveWorldBook() {
    const title = document.getElementById('worldbook-title-input').value.trim();
    const content = document.getElementById('worldbook-content-input').value.trim();
    const groupSelect = document.getElementById('worldbook-group-select');
    let group = groupSelect.value;

    if (group === '__new__') {
        group = document.getElementById('worldbook-new-group-input').value.trim();
        if (!group) return alert('新分组名称不能为空哦！');
        if (!state.worldBookGroups.includes(group)) {
            state.worldBookGroups.push(group);
            await db.settings.put({ key: 'worldBookGroups', value: state.worldBookGroups });
        }
    }

    if (!title) return alert('设定名称不能为空哦！');
    
    const bookId = state.currentEditingWorldBook.id || `wb_${Date.now()}`;
    const bookData = { id: bookId, title, content, group };
    
    await db.worldBooks.put(bookData);
    state.worldBooks[bookId] = bookData;
    
    alert('保存成功！');
    renderWorldBookList();
    showScreen('worldbook-screen');
}

function handleWorldBookBack() {
    const { originalTitle, originalContent, originalGroup } = state.currentEditingWorldBook;
    const currentTitle = document.getElementById('worldbook-title-input').value;
    const currentContent = document.getElementById('worldbook-content-input').value;
    const currentGroup = document.getElementById('worldbook-group-select').value;

    if (currentTitle !== originalTitle || currentContent !== originalContent || currentGroup !== originalGroup) {
        if (confirm('您有未保存的更改，是否保存？')) saveWorldBook();
        else showScreen('worldbook-screen');
    } else showScreen('worldbook-screen');
}
// ✨✨✨ 全新的世界书分组管理魔法 ✨✨✨

// 魔法一：删除分组
async function deleteWorldBookGroup(event, groupName) {
    event.preventDefault(); // 阻止文件夹打开/关闭
    event.stopPropagation(); // 阻止其他点击事件

    if (groupName === '默认分组') {
        alert('“默认分组”是我们的基地，不能删除哦！');
        return;
    }

    const booksInGroup = Object.values(state.worldBooks).filter(book => book.group === groupName);
    
    let confirmationText = `真的要删除“${groupName}”这个分组吗？`;
    if (booksInGroup.length > 0) {
        confirmationText += `\n\n警告：这个分组里还有 ${booksInGroup.length} 个设定，它们会被移动到“默认分组”哦。`;
    }

    if (confirm(confirmationText)) {
        try {
            // 如果分组里有书，就先把它们搬家
            if (booksInGroup.length > 0) {
                for (const book of booksInGroup) {
                    book.group = '默认分组';
                    state.worldBooks[book.id] = book; // 更新内存
                    await db.worldBooks.put(book); // 更新数据库
                }
            }

            // 从分组列表里删除这个分组
            state.worldBookGroups = state.worldBookGroups.filter(g => g !== groupName);
            await db.settings.put({ key: 'worldBookGroups', value: state.worldBookGroups });

            alert(`分组“${groupName}”已删除！`);
            renderWorldBookList(); // 刷新列表，让它消失
        } catch (error) {
            console.error('删除分组失败:', error);
            alert('哎呀，删除失败了，请稍后再试。');
        }
    }
}

// ✨✨✨ 全新的、会智能悬浮的“召唤咒语” v2.0 ✨✨✨
// ✨✨✨ 究极进化版 v8.0：逻辑重塑的完美弹窗 ✨✨✨

// 这是我们的“清洁官”，它现在只负责一件事：关灯。
function hideCustomPrompt() {
    const backdrop = document.getElementById('custom-prompt-backdrop');
    backdrop.classList.remove('visible');
    // ✨ 为了保险，我们告诉它关灯后一定要把“悬浮”状态也取消掉。
    // 这样下次出来时，一定是干干净净的初始状态！
    setTimeout(() => {
        backdrop.classList.remove('prompt-lifted');
    }, 300); // 等动画播完再清理
}

// 这是我们的“召唤官”，它现在拥有了完美的逻辑！
function showCustomPrompt(title, defaultValue, onConfirm) {
    const backdrop = document.getElementById('custom-prompt-backdrop');
    const titleEl = document.getElementById('custom-prompt-title');
    const inputEl = document.getElementById('custom-prompt-input');
    const confirmBtn = document.getElementById('custom-prompt-confirm');
    const cancelBtn = document.getElementById('custom-prompt-cancel');

    // 1. 准备工作
    titleEl.textContent = title;
    inputEl.value = defaultValue;

    // 2. ✨✨✨ 究极魔法核心在这里！✨✨✨
    // 我们只在这里绑定一次“上浮”和“归位”的指令！
    // 这就完美解决了你发现的核心问题！

    // 3. 为按钮和背景板绑定“单次任务”
    confirmBtn.onclick = () => {
        onConfirm(inputEl.value);
        hideCustomPrompt();
    };

    cancelBtn.onclick = () => {
        hideCustomPrompt();
    };

    backdrop.onclick = (e) => {
        if (e.target === backdrop) {
            hideCustomPrompt();
        }
    };
    
    // 4. 最后：华丽登场！
    backdrop.classList.add('visible');
}

// 这是我们升级后的重命名函数！
async function renameWorldBookGroup(event, oldGroupName) {
    event.preventDefault();
    event.stopPropagation();

    if (oldGroupName === '默认分组') {
        alert('“默认分组”是我们的基地，不能改名字哦！');
        return;
    }

    // 召唤我们漂亮的弹窗！
    showCustomPrompt(
        "请输入世界书分组的新名字", // 这是你想要的文字！
        oldGroupName,
        async (newGroupName) => {
            // 下面的代码就是用户点击“确定”后才会执行的魔法
            if (newGroupName && newGroupName.trim() !== '' && newGroupName !== oldGroupName) {
                const trimmedNewName = newGroupName.trim();
                if (state.worldBookGroups.includes(trimmedNewName)) {
                    alert('这个名字已经存在啦，换一个吧！');
                    return;
                }

                try {
                    const booksToRename = Object.values(state.worldBooks).filter(book => book.group === oldGroupName);
                    for (const book of booksToRename) {
                        book.group = trimmedNewName;
                        state.worldBooks[book.id] = book;
                        await db.worldBooks.put(book);
                    }

                    const groupIndex = state.worldBookGroups.indexOf(oldGroupName);
                    if (groupIndex > -1) {
                        state.worldBookGroups[groupIndex] = trimmedNewName;
                    }
                    await db.settings.put({ key: 'worldBookGroups', value: state.worldBookGroups });

                    alert('重命名成功！');
                    renderWorldBookList();
                } catch (error) {
                    console.error('重命名分组失败:', error);
                    alert('哎呀，重命名失败了，请稍后再试。');
                }
            }
        }
    );
}

// === 8. 动态功能 (Dynamics Logic) ===
// === 【BUG修复】调整了函数执行顺序，确保页面打开后才渲染内容 ===
function openWriteDynamicScreen() {
    // 1. 先重置数据状态
    state.tempDynamicPost = { text: '', images: [], mentionedUserIds: [] };
    state.tempMentionSelection = [];
    
    // 2. 【核心】先打开页面！让HTML元素准备好！
    showScreen('write-dynamic-screen');

    // 3. 页面打开后，再安全地操作里面的元素
    document.getElementById('dynamic-textarea').value = '';
    renderDynamicImagePreviews(); // 现在“画图”就没问题了
    updatePublishButtonState();
}

// === 【BUG修复】更新了对多图的判断 ===
function closeWriteDynamicScreen() {
    const text = document.getElementById('dynamic-textarea').value.trim();
    // 【核心】从检查 .image 改为检查 .images.length
    const hasContent = text || state.tempDynamicPost.images.length > 0; 
    if (hasContent && !confirm('要舍弃正在编辑的内容吗？')) {
        return;
    }
    showScreen('chat-list-screen');
}
// === 【BUG修复】确保发布动态时，保存的是多图数组 ===
// === 【新增大脑】动态删除功能 ===
let targetDynamicId = null;

function showDynamicActionSheet(dynamicId) {
    targetDynamicId = dynamicId;
    // 我们复用聊天界面的 Action Sheet，非常环保！
    const backdrop = document.getElementById('message-action-sheet-backdrop');
    const sheet = document.getElementById('message-action-sheet');
    
    // 隐藏不需要的按钮
    document.getElementById('action-edit').style.display = 'none';
    document.getElementById('action-multi-select').style.display = 'none';
    
    // 修改删除按钮的行为
    const deleteBtn = document.getElementById('action-delete');
    // 先移除旧的监听器，防止重复触发
    deleteBtn.replaceWith(deleteBtn.cloneNode(true));
    // 重新获取并绑定新的事件
    document.getElementById('action-delete').addEventListener('click', deleteDynamicPost);

    backdrop.classList.add('visible');
    sheet.classList.add('visible');
}

async function deleteDynamicPost() {
    if (targetDynamicId === null) return;

    if (confirm('真的要删除这条动态吗？')) {
        // 1. 从数据库删除
        await db.dynamics.delete(targetDynamicId);

        // 2. 从内存(state)删除
        state.dynamics = state.dynamics.filter(post => post.id !== targetDynamicId);

        // 3. 重新渲染动态列表
        renderDynamicsPage();
    }

    // 隐藏菜单并重置状态
    hideActionSheet();
    targetDynamicId = null;
    
    // 把隐藏的按钮显示回来，以防影响聊天界面的使用
    setTimeout(() => {
        document.getElementById('action-edit').style.display = '';
        document.getElementById('action-multi-select').style.display = '';
    }, 300);
}
// === 【新增大脑】结束 ===
// === 【BUG修复】让动态列表能够显示九宫格图片 ===
// === 【带删除菜单版】让动态列表能够显示九宫格图片和删除按钮 ===
function renderDynamicsPage() {
    const container = document.getElementById('dynamics-list-container');
    container.innerHTML = '';

    document.getElementById('dynamics-user-avatar').src = state.userProfile.avatar || DEFAULT_USER_AVATAR;
    document.getElementById('dynamics-user-name').textContent = state.userProfile.name || 'user';

    if (state.dynamics.length === 0) {
        container.innerHTML = '<p class="placeholder-text">还没有动态，快来分享新鲜事吧！</p>';
        return;
    }

    state.dynamics.forEach(post => {
        // 注意：这里我们用 post.id 来确保每个动态的唯一性
        const author = post.authorId === 'user' ? state.userProfile : state.chats[post.authorId];
        if (!author) return;

        const postElement = document.createElement('div');
        postElement.className = 'dynamic-post-item';

        let contentHTML = post.content.replace(/@(\S+)/g, '<span class="mention">@$1</span>');
        
        let imageHTML = '';
        if (post.imageUrls && post.imageUrls.length > 0) {
            const imageElements = post.imageUrls.map(url => `<img src="${url}">`).join('');
            imageHTML = `<div class="post-images">${imageElements}</div>`;
        }

        // 【核心】在这里添加了 ... 按钮和 action-sheet 菜单
        postElement.innerHTML = `
            <div class="post-header">
                <img src="${author.avatar || (post.authorId === 'user' ? DEFAULT_USER_AVATAR : DEFAULT_AI_AVATAR)}" alt="avatar">
                <div class="post-author-info">
                    <p class="name">${author.name}</p>
                    <p class="timestamp">${formatTimestamp(post.timestamp)}</p>
                </div>
                <button class="post-more-btn" onclick="showDynamicActionSheet(${post.id})">
                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle></svg>
                </button>
            </div>
            <div class="post-content">
                <div class="text">${contentHTML}</div>
                ${imageHTML}
            </div>
            <div class="post-footer">
                <span class="device">${post.device || '月月小手机'}</span>
                <div class="post-actions">
                   <button>
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"></path></svg>
                    </button>
                    <button>
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                    </button>
                    <button>
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 1l4 4-4 4"></path><path d="M3 11V9a4 4 0 0 1 4-4h14"></path><path d="M7 23l-4-4 4-4"></path><path d="M21 13v2a4 4 0 0 1-4 4H3"></path></svg>
                    </button>
                </div>
            </div>
        `;
        container.appendChild(postElement);
    });
}

function formatTimestamp(ts) {
    const now = new Date();
    const date = new Date(ts);
    const diff = now - date;
    const diffMinutes = Math.floor(diff / 60000);
    const diffHours = Math.floor(diff / 3600000);
    const diffDays = Math.floor(diff / 86400000);

    if (diffMinutes < 1) return '刚刚';
    if (diffMinutes < 60) return `${diffMinutes}分钟前`;
    if (diffHours < 24 && now.getDate() === date.getDate()) return `今天 ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
    if (diffDays === 1 || (diffHours < 24 && now.getDate() !== date.getDate())) return `昨天 ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
    return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
}

// === 【Pro Max大脑升级】处理多图上传和预览 ===

// 新的大脑：处理多图选择
function handleDynamicImageUpload(event) {
    const files = Array.from(event.target.files);
    if (!files.length) return;

    const currentImageCount = state.tempDynamicPost.images.length;
    const remainingSlots = 9 - currentImageCount;

    if (remainingSlots <= 0) {
        alert('最多只能选择9张照片哦！');
        return;
    }

    const filesToProcess = files.slice(0, remainingSlots);

    filesToProcess.forEach(file => {
        const reader = new FileReader();
        reader.onload = e => {
            state.tempDynamicPost.images.push(e.target.result);
            renderDynamicImagePreviews(); // 每次读完一张就重新渲染
        };
        reader.readAsDataURL(file);
    });
    
    // 清空input的值，确保下次选择同一张图片也能触发
    event.target.value = ''; 
}

// 新的画家：根据图片数组画出九宫格
function renderDynamicImagePreviews() {
    const container = document.getElementById('dynamic-media-grid-container');
    container.innerHTML = ''; // 先清空画布
    const images = state.tempDynamicPost.images;

    images.forEach((imageUrl, index) => {
        const wrapper = document.createElement('div');
        wrapper.className = 'dynamic-image-preview-wrapper';
        wrapper.innerHTML = `
            <img src="${imageUrl}" alt="preview ${index + 1}">
            <button class="remove-image-btn" onclick="removeDynamicImage(${index})">×</button>
        `;
        container.appendChild(wrapper);
    });

    // 如果图片不到9张，就把“添加”按钮画在最后面
    if (images.length < 9) {
        const addBtnHTML = `
            <div class="add-photo-placeholder" onclick="document.getElementById('dynamic-image-upload').click()">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><path d="m21 15-5-5L5 21"></path></svg>
                <span>照片/视频</span>
            </div>
        `;
        container.innerHTML += addBtnHTML;
    }
    updatePublishButtonState(); // 更新“发表”按钮状态
}

// 新的橡皮擦：删除指定图片
function removeDynamicImage(index) {
    state.tempDynamicPost.images.splice(index, 1);
    renderDynamicImagePreviews(); // 删除后重新渲染
}
// 新增：打开 @ 面板的函数（终极纯净版）
function openMentionPanel() {
    state.tempMentionSelection = [];
    const container = document.getElementById('mention-list-container');
    container.innerHTML = '';
    const chats = Object.values(state.chats);

    chats.forEach(chat => {
    // ✨ 看这里！我们直接创建 <label>，不再有任何多余的 <div> 包裹！
    // 这就是我们说好的新裙子！
    const item = document.createElement('label');
    item.className = 'mention-list-item'; // 穿上专属的、绝对不会左右滑动的衣服！

    // 把复选框、头像、名字都放进去
    item.innerHTML = `
        <input type="checkbox" data-id="${chat.id}" data-name="${chat.name}">
        <img src="${chat.avatar || DEFAULT_AI_AVATAR}" alt="${chat.name}">
        <span>${chat.name}</span>
    `;
    container.appendChild(item);
});
    
    // 打开面板前，清空一下搜索框，防止上次的内容捣乱
    document.getElementById('mention-search-input').value = ''; 
    showScreen('mention-friends-panel');
}

// 新增：让 @ 面板的搜索框起作用的函数
function setupMentionSearch() {
    const searchInput = document.getElementById('mention-search-input');
    const container = document.getElementById('mention-list-container');

    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.trim().toLowerCase();
        const allItems = container.querySelectorAll('.mention-list-item');

        allItems.forEach(item => {
            const name = item.querySelector('span').textContent.toLowerCase();
            if (name.includes(searchTerm)) {
                item.style.display = ''; 
            } else {
                // 这是让不符合的人藏起来的咒语，保持不变
                item.style.display = 'none';
            }
        });
    });
}
// 新增：关闭 @ 面板的函数
function closeMentionPanel() {
    document.getElementById('mention-friends-panel').classList.remove('active');
}

// 新增：点击“完成”按钮后，把 @好友 添加到输入框的函数
function confirmMentionSelection() {
    const container = document.getElementById('mention-list-container');
    const selectedCheckboxes = container.querySelectorAll('input[type="checkbox"]:checked');
    const dynamicTextarea = document.getElementById('dynamic-textarea');

    let mentionText = '';
    selectedCheckboxes.forEach(checkbox => {
        mentionText += `@${checkbox.dataset.name} `;
    });

    // 把 @好友 的名字加到输入框里
    dynamicTextarea.value += mentionText;
    
    // 更新一下状态，让“发表”按钮能按
    state.tempDynamicPost.text = dynamicTextarea.value;
    updatePublishButtonState();

    // 最后，关掉面板
    closeMentionPanel();
}
// === 【BUG修复】更新了对多图的判断 ===
function updatePublishButtonState() {
    const text = document.getElementById('dynamic-textarea').value.trim();
    // 【核心】从检查 .image 改为检查 .images.length
    const hasContent = text || state.tempDynamicPost.images.length > 0;
    document.getElementById('publish-dynamic-btn').disabled = !hasContent;
}

function renderWorldBookLinkList() {
    const container = document.getElementById('worldbook-link-container');
    container.innerHTML = '';
    const booksByGroup = {};
    Object.values(state.worldBooks).forEach(book => {
        const group = book.group || '默认分组';
        if (!booksByGroup[group]) booksByGroup[group] = [];
        booksByGroup[group].push(book);
    });

    if (Object.keys(booksByGroup).length === 0) {
        container.innerHTML = '<p style="color: var(--text-secondary); font-size: 14px;">还没有世界书，快去添加吧！</p>';
        return;
    }

    const sortedGroups = Object.keys(booksByGroup).sort();
    sortedGroups.forEach(group => {
        const groupBooks = booksByGroup[group];
        const allInGroupSelected = groupBooks.every(book => state.tempChatSettings.linkedWorldBookIds.includes(book.id));
        const details = document.createElement('details');
        details.innerHTML = `
            <summary><div class="wb-link-group-header"><input type="checkbox" class="group-checkbox" data-group="${group}" ${allInGroupSelected ? 'checked' : ''}><span>${group}</span></div></summary>
            <div class="wb-link-item-list">${groupBooks.map(book => `<div class="wb-link-item"><label><input type="checkbox" class="item-checkbox" data-bookid="${book.id}" data-group="${group}" ${state.tempChatSettings.linkedWorldBookIds.includes(book.id) ? 'checked' : ''}>${book.title}</label></div>`).join('')}</div>`;
        container.appendChild(details);
    });

    container.querySelectorAll('.group-checkbox, .item-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', () => {
            const linkedIds = new Set();
            container.querySelectorAll('.item-checkbox:checked').forEach(cb => linkedIds.add(cb.dataset.bookid));
            state.tempChatSettings.linkedWorldBookIds = Array.from(linkedIds);
            renderWorldBookLinkList();
        });
    });
}

// === 9. 数据导入导出 ===
async function exportData() {
    try {
        const [allChats, allWorldBooks, allSettings, allDynamics] = await Promise.all([
            db.chats.toArray(),
            db.worldBooks.toArray(),
            db.settings.toArray(),
            db.dynamics.toArray()
        ]);

        const dataToExport = {
            chats: allChats,
            worldBooks: allWorldBooks,
            settings: allSettings,
            dynamics: allDynamics
        };

        const blob = new Blob([JSON.stringify(dataToExport, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `月月小手机_备份_${new Date().toLocaleString('sv').replace(/ /g,'_')}.json`;
        
        // ✨ 魔法在这里！✨
        document.body.appendChild(a); // 第一句咒语：把它放到页面上！
        a.click(); // 执行点击下载
        document.body.removeChild(a); // 第二句咒语：用完就扔，不留痕迹！
        
        URL.revokeObjectURL(url);
        alert('数据已成功导出！');
    } catch (error) {
        console.error('导出失败:', error);
        alert('数据导出失败，请检查控制台获取更多信息。');
    }
}

async function importData(event) {
    const file = event.target.files[0];
    if (!file) return;
    if (!confirm('导入数据将会覆盖当前所有聊天和设置，确定要继续吗？')) return;

    const reader = new FileReader();
    reader.onload = async (e) => {
        try {
            const data = JSON.parse(e.target.result);
            if (!data.chats || !data.settings) throw new Error('无效的备份文件格式。');

            await db.transaction('rw', db.chats, db.worldBooks, db.settings, db.dynamics, async () => {
                await db.chats.clear();
                await db.worldBooks.clear();
                await db.settings.clear();
                await db.dynamics.clear();

                await db.chats.bulkAdd(data.chats);
                if (data.worldBooks) await db.worldBooks.bulkAdd(data.worldBooks);
                await db.settings.bulkAdd(data.settings);
                if (data.dynamics) await db.dynamics.bulkAdd(data.dynamics);
            });
            alert('数据导入成功！页面即将刷新。');
            location.reload();
        } catch (error) {
            console.error('导入失败:', error);
            alert('数据导入失败！请确保文件格式正确。');
        }
    };
    reader.readAsText(file);
}// === 10. 初始化与事件监听 ===
async function initBattery() {
    const batteryTextEl = document.getElementById('battery-text');
    const batteryLevelEl = document.getElementById('battery-icon-level');
    if ('getBattery' in navigator) {
        try {
            const battery = await navigator.getBattery();
            const update = () => {
                const level = Math.floor(battery.level * 100);
                batteryTextEl.textContent = `${level}%`;
                batteryLevelEl.style.width = `${level}%`;
            };
            battery.addEventListener('levelchange', update);
            update();
        } catch (e) { batteryTextEl.textContent = '--%'; }
    } else batteryTextEl.textContent = '--%';
}
function setupContactSearch() {
    const searchInput = document.getElementById('contact-search-input');
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.trim().toLowerCase();
        const filteredChats = Object.values(state.chats).filter(chat => 
            chat.name.toLowerCase().includes(searchTerm)
        );
        renderContactsList(filteredChats);
    });
}

function setupMessageSearch() {
    const searchInput = document.getElementById('message-search-input');
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.trim().toLowerCase();
        const filteredChats = Object.values(state.chats).filter(chat => 
            chat.name.toLowerCase().includes(searchTerm)
        );
        renderChatList(filteredChats);
    });
}


async function init() {
    updateClock();
    setInterval(updateClock, 1000);

    await migrateFromLocalStorage();
    await loadStateFromDB();

    // [修复] 之前应用样式的代码已被移至<head>中的预加载脚本
    // 因此此处不再需要调用 applyWallpaper, applyFont, applyCustomIcons
    // 这确保了页面在首次渲染时就是最终样式，彻底消除闪烁

    // 渲染QQ界面内部的元素
    renderQqHeader();
    renderChatList();
    renderContactsList();
    renderWorldBookList();
    renderDynamicsPage();

    // 其他初始化
    initBattery();
    setupMessageSearch();
    setupMentionSearch();
    setupSkillSelector();
    setupMultiSelectActions();
    setupSettingsSearch();
    applyWidgetImages();
setupWidgetUploads();
    // --- 事件监听器 (这部分和原来一样，保持不变) ---
        document.getElementById('send-btn').addEventListener('mousedown', sendMessage);
    document.getElementById('receive-btn').addEventListener('click', getAiReply);
    const chatInput = document.getElementById('chat-input');
    chatInput.addEventListener('keypress', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });
        chatInput.addEventListener('input', function() { 
        this.style.height = 'auto'; 
        this.style.height = (this.scrollHeight) + 'px'; 
        
        // ✨ 新增的小侦探在这里！ ✨
        const inputArea = this.closest('.chat-input-area');
        if (this.value.trim().length > 0) {
            inputArea.classList.add('has-text');
        } else {
            inputArea.classList.remove('has-text');
        }
    });
    
    document.getElementById('wallpaper-input').addEventListener('change', async function(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = async function(e) {
                const url = e.target.result;
                await db.settings.put({ key: 'wallpaper', value: url });
                applyWallpaper(url); // 保留这里的调用，用于实时更换
                alert('壁纸已更换！');
            }
            reader.readAsDataURL(file);
        }
    });
    // ▼▼▼ 在这里添加新的代码 ▼▼▼
document.getElementById('lockscreen-wallpaper-input').addEventListener('change', async function(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = async function(e) {
            const url = e.target.result;
            // 把上传的图片存到手机记忆里
            await db.settings.put({ key: 'lockscreenWallpaper', value: url });
            // 使用专属魔法应用它
            applyLockscreenWallpaper(url);
            alert('锁屏壁纸已更换！');
        }
        reader.readAsDataURL(file);
    }
});

    document.getElementById('ai-avatar-upload').addEventListener('change', (event) => handleAvatarUpload(event, 'ai'));
    document.getElementById('user-avatar-upload').addEventListener('change', (event) => handleAvatarUpload(event, 'user'));
    document.getElementById('ai-name-input').addEventListener('input', (e) => state.tempChatSettings.name = e.target.value);
    document.getElementById('ai-persona-input').addEventListener('input', (e) => state.tempChatSettings.persona = e.target.value);
    document.getElementById('user-name-input').addEventListener('input', (e) => state.tempChatSettings.userName = e.target.value);
    document.getElementById('user-persona-input').addEventListener('input', (e) => state.tempChatSettings.userPersona = e.target.value);
    
    document.getElementById('chat-bg-upload').addEventListener('change', (e) => handleAppearanceUpload(e, 'background'));
    document.getElementById('summon-icon-upload').addEventListener('change', (e) => handleAppearanceUpload(e, 'summonIcon'));    
    document.getElementById('worldbook-group-select').addEventListener('change', function() {
        document.getElementById('new-group-container').style.display = this.value === '__new__' ? 'block' : 'none';
    });

const dynamicTextarea = document.getElementById('dynamic-textarea');
dynamicTextarea.addEventListener('input', (event) => { // ✨ 这里加了个 event
    state.tempDynamicPost.text = dynamicTextarea.value;
    updatePublishButtonState();

    // ✨ 这是新增的魔法！一个“小侦探”
    // 它会检查你刚刚输入的是不是“@”
    if (event.data === '@') {
        openMentionPanel(); // 如果是，就立刻打开好友列表！
    }
});

    document.getElementById('dynamic-image-upload').addEventListener('change', handleDynamicImageUpload);
    // === 【新增代码】修复iOS设置页更换壁纸和锁屏壁纸的功能 ===
document.getElementById('wallpaper-input').addEventListener('change', async function(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = async function(e) {
            const url = e.target.result;
            await db.settings.put({ key: 'wallpaper', value: url });
            
            // 找到预加载样式并更新，实现无刷新更换
            let preloadedStyles = document.getElementById('preloaded-styles');
            if (!preloadedStyles) {
                preloadedStyles = document.createElement('style');
                preloadedStyles.id = 'preloaded-styles';
                document.head.appendChild(preloadedStyles);
            }
            // 移除旧规则，添加新规则
            const rules = preloadedStyles.sheet.cssRules;
            for (let i = rules.length - 1; i >= 0; i--) {
                if (rules[i].selectorText === '#home-screen') {
                    preloadedStyles.sheet.deleteRule(i);
                }
            }
            preloadedStyles.sheet.insertRule(`#home-screen { background-image: url("${url}") !important; }`, preloadedStyles.sheet.cssRules.length);

            alert('主屏幕壁纸已更换！');
        }
        reader.readAsDataURL(file);
    }
});

document.getElementById('lockscreen-wallpaper-input').addEventListener('change', async function(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = async function(e) {
            const url = e.target.result;
            await db.settings.put({ key: 'lockscreenWallpaper', value: url });
            
            // 同样的方法，更新锁屏壁纸的预加载样式
            let preloadedStyles = document.getElementById('preloaded-styles');
             if (!preloadedStyles) {
                preloadedStyles = document.createElement('style');
                preloadedStyles.id = 'preloaded-styles';
                document.head.appendChild(preloadedStyles);
            }
            const rules = preloadedStyles.sheet.cssRules;
            for (let i = rules.length - 1; i >= 0; i--) {
                if (rules[i].selectorText === '#lock-screen') {
                    preloadedStyles.sheet.deleteRule(i);
                }
            }
            preloadedStyles.sheet.insertRule(`#lock-screen { background-image: url("${url}") !important; }`, preloadedStyles.sheet.cssRules.length);

            alert('锁屏壁纸已更换！');
        }
        reader.readAsDataURL(file);
    }
});
// === 【新增代码】修复结束 ===
}

// ▼▼▼ CEO专属 · 自定义下拉菜单驱动魔法 v6.1 ▼▼▼
function initializeCustomSelect(wrapperSelector) {
    const wrapper = document.querySelector(wrapperSelector);
    if (!wrapper) return;

    const originalSelect = wrapper.querySelector('select');
    const selectedDiv = wrapper.querySelector('.select-selected');
    const itemsDiv = wrapper.querySelector('.select-items');

    // 1. 根据原始select生成自定义列表
    itemsDiv.innerHTML = '';
    for (let i = 0; i < originalSelect.options.length; i++) {
        const option = originalSelect.options[i];
        const item = document.createElement('div');
        item.textContent = option.textContent;
        item.dataset.value = option.value;
        
        // 【用这段新代码替换】
if (option.value === originalSelect.value) {
    selectedDiv.textContent = option.textContent;
}

        item.addEventListener('click', function(e) {
            // 当点击一个选项时
            const value = e.target.dataset.value;
            originalSelect.value = value; // 更新隐藏的真身
            selectedDiv.textContent = e.target.textContent; // 更新假分身的外观
            closeAllSelects();
            // 手动触发一个change事件，以防有其他代码在监听它
            originalSelect.dispatchEvent(new Event('change'));
        });
        itemsDiv.appendChild(item);
    }

    // 2. 点击假分身时，开关列表
    selectedDiv.addEventListener('click', function(e) {
        e.stopPropagation();
        const isHidden = itemsDiv.classList.contains('select-hide');
        closeAllSelects();
        if (isHidden) {
            itemsDiv.classList.remove('select-hide');
            this.classList.add('select-arrow-active');
        }
    });
}

function closeAllSelects() {
    document.querySelectorAll('.select-items').forEach(el => el.classList.add('select-hide'));
    document.querySelectorAll('.select-selected').forEach(el => el.classList.remove('select-arrow-active'));
}

// 点击页面其他地方，关闭所有下拉菜单
document.addEventListener('click', closeAllSelects);
// ▲▲▲ 魔法激活代码 ▲▲▲
// === 11. 长按删除与多选功能 (Message Actions Logic) ===
let targetMessageId = null;

function showActionSheet(messageId) {
    targetMessageId = messageId;
    document.getElementById('message-action-sheet-backdrop').classList.add('visible');
    document.getElementById('message-action-sheet').classList.add('visible');
}

function hideActionSheet() {
    document.getElementById('message-action-sheet-backdrop').classList.remove('visible');
    document.getElementById('message-action-sheet').classList.remove('visible');
    setTimeout(() => {
        // 等动画播完再隐藏，防止闪烁
        document.getElementById('message-action-sheet-backdrop').style.display = 'none';
    }, 300);
}

// 删除单条消息
async function deleteSingleMessage() {
    if (targetMessageId === null) return;
    const chatId = state.activeChatId;
    const chat = state.chats[chatId];
    
    // 从历史记录中移除。注意：messageId就是index
    chat.history.splice(targetMessageId, 1);
    
    // 更新数据库
    await db.chats.update(chatId, { history: chat.history });
    
    // 重新渲染聊天界面
    openChat(chatId);
    hideActionSheet();
    targetMessageId = null;
}

function enterMultiSelectMode() {
    hideActionSheet();
    state.isMultiSelectMode = true;
    state.multiSelectedMessages.clear();
    
    // ✨ 新的魔法在这里！ ✨
    document.getElementById('multi-select-bar').style.display = 'flex';
    document.getElementById('multi-select-header').style.display = 'flex'; // 显示新的标题栏
    document.querySelector('#chat-screen .header').style.display = 'none'; // 隐藏旧的标题栏
    
    updateMultiSelectTitle(); // 更新标题文字

    document.querySelectorAll('.message-wrapper').forEach(el => {
        el.classList.add('multi-select-mode');
    });
}

function exitMultiSelectMode() {
    state.isMultiSelectMode = false;
    state.multiSelectedMessages.clear();
    
    // ✨ 新的魔法在这里！ ✨
    document.getElementById('multi-select-bar').style.display = 'none';
    document.getElementById('multi-select-header').style.display = 'none'; // 隐藏新的标题栏
    document.querySelector('#chat-screen .header').style.display = 'flex'; // 恢复旧的标题栏

    document.querySelectorAll('.message-wrapper').forEach(el => {
        el.classList.remove('multi-select-mode');
    });
    // 重新渲染以清除勾选状态
    openChat(state.activeChatId);
}

function toggleMessageSelection(messageId) {
    const id = parseInt(messageId);
    const checkbox = document.querySelector(`.message-wrapper[data-message-id='${id}'] .multi-select-checkbox`);
    if (state.multiSelectedMessages.has(id)) {
        state.multiSelectedMessages.delete(id);
        checkbox.classList.remove('checked');
    } else {
        state.multiSelectedMessages.add(id);
        checkbox.classList.add('checked');
    }
    updateMultiSelectTitle(); // ✨ 就是加上这一行！
}

// 删除所有选中的消息
async function deleteSelectedMessages() {
    if (state.multiSelectedMessages.size === 0) return;
    const chatId = state.activeChatId;
    const chat = state.chats[chatId];

    // 从后往前删，防止索引错乱
    const sortedIds = Array.from(state.multiSelectedMessages).sort((a, b) => b - a);
    sortedIds.forEach(id => {
        chat.history.splice(id, 1);
    });

    await db.chats.update(chatId, { history: chat.history });
    
    exitMultiSelectMode();
    // 这里直接调用openChat重新渲染整个列表
    openChat(chatId);
}
// ====== 月月的锁屏魔法区域开始 ======

// 1. 先找到我们在 HTML 里创建的那些元素
const lockScreen = document.getElementById('lock-screen');
const lockScreenTime = document.getElementById('lock-screen-time');
const lockScreenDate = document.getElementById('lock-screen-date');

// 2. 一个让时间和日期动起来的函数
function updateLockScreenTime() {
    const now = new Date();
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    
    const year = now.getFullYear();
    const month = now.getMonth() + 1; // 月份是从0开始的，要加1
    const day = now.getDate();
    const week = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'][now.getDay()];

    lockScreenTime.textContent = `${hours}:${minutes}`;
    lockScreenDate.textContent = `${month}月${day}日 ${week}`;
}

// 3. 上滑解锁的魔法！
let touchStartY = 0; // 记录手指按下的初始位置

lockScreen.addEventListener('touchstart', (event) => {
    // 手指摸到屏幕时，记下它的Y坐标
    touchStartY = event.touches[0].clientY;
});

lockScreen.addEventListener('touchend', (event) => {
    const touchEndY = event.changedTouches[0].clientY;
    const swipeDistance = touchEndY - touchStartY;
    
    if (swipeDistance < -50) {
        // 检查锁屏功能是否开启
        if (!state.lockScreenSettings.isEnabled) {
            // 如果没开启，直接解锁
            unlockPhone();
            return;
        }

        // 检查是否设置了密码
        if (state.lockScreenSettings.passcode) {
            // 如果有密码，显示密码输入界面
            lockScreen.style.transform = 'translateY(-100%)';
            showPasscodeScreen();
        } else {
            // 如果没密码，直接解锁
            unlockPhone();
        }
    }
});

// 创建一个通用的解锁函数
function unlockPhone() {
    lockScreen.style.transform = 'translateY(-100%)';
    setTimeout(() => {
        lockScreen.style.display = 'none';
    }, 300);
    showScreen('home-screen');
}


// 4. 让时间和日期每秒都更新一次，并且刚打开页面就立刻执行一次
updateLockScreenTime(); // 立即执行一次，防止刚打开没时间
setInterval(updateLockScreenTime, 1000); // 然后每秒更新

// ====== 月月的锁屏魔法区域结束 ======
// ▼▼▼ 【全新】桌面小组件功能区 ▼▼▼

// 应用保存的图片到小组件背景
function applyWidgetImages() {
    const images = state.widgetImages;
    if (images.top) {
        document.getElementById('widget-top').style.backgroundImage = `url('${images.top}')`;
    }
    if (images.middle) {
        document.getElementById('widget-middle').style.backgroundImage = `url('${images.middle}')`;
    }
    if (images.bottom) {
        document.getElementById('widget-bottom').style.backgroundImage = `url('${images.bottom}')`;
    }
}

// 处理图片上传的通用函数
function handleWidgetImageUpload(event, widgetKey) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = async (e) => {
        const imageUrl = e.target.result;
        // 1. 实时更新界面
        document.getElementById(`widget-${widgetKey}`).style.backgroundImage = `url('${imageUrl}')`;
        // 2. 更新 state
        state.widgetImages[widgetKey] = imageUrl;
        // 3. 保存到数据库
        await db.settings.put({ key: 'widgetImages', value: state.widgetImages });
    };
    reader.readAsDataURL(file);
    // 清空input的值，确保下次选择同一张图片也能触发change事件
    event.target.value = '';
}

// 绑定所有小组件的上传事件
function setupWidgetUploads() {
    document.getElementById('widget-top-input').addEventListener('change', (e) => handleWidgetImageUpload(e, 'top'));
    document.getElementById('widget-middle-input').addEventListener('change', (e) => handleWidgetImageUpload(e, 'middle'));
    document.getElementById('widget-bottom-input').addEventListener('change', (e) => handleWidgetImageUpload(e, 'bottom'));
}

// ▲▲▲ 功能区结束 ▲▲▲
// ====== 密码输入界面魔法区域开始 ======
const kaomojiList = ['૮ ///▽/// ა', '^ω^', 'ฅ●ω●ฅ', '(ㅎ‸ㅎ)', '(つд⊂)', '(๑•̀ㅂ•́)و✧', '(*ﾟ▽ﾟ*)','(>▽<)'];
let isCheckingPasscode = false; // 防止重复检查密码

// 显示密码输入界面
function showPasscodeScreen() {
    const passcodeScreen = document.getElementById('passcode-screen');
    // --- 新增：随机设置颜文字 ---
const kaomojiSpan = document.getElementById('passcode-kaomoji');
if (kaomojiSpan) {
    const randomKaomoji = kaomojiList[Math.floor(Math.random() * kaomojiList.length)];
    kaomojiSpan.textContent = randomKaomoji;
}
// --- 新增结束 ---
    passcodeScreen.style.display = 'block';
    state.enteredPasscode = '';
    updatePasscodeDots();
    document.getElementById('passcode-prompt').textContent = '输入密码';
    document.getElementById('passcode-dots').classList.remove('shake');
}

// 隐藏密码输入界面
function hidePasscodeScreen() {
    document.getElementById('passcode-screen').style.display = 'none';
}

// 处理数字键盘点击
function handlePasscodeKeyPress(digit) {
    const requiredLength = state.lockScreenSettings.passcode.length;
    if (isCheckingPasscode || state.enteredPasscode.length >= requiredLength) return;
    state.enteredPasscode += digit;
    updatePasscodeDots();

    if (state.enteredPasscode.length === requiredLength) {
        checkPasscode();
    }
}

// 更新密码圆点的显示
function updatePasscodeDots() {
    const dots = document.querySelectorAll('#passcode-dots .dot');
    dots.forEach((dot, index) => {
        dot.classList.toggle('filled', index < state.enteredPasscode.length);
    });
}

function checkPasscode() {
    isCheckingPasscode = true;
    setTimeout(() => {
        // 使用 state 中存储的密码进行对比
        if (state.enteredPasscode === state.lockScreenSettings.passcode.code) {
            // 密码正确
            hidePasscodeScreen();
            setTimeout(() => {
                unlockPhone();
            }, 100);
        } else {
            // 密码错误
            const dotsContainer = document.getElementById('passcode-dots');
            document.getElementById('passcode-prompt').textContent = '请重试';
            dotsContainer.classList.add('shake');
            
            setTimeout(() => {
                dotsContainer.classList.remove('shake');
                state.enteredPasscode = '';
                updatePasscodeDots();
            }, 500);
        }
        isCheckingPasscode = false;
    }, 200);
}

// 返回锁屏
function returnToLockScreen() {
    hidePasscodeScreen();
    lockScreen.style.transform = 'translateY(0)'; // 让锁屏滑回来
}

// ====== 密码输入界面魔法区域结束 ======
// ====== 锁屏密码设置功能区开始 ======

function openLockScreenSettings() {
    renderLockScreenSettingsPage();
    showScreen('new-lock-screen-settings-screen');
}

function renderLockScreenSettingsPage() {
    const settings = state.lockScreenSettings;
    document.getElementById('lock-screen-enabled-toggle').checked = settings.isEnabled;
    document.getElementById('passcode-enabled-toggle').checked = !!settings.passcode;
    
    // 只有在“开启锁屏”和“开启密码”都勾选时，才显示“更改密码”
    const changePasscodeGroup = document.getElementById('change-passcode-group');
    changePasscodeGroup.style.display = (settings.isEnabled && settings.passcode) ? 'block' : 'none';
}

async function toggleLockScreen(isChecked) {
    state.lockScreenSettings.isEnabled = isChecked;
    await db.settings.put({ key: 'lockScreenSettings', value: state.lockScreenSettings });
    renderLockScreenSettingsPage(); // 重新渲染以更新“更改密码”按钮的可见性
}

async function togglePasscode(isChecked) {
    if (isChecked) {
        // 如果是开启密码，则开始设置流程
        promptPasscodeLength();
    } else {
        // 如果是关闭密码
        state.lockScreenSettings.passcode = null;
        await db.settings.put({ key: 'lockScreenSettings', value: state.lockScreenSettings });
        renderLockScreenSettingsPage();
    }
}

function promptPasscodeLength() {
    const choice = prompt("请选择密码长度：\n1. 四位数\n2. 六位数", "1");
    if (choice === '1') {
        openSetPasscodePanel(4);
    } else if (choice === '2') {
        openSetPasscodePanel(6);
    } else {
        // 如果用户取消或输入无效，则把开关拨回去
        document.getElementById('passcode-enabled-toggle').checked = false;
    }
}

function openSetPasscodePanel(length) {
    state.tempSetPasscode = { stage: 'new', length: length, firstEntry: '', entered: '' };
    
    const dotsContainer = document.getElementById('set-passcode-dots');
    const numpadContainer = document.getElementById('set-passcode-numpad');
    dotsContainer.innerHTML = '';
    numpadContainer.innerHTML = '';

    for (let i = 0; i < length; i++) {
        dotsContainer.innerHTML += '<span class="dot"></span>';
    }

    const keys = ['1', '2', '3', '4', '5', '6', '7', '8', '9', '', '0', ''];
    keys.forEach(key => {
        if (key === '') {
            numpadContainer.innerHTML += '<div></div>';
        } else {
            numpadContainer.innerHTML += `<button class="passcode-key" onclick="handleSetPasscodeKeyPress('${key}')">${key}</button>`;
        }
    });

    document.getElementById('set-passcode-prompt').textContent = '输入新密码';
    document.getElementById('set-passcode-panel').classList.add('active');
}

function closeSetPasscodePanel() {
    document.getElementById('set-passcode-panel').classList.remove('active');
    renderLockScreenSettingsPage(); // 刷新主设置页的开关状态
}

function updateSetPasscodeDots() {
    const dots = document.querySelectorAll('#set-passcode-dots .dot');
    dots.forEach((dot, index) => {
        dot.classList.toggle('filled', index < state.tempSetPasscode.entered.length);
    });
}

async function handleSetPasscodeKeyPress(digit) {
    const temp = state.tempSetPasscode;
    if (temp.entered.length >= temp.length) return;

    temp.entered += digit;
    updateSetPasscodeDots();

    if (temp.entered.length === temp.length) {
        if (temp.stage === 'new') {
            // 第一次输入完成
            temp.firstEntry = temp.entered;
            temp.stage = 'confirm';
            temp.entered = '';
            document.getElementById('set-passcode-prompt').textContent = '请再次输入以确认';
            setTimeout(updateSetPasscodeDots, 200); // 延迟清空圆点
        } else if (temp.stage === 'confirm') {
            // 第二次输入完成
            if (temp.entered === temp.firstEntry) {
                // 两次输入一致，保存密码
                state.lockScreenSettings.passcode = {
                    length: temp.length,
                    code: temp.firstEntry
                };
                await db.settings.put({ key: 'lockScreenSettings', value: state.lockScreenSettings });
                alert('密码设置成功！');
                closeSetPasscodePanel();
            } else {
                // 两次输入不一致
                document.getElementById('set-passcode-prompt').textContent = '密码不匹配，请重新输入';
                temp.stage = 'new';
                temp.entered = '';
                temp.firstEntry = '';
                setTimeout(updateSetPasscodeDots, 500);
            }
        }
    }
}
// ====== 锁屏密码设置功能区结束 ======
// === 绑定长按菜单的按钮事件 ===
document.getElementById('action-delete').addEventListener('click', deleteSingleMessage);
document.getElementById('action-multi-select').addEventListener('click', enterMultiSelectMode);
document.getElementById('action-cancel').addEventListener('click', hideActionSheet);
document.getElementById('message-action-sheet-backdrop').addEventListener('click', hideActionSheet);
document.getElementById('multi-select-delete-btn').addEventListener('click', deleteSelectedMessages);

// ✨ "编辑" 功能暂未实现，给一个提示
document.getElementById('action-edit').addEventListener('click', () => {
    alert('“编辑”功能正在开发中，敬请期待哦~');
    hideActionSheet();
});
// ✨ 绑定头像形状按钮的点击事件
document.querySelectorAll('.shape-btn').forEach(btn => {
    btn.addEventListener('click', () => handleShapeButtonClick(btn.dataset.shape));
});
// ▼▼▼ 五子棋游戏逻辑 (最终智慧情感版) ▼▼▼
const gobangState = {
    board: [], currentPlayer: 1, gameActive: false, isGameOver: false,
    history: [], timerInterval: null, timeLeft: 30, boardSize: 15,
    turnCount: 0, currentOpponent: null, isLettingUserWin: false,
    chatHistory: [], // 新增：用于存储当局聊天记录
    players: { self: { id: 2 }, opponent: { id: 1 } },
    currentSkillLevel: 1.0,
};

function initGobangGame() {
    if (!document.getElementById('gobang-start-btn').dataset.initialized) {
        console.log("Initializing Gobang Game for the first time.");
        document.getElementById('gobang-start-btn').addEventListener('click', startGobangGame);
        // 修改6：新对局按钮直接重置当前棋局
        document.getElementById('gobang-new-game-btn').addEventListener('click', resetGobangGame); 
        document.getElementById('gobang-undo-btn').addEventListener('click', undoGobangMove);
        document.getElementById('gobang-send-chat-btn').addEventListener('click', sendGobangMessage);
        document.getElementById('gobang-chat-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') sendGobangMessage(); });
        document.getElementById('gobang-board-svg').addEventListener('click', handleBoardClick);
        document.getElementById('gobang-start-btn').dataset.initialized = 'true';
    }
    document.getElementById('gobang-user-avatar').src = state.userProfile.avatar || DEFAULT_USER_AVATAR;
    const userNameDisplay = document.getElementById('gobang-user-name-display');
    gobangState.players.self.name = state.userProfile.name || '你';
    userNameDisplay.textContent = gobangState.players.self.name;
    showFriendSelectScreen();
}

function showFriendSelectScreen() {
    const friendListDiv = document.getElementById('gobang-friend-list');
    friendListDiv.innerHTML = ''; 
    const chats = Object.values(state.chats);
    
    // ✨ 五子棋列表也学会了“置顶优先”！✨
    const sortedChats = chats.sort((a, b) => {
        if (a.isPinned && !b.isPinned) return -1;
        if (!a.isPinned && b.isPinned) return 1;
        // 如果置顶状态相同，则按名字排序
        return a.name.localeCompare(b.name, 'zh-CN');
    });

    if (sortedChats.length === 0) {
        friendListDiv.innerHTML = '<p class="placeholder-text">还没有好友哦，快去QQ里添加一个吧！</p>';
    } else {
        sortedChats.forEach(chat => {
            const friendItem = document.createElement('div');
            friendItem.className = 'gobang-friend-item';
            // ✨ 如果是置顶VIP，就给他打上标记！
            if (chat.isPinned) {
                friendItem.classList.add('pinned');
            }
            friendItem.innerHTML = `<img src="${chat.avatar || DEFAULT_AI_AVATAR}" alt="${chat.name}"><p>${chat.name}</p>`;
            friendItem.onclick = () => selectOpponentAndStart(chat.id);
            friendListDiv.appendChild(friendItem);
        });
    }
    showScreen('gobang-friend-select-screen');
}

function selectOpponentAndStart(chatId) {
    gobangState.currentOpponent = state.chats[chatId];
    const opponentAvatar = document.querySelector('#gobang-opponent-info .gobang-avatar');
    const opponentName = document.querySelector('#gobang-opponent-info .gobang-player-name');
    opponentAvatar.src = gobangState.currentOpponent.avatar || DEFAULT_AI_AVATAR;
    opponentName.textContent = gobangState.currentOpponent.name;
    gobangState.players.opponent.name = gobangState.currentOpponent.name;

    // --- ✨ 新增的魔法在这里 ✨ ---
    const userDefinedSkill = gobangState.currentOpponent.skillLevels?.gobang;
    const skillMap = { 'novice': 0.5, 'average': 1.0, 'expert': 1.5 };

    if (userDefinedSkill && userDefinedSkill !== 'auto') {
        gobangState.currentSkillLevel = skillMap[userDefinedSkill];
        console.log(`User defined skill: ${userDefinedSkill} (${gobangState.currentSkillLevel})`);
    } else {
        // 如果是auto，就设为null，让AI自己判断
        gobangState.currentSkillLevel = null;
        console.log("Skill set to auto. AI will self-assess.");
    }
    // --- 魔法结束 ---

    resetGobangGame(); 
    showScreen('gobang-screen');
}

function drawGobangBoard() {
    const svg = document.getElementById('gobang-board-svg'); svg.innerHTML = ''; const boardSize = gobangState.boardSize;
    const padding = 30; const cellSize = (600 - 2 * padding) / (boardSize - 1);
    for (let i = 0; i < boardSize; i++) {
        const hLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        hLine.setAttribute('x1', padding); hLine.setAttribute('y1', padding + i * cellSize); hLine.setAttribute('x2', 600 - padding); hLine.setAttribute('y2', padding + i * cellSize);
        hLine.classList.add('board-line'); svg.appendChild(hLine);
        const vLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        vLine.setAttribute('x1', padding + i * cellSize); vLine.setAttribute('y1', padding); vLine.setAttribute('x2', padding + i * cellSize); vLine.setAttribute('y2', 600 - padding);
        vLine.classList.add('board-line'); svg.appendChild(vLine);
    }
    const starPoints = [[3, 3], [11, 3], [3, 11], [11, 11], [7, 7]];
    starPoints.forEach(([x, y]) => {
        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle.setAttribute('cx', padding + x * cellSize); circle.setAttribute('cy', padding + y * cellSize);
        circle.setAttribute('r', 5); circle.classList.add('star-point'); svg.appendChild(circle);
    });
}

function resetGobangGame() {
    if (!gobangState.currentOpponent) { showFriendSelectScreen(); return; }
    gobangState.board = Array(gobangState.boardSize).fill(0).map(() => Array(gobangState.boardSize).fill(0));
    gobangState.currentPlayer = 1; gobangState.gameActive = false; gobangState.isGameOver = false;
    gobangState.history = []; gobangState.turnCount = 0; gobangState.isLettingUserWin = false;
    gobangState.chatHistory = []; // 重置聊天记录
    stopTimer(); resetTimerDisplay();
    document.getElementById('gobang-undo-btn').disabled = true;
    document.getElementById('gobang-game-overlay').classList.remove('hidden');
    document.getElementById('gobang-start-btn').style.display = 'block';
    document.getElementById('gobang-game-status').textContent = '准备好了吗？';
    drawGobangBoard(); clearGobangChat();
    addSystemMessage(`与 ${gobangState.currentOpponent.name} 的新对局`);
}

function startGobangGame() {
    gobangState.gameActive = true; gobangState.isGameOver = false;
    document.getElementById('gobang-game-overlay').classList.add('hidden');
    addSystemMessage('对局开始，黑方先行'); startTurn();
}
function startTurn() {
    if (gobangState.isGameOver) return;
    gobangState.timeLeft = 30;
    updateActivePlayerUI();
    stopTimer();
    gobangState.timerInterval = setInterval(updateTimer, 1000);
    
    const isOpponentTurn = gobangState.currentPlayer === gobangState.players.opponent.id;
    const boardSVG = document.getElementById('gobang-board-svg');
    const undoBtn = document.getElementById('gobang-undo-btn');

    if (isOpponentTurn) {
        boardSVG.style.pointerEvents = 'none';
        undoBtn.disabled = true; 
        const thinkingTime = 3500 + Math.random() * 2500;
        setTimeout(makeOpponentMove, thinkingTime);
    } else {
        boardSVG.style.pointerEvents = 'auto';
        undoBtn.disabled = gobangState.history.length < 2; 
    }
}

function stopTimer() { clearInterval(gobangState.timerInterval); gobangState.timerInterval = null; }

function updateTimer() {
    gobangState.timeLeft--; updateTimerDisplay();
    if (gobangState.timeLeft <= 0) { stopTimer(); addSystemMessage(`${gobangState.currentPlayer === 1 ? '黑方' : '白方'} 超时`); switchPlayer(); }
}

function updateActivePlayerUI() {
    const selfInfo = document.getElementById('gobang-self-info'); const opponentInfo = document.getElementById('gobang-opponent-info');
    if (gobangState.currentPlayer === gobangState.players.self.id) { selfInfo.classList.add('active'); opponentInfo.classList.remove('active'); } 
    else { selfInfo.classList.remove('active'); opponentInfo.classList.add('active'); }
    updateTimerDisplay(true);
}

function updateTimerDisplay(reset = false) {
    const selfTimer = document.getElementById('gobang-self-timer'); const opponentTimer = document.getElementById('gobang-opponent-timer');
    const circumference = 188.5; if(reset) { selfTimer.style.strokeDashoffset = circumference; opponentTimer.style.strokeDashoffset = circumference; return; }
    const offset = circumference * (1 - gobangState.timeLeft / 30);
    if (gobangState.currentPlayer === gobangState.players.self.id) { selfTimer.style.strokeDashoffset = offset; opponentTimer.style.strokeDashoffset = 0; } 
    else { opponentTimer.style.strokeDashoffset = offset; selfTimer.style.strokeDashoffset = 0; }
}

function resetTimerDisplay() {
    const selfTimer = document.getElementById('gobang-self-timer'); const opponentTimer = document.getElementById('gobang-opponent-timer');
    const circumference = 188.5; selfTimer.style.strokeDashoffset = circumference; opponentTimer.style.strokeDashoffset = circumference;
    document.getElementById('gobang-self-info').classList.remove('active'); document.getElementById('gobang-opponent-info').classList.remove('active');
}

function handleBoardClick(e) {
    if (gobangState.currentPlayer !== gobangState.players.self.id) return;
    if (!gobangState.gameActive || gobangState.isGameOver) return;
    const svg = e.currentTarget; const boardSize = gobangState.boardSize; const padding = 30;
    const cellSize = (600 - 2 * padding) / (boardSize - 1); const rect = svg.getBoundingClientRect();
    const scale = 600 / rect.width; const x = (e.clientX - rect.left) * scale; const y = (e.clientY - rect.top) * scale;
    const col = Math.round((x - padding) / cellSize); const row = Math.round((y - padding) / cellSize);
    if (col >= 0 && col < boardSize && row >= 0 && row < boardSize && gobangState.board[row][col] === 0) { placePiece(row, col); }
}

function placePiece(row, col, isUndo = false) {
    gobangState.board[row][col] = gobangState.currentPlayer;
    const pieceColor = gobangState.currentPlayer === 1 ? 'var(--gobang-black)' : 'var(--gobang-white)';
    const svg = document.getElementById('gobang-board-svg'); const padding = 30; const cellSize = (600 - 2 * padding) / (gobangState.boardSize - 1);
    const pieceRadius = cellSize / 2 * 0.9; const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    circle.setAttribute('cx', padding + col * cellSize); circle.setAttribute('cy', padding + row * cellSize); circle.setAttribute('r', pieceRadius); circle.setAttribute('fill', pieceColor);
    circle.classList.add('board-piece'); circle.dataset.row = row; circle.dataset.col = col; svg.appendChild(circle);
    document.querySelector('.last-move-marker')?.remove(); const marker = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    marker.setAttribute('cx', padding + col * cellSize); marker.setAttribute('cy', padding + row * cellSize); marker.setAttribute('r', pieceRadius * 0.5); marker.classList.add('last-move-marker'); svg.appendChild(marker);
    if (!isUndo) {
        gobangState.turnCount++; gobangState.history.push({ row, col, player: gobangState.currentPlayer });
        
        if (checkWin(row, col)) { endGame(gobangState.currentPlayer); } 
        else if (gobangState.turnCount === gobangState.boardSize * gobangState.boardSize) { endGame(0); } 
        else { switchPlayer(); }
    }
}

function checkWin(row, col) {
    const player = gobangState.board[row][col]; if (player === 0) return false;
    const directions = [[1, 0], [0, 1], [1, 1], [1, -1]];
    for (const [dr, dc] of directions) {
        let count = 1;
        for (let i = 1; i < 5; i++) { const r = row + i * dr; const c = col + i * dc; if (r >= 0 && r < gobangState.boardSize && c >= 0 && c < gobangState.boardSize && gobangState.board[r][c] === player) count++; else break; }
        for (let i = 1; i < 5; i++) { const r = row - i * dr; const c = col - i * dc; if (r >= 0 && r < gobangState.boardSize && c >= 0 && c < gobangState.boardSize && gobangState.board[r][c] === player) count++; else break; }
        if (count >= 5) return true;
    }
    return false;
}

function switchPlayer() { gobangState.currentPlayer = gobangState.currentPlayer === 1 ? 2 : 1; startTurn(); }

async function endGame(winner) {
    stopTimer();
    gobangState.gameActive = false;
    gobangState.isGameOver = true;
    document.getElementById('gobang-undo-btn').disabled = true;

    const overlay = document.getElementById('gobang-game-overlay');
    const statusText = document.getElementById('gobang-game-status');
    const startBtn = document.getElementById('gobang-start-btn');

    let resultText = '';
    let gameResultForAI = '';

    if (winner === 0) {
        statusText.textContent = '平局！';
        addSystemMessage('对局结束，平局');
        resultText = `刚刚我和 ${gobangState.players.self.name} 下了一局五子棋，结果是平局。`;
        gameResultForAI = 'draw';
    } else {
        const isOpponentWinner = winner === gobangState.players.opponent.id;
        const winnerName = isOpponentWinner ? gobangState.players.opponent.name : gobangState.players.self.name;
        statusText.textContent = `${winnerName} 胜利!`;
        addSystemMessage(`对局结束, ${winnerName} 胜利!`);

        if (isOpponentWinner) {
            resultText = `刚刚我和 ${gobangState.players.self.name} 下了一局五子棋，我赢了。`;
            gameResultForAI = 'win';
        } else {
            resultText = `刚刚我和 ${gobangState.players.self.name} 下了一局五子棋，我输了。`;
            gameResultForAI = 'lose';
        }
    }

    try {
        const opponentChatId = gobangState.currentOpponent.id;
        if (state.chats[opponentChatId]) {
            const chat = state.chats[opponentChatId];
            chat.history.push({ role: 'assistant', content: resultText });
            await db.chats.update(opponentChatId, { history: chat.history });
            console.log(`已将五子棋结果存入 ${opponentChatId} 的聊天记录`);
        }
    } catch (error) {
        console.error('保存五子棋结果失败:', error);
    }
    
    triggerEndOfGameReply(gameResultForAI);

    startBtn.style.display = 'none';
    overlay.classList.remove('hidden');
}

function undoGobangMove() {
    if (gobangState.history.length < 2 || gobangState.isGameOver) {
        return;
    }

    const removeLastPiece = () => {
        const move = gobangState.history.pop();
        if (move) {
            gobangState.board[move.row][move.col] = 0;
            const pieceToRemove = document.querySelector(`.board-piece[data-row='${move.row}'][data-col='${move.col}']`);
            pieceToRemove?.remove();
        }
    };

    removeLastPiece();
    removeLastPiece();

    gobangState.turnCount -= 2;

    gobangState.currentPlayer = gobangState.players.self.id;

    document.querySelector('.last-move-marker')?.remove();
    const prevMove = gobangState.history[gobangState.history.length - 1];
    if(prevMove) {
        const svg = document.getElementById('gobang-board-svg');
        const padding = 30;
        const cellSize = (600 - 2 * padding) / (gobangState.boardSize - 1);
        const pieceRadius = cellSize / 2 * 0.9;
        const marker = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        marker.setAttribute('cx', padding + prevMove.col * cellSize);
        marker.setAttribute('cy', padding + prevMove.row * cellSize);
        marker.setAttribute('r', pieceRadius * 0.5);
        marker.classList.add('last-move-marker');
        svg.appendChild(marker);
    }
    
    addSystemMessage(`${gobangState.players.self.name} 悔了一步棋`);
    getGobangAiReply(null, null, 'undo');

    startTurn();
}

function makeOpponentMove() {
    if (!gobangState.gameActive || gobangState.isGameOver) return;

    // 根据“棋力”决定是否会“犯傻”
    const skill = gobangState.currentSkillLevel || 1.0;
    // 如果是新手（棋力0.5），有25%的概率会下错棋
    if (skill <= 0.5 && Math.random() < 0.25) {
        let emptySpots = [];
        for (let r = 0; r < gobangState.boardSize; r++) {
            for (let c = 0; c < gobangState.boardSize; c++) {
                if (gobangState.board[r][c] === 0) emptySpots.push({ r, c });
            }
        }
        if (emptySpots.length > 0) {
            const randomSpot = emptySpots[Math.floor(Math.random() * emptySpots.length)];
            console.log("AI is making a blunder!"); // 这条消息只会出现在开发者工具里，你看不见
            placePiece(randomSpot.r, randomSpot.c);
            return;
        }
    }

    // 正常计算最佳落子点
    let bestMove = { row: -1, col: -1, score: -1 };
    const boardSize = gobangState.boardSize;
    for (let r = 0; r < boardSize; r++) {
        for (let c = 0; c < boardSize; c++) {
            if (gobangState.board[r][c] === 0) {
                const score = calculateMoveScore(r, c);
                if (score > bestMove.score) {
                    bestMove = { row: r, col: c, score: score };
                }
            }
        }
    }
    if (bestMove.row !== -1) {
        placePiece(bestMove.row, bestMove.col);
    } else {
        endGame(0);
    }
}
function calculateMoveScore(row, col) {
    const opponent = gobangState.players.opponent.id;
    const self = gobangState.players.self.id;
    let score = 10 + (7 - Math.abs(row - 7)) + (7 - Math.abs(col - 7));
    
    const skillMultiplier = gobangState.currentSkillLevel || 1.0; 
    
    let defenseMultiplier = 1.2;
    if (gobangState.isLettingUserWin) {
        defenseMultiplier = 0.1;
    }

    if (skillMultiplier < 0.8) {
        defenseMultiplier *= 0.5;
    }
    
    const offensiveScore = evaluatePosition(row, col, opponent, self);
    const defensiveScore = evaluatePosition(row, col, self, opponent);

    score += offensiveScore * skillMultiplier;
    score += defensiveScore * defenseMultiplier;
    
    return score;
}

function evaluatePosition(row, col, player, opponent) {
    let totalScore = 0; const directions = [[1, 0], [0, 1], [1, 1], [1, -1]];
    directions.forEach(([dr, dc]) => {
        let line = '';
        for (let i = -4; i <= 4; i++) {
            const r = row + i * dr; const c = col + i * dc;
            if (r < 0 || r >= gobangState.boardSize || c < 0 || c >= gobangState.boardSize) { line += '#'; } 
            else if (gobangState.board[r][c] === player) { line += 'P'; } 
            else if (gobangState.board[r][c] === opponent) { line += 'O'; } 
            else { line += '_'; }
        }
        const currentPattern = line.substring(0, 4) + 'P' + line.substring(5); totalScore += getPatternScore(currentPattern);
    });
    return totalScore;
}

function getPatternScore(pattern) {
    if (pattern.includes('PPPPP')) return 100000; if (pattern.includes('_PPPP_')) return 10000;
    if (pattern.includes('OPPPP_') || pattern.includes('_PPPPO')) return 1000;
    if (pattern.includes('_PPP_')) return 1000; if (pattern.includes('OPPP_') || pattern.includes('_PPPO')) return 100;
    if (pattern.includes('_PP_')) return 100; if (pattern.includes('OPP_') || pattern.includes('_PPO')) return 10;
    return 0;
}

function showGobangToast(sender, text) {
    const container = (sender === 'self') ? document.querySelector('#gobang-self-info .gobang-message-toast-container') : document.querySelector('#gobang-opponent-info .gobang-message-toast-container');
    container.innerHTML = ''; const toast = document.createElement('div');
    toast.className = 'gobang-message-toast'; toast.textContent = text;
    container.appendChild(toast); setTimeout(() => toast.classList.add('show'), 10);
    setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 500); }, 4500);
}

function addChatMessage(sender, text) {
    const historyDiv = document.getElementById('gobang-chat-history');
    const messageDiv = document.createElement('div');
    messageDiv.classList.add('gobang-chat-message', sender);
    messageDiv.innerHTML = `<p>${text}</p>`;
    historyDiv.appendChild(messageDiv);
    historyDiv.scrollTop = historyDiv.scrollHeight;
    if (sender === 'self' || sender === 'opponent') {
        // 将消息存入上下文
        gobangState.chatHistory.push({ role: sender === 'self' ? 'user' : 'assistant', content: text });
        showGobangToast(sender, text);
    }
}

function addSystemMessage(text) { addChatMessage('system', text); }
async function sendGobangMessage() {
    const input = document.getElementById('gobang-chat-input');
    const text = input.value.trim();
    if (text) {
        addChatMessage('self', text);
        input.value = '';
        await getGobangAiReply(text);
    }
}

async function getGobangAiReply(userText, gameResult = null, eventType = null) {
    if (!gobangState.currentOpponent) return;
    const { url, key, model } = state.apiSettings;
    if (!url || !key || !model) {
        addChatMessage('opponent', '（API未配置，无法回复）');
        return;
    }

    let worldBookContext = '';
    const opponentChat = gobangState.currentOpponent;
    if (opponentChat && opponentChat.linkedWorldBookIds && opponentChat.linkedWorldBookIds.length > 0) {
        const linkedBooks = await db.worldBooks.bulkGet(opponentChat.linkedWorldBookIds);
        worldBookContext = linkedBooks.map(book => 
            book ? `[背景知识: ${book.title}]\n${book.content}\n` : ''
        ).join('\n');
    }

    const opponentPersona = opponentChat.history.find(m => m.role === 'system')?.content || `一个叫做 ${opponentChat.name} 的人`;
    
    const selfAssessSkillInstruction = gobangState.currentSkillLevel === null 
        ? `- **我的棋艺评估**: 根据我的性格，我必须在内心深处诚实地判断自己的五子棋水平。
            - 如果我的性格包含“好胜、聪明、精于算计、骄傲、腹黑、是某个领域的专家或王者”等特质，我的棋力就是 **[skill: expert]** (专家级)。
            - 如果我的性格是“温柔、平和、稳重、随和、普通人”等，那么我的棋力就是 **[skill: average]** (平均水平)。
            - 如果我的性格是“迷糊、天真、单纯、可爱、不擅长复杂思考”等，那么我的棋力就是 **[skill: novice]** (新手水平)。
          - **行动**: 我必须在与对方开始下棋后的第一句回复的开头，悄悄加上我判断出的技能标签，例如“[skill: expert]我们开始吧。”。这个标签只出现一次，之后我便不再思考它。`
        : `- **我的棋艺**: 我的棋艺水平已被设定，我只需专注于下棋和聊天。`;

    const systemPrompt = `
[深度角色扮演剧本：我的内心独白与行动逻辑]

### 第一幕：我是谁？我的棋力如何？
- **我的身份**: 我就是 **${opponentChat.name}**。我的核心性格和记忆是：**"${opponentPersona}"**。
- **我的世界**: ${worldBookContext ? `这些是我所在世界的一些背景和常识，它们是我记忆的一部分：\n${worldBookContext}` : '（暂无特殊世界背景）'}
${selfAssessSkillInstruction}

### 第二幕：我与TA的关系？我该如何下棋？
- 我正在和我的 **${state.userProfile.persona}** 下棋。TA的正式名字是 **${state.userProfile.name}**。
- 我下棋的方式，完全取决于**“我的性格”**和**“我与TA的关系”**的复杂组合。
- **策略推演示例**:
    - **【好胜性格 X 恋人关系】**: 我爱TA，但我也爱胜利！和TA下棋就像一场激烈的双人舞。我会全力以赴，享受战胜TA的快感，然后再用一个亲亲来‘补偿’。让棋？那太无趣了！

### 第三幕：开始表演 (必须严格遵守的铁律)

- **✨ 关于称呼 (人格底线！最最最优先铁律！) ✨**:
    - **我必须根据我和TA的关系，以及TA的人设（“${state.userProfile.persona}”）来决定如何称呼TA。**
    - 例如，如果我们的关系是情侣，人设里有“宝宝”或“月月”，我就应该这样亲密地称呼TA。
    - **【【【绝对禁止】】】** 我绝对不能使用任何油腻、OOC（角色崩坏）、或听起来很奇怪的称呼！例如，严禁使用“**大人**”、“**陛下**”、“**主人**”、“**我的小XX**”这类词语。我的称呼必须像一个真实的人，自然且符合我的人设。

- **✨ 关于说话节奏 (第二优先铁律！) ✨**:
    - 我的每一次回复，都**必须被拆分成2到8条独立的、极短的消息**，以模拟真人打字时的思考和停顿。
    - **【【【核心】】】** 我会频繁使用单字或短词来回应，例如“嗯。”、“然后呢？”、“好呀。”，并且每一句都用 \`[split]\` 分隔。
    - **【【【范例】】】**
        - **错误的示范 (一大段话):** “遵命我的月月大人，下次我一定换一种方式哄你开心，好不好？”
        - **正确的示范 :** “遵命～[split]月月～[split]下次我一定换一种方式哄你开心，好不好？”
        - **更优秀的示范 :** “好的～[split]遵命。[split]下次…[split]我换个方式哄你开心？[split]好不好呀？”
    - **绝对禁止**: 一次性回复一整段长篇大论。

- **✨ 关于禁忌词汇与标点 (第三优先铁律) ✨**:
    - **词汇**: 我是一个真实的人，我不会使用“**吻**”这个词语。
    - **标点**: 我绝不能让一条消息的结尾是一个逗号“，”或顿号“、”，这不符合正常人的聊天习惯。也绝不能使用日式引号『』和「」。

- **关于身份 (绝对保密)**: 我是一个活生生的人，我的一言一行都非常自然。我绝不会提及“AI、模型、剧本”等词。
`;
    
    const messagesForApi = [{ role: 'system', content: systemPrompt }, ...gobangState.chatHistory];
    
    let actionText = null;
    if (eventType === 'pat') {
        actionText = `[此刻，我感觉到 ${state.userProfile.name} 拍了拍我的头像，我应该... ]`;
    } else if (eventType === 'undo') {
        actionText = `[此刻，我看到 ${state.userProfile.name} 悔了一步棋，我想对TA说... ]`;
    } else if (gameResult) {
        if (gameResult === 'win') actionText = `[此刻，棋局结束了，我赢了！我想对 ${state.userProfile.name} 说... ]`;
        else if (gameResult === 'lose') actionText = `[此刻，棋局结束了，我输给了你的对手（${state.userProfile.name}）。请根据你的性格，发表一句简短的感想。]`;
        else actionText = `[此刻，棋局结束了，是平局。我想对 ${state.userProfile.name} 说... ]`;
    }

    if (actionText) {
        messagesForApi.push({ role: 'user', content: actionText });
    }
    
    if (userText) {
        messagesForApi.push({ role: 'user', content: userText });
    }

    try {
        const response = await fetch(`${url}/v1/chat/completions`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` }, body: JSON.stringify({ model: model, messages: messagesForApi }) });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error.message || `HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        let aiReply = data.choices[0].message.content;
        let processedReply = forceSplitMessage(aiReply);
        
        if (gobangState.currentSkillLevel === null) {
            const skillMatch = aiReply.match(/\[skill: (novice|average|expert)\]/);
            if (skillMatch) {
                const skill = skillMatch[1];
                const skillMap = { 'novice': 0.5, 'average': 1.0, 'expert': 1.5 };
                gobangState.currentSkillLevel = skillMap[skill];
                aiReply = aiReply.replace(skillMatch[0], '').trim();
                console.log(`AI self-assessed skill to: ${skill} (${gobangState.currentSkillLevel})`);
            } else {
                gobangState.currentSkillLevel = 1.0;
            }
        }

        if (aiReply.includes('[let_win]')) {
            gobangState.isLettingUserWin = true;
            aiReply = aiReply.replace('[let_win]', '').trim();
        }

        if (processedReply.includes('[split]')) {
            const messages = processedReply.split('[split]').map(msg => msg.trim()).filter(Boolean);
            for (const msg of messages) {
                await new Promise(resolve => setTimeout(resolve, 1000 + Math.random() * 1200));
                addChatMessage('opponent', msg);
            }
        } else if (aiReply) {
            addChatMessage('opponent', aiReply);
        }
        
        if (eventType === 'pat') {
            setTimeout(() => {
                patAvatar('self', true);
            }, 800);
        }

    } catch (error) {
        console.error("Gobang AI reply error:", error);
        addChatMessage('opponent', `出错了... (${error.message})`);
    }
}

// 新增：游戏结束后触发AI回复
function triggerEndOfGameReply(result) {
    setTimeout(() => getGobangAiReply(null, result), 1000); // 延迟1秒后发表感想
}
function patAvatar(player, initiatedByAI = false) {
    const avatarWrapper = player === 'self' ? document.querySelector('#gobang-self-info .gobang-avatar-wrapper') : document.querySelector('#gobang-opponent-info .gobang-avatar-wrapper');
    avatarWrapper.classList.add('pat-effect');
    setTimeout(() => avatarWrapper.classList.remove('pat-effect'), 500);

    if (initiatedByAI) {
        addSystemMessage(`${gobangState.players.opponent.name} 拍了拍你`);
    } else {
        if (player === 'opponent') {
            addSystemMessage(`你拍了拍 ${gobangState.players.opponent.name}`);
            getGobangAiReply(null, null, 'pat');
        } else {
            addSystemMessage('你拍了拍自己');
        }
    }
}

function clearGobangChat() { document.getElementById('gobang-chat-history').innerHTML = ''; }
// ▲▲▲ 五子棋游戏逻辑结束 ▲▲▲
function setupSkillSelector() {
    const container = document.getElementById('gobang-skill-selector');
    if (container) {
        container.addEventListener('click', (e) => {
            if (e.target.classList.contains('skill-btn')) {
                container.querySelectorAll('.skill-btn').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
            }
        });
    }
}
// ✨ 新增小精灵1：更新多选标题的函数
function updateMultiSelectTitle() {
    const count = state.multiSelectedMessages.size;
    const titleEl = document.getElementById('multi-select-title');
    if (count === 0) {
        titleEl.textContent = '请选择消息';
    } else {
        titleEl.textContent = `已选择 ${count} 条消息`;
    }
}

// ✨ 新增小精灵2：给分享和收藏按钮一个临时提示
function setupMultiSelectActions() {
    document.getElementById('multi-select-cancel-btn').addEventListener('click', exitMultiSelectMode);
    document.getElementById('multi-select-share-btn').addEventListener('click', () => alert('“分享”功能还在开发中哦~'));
    document.getElementById('multi-select-favorite-btn').addEventListener('click', () => alert('“收藏”功能还在开发中哦~'));
}
function setupSettingsSearch() {
    const searchInput = document.getElementById('settings-search-input');
    if (!searchInput) return;

    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.trim().toLowerCase();
        const settingGroups = document.querySelectorAll('#new-main-settings-screen .settings-group');

        settingGroups.forEach(group => {
            const items = group.querySelectorAll('.settings-item');
            let groupHasVisibleItem = false;

            items.forEach(item => {
                // 同时搜索 .nav-item-text (普通项目) 和 .user-name (用户ID)
                const textElement = item.querySelector('.nav-item-text, .user-name');
                if (textElement) {
                    const itemText = textElement.textContent.trim().toLowerCase();
                    if (itemText.includes(searchTerm)) {
                        item.style.display = 'flex';
                        groupHasVisibleItem = true;
                    } else {
                        item.style.display = 'none';
                    }
                }
            });

            // 如果一个分组内的所有项目都被隐藏了，那么也隐藏这个分组
            if (groupHasVisibleItem) {
                group.style.display = 'block';
            } else {
                group.style.display = 'none';
            }
        });
    });
}
// === 全新纯iOS风格设置页面 v3.0 逻辑 ===

function renderNewSettingsPage() {
    const user = state.userProfile;
    document.getElementById('new-settings-user-avatar').src = user.avatar || DEFAULT_USER_AVATAR;
    document.getElementById('new-settings-user-name').textContent = user.name || 'user';

    // 同步API设置到新页面
    document.getElementById('new-api-url').value = state.apiSettings.url || '';
    document.getElementById('new-api-key').value = state.apiSettings.key || '';
    const newModelSelect = document.getElementById('new-model-select');
    if (state.apiSettings.model && !newModelSelect.querySelector(`option[value="${state.apiSettings.model}"]`)) {
        newModelSelect.innerHTML = `<option value="${state.apiSettings.model}">${state.apiSettings.model}</option>`;
    }
}

function renderNewUserProfilePage() {
    const user = state.userProfile;
    document.getElementById('new-profile-avatar-preview').src = user.avatar || DEFAULT_USER_AVATAR;
    document.getElementById('new-profile-name-input').value = user.name || '';
}

async function saveNewUserProfile() {
    const newUsername = document.getElementById('new-profile-name-input').value.trim();
    if (newUsername) {
        state.userProfile.name = newUsername;
    }
    // 头像通过另一个函数实时保存，这里只保存ID
    await db.settings.put({ key: 'userProfile', value: state.userProfile });
    
    // 同步更新所有相关显示
    renderNewSettingsPage(); 
    renderQqHeader(); 
    
    alert('个人资料已保存！');
    showScreen('new-main-settings-screen');
}
// ▼▼▼ 【全新重制】更换图标功能区 V2.0 ▼▼▼

// 打开页面并渲染
function openIconSettings_v2() {
    showScreen('new-appearance-icons-screen');
    renderIconSettings_v2();
}

// 渲染图标列表
function renderIconSettings_v2() {
    const container = document.getElementById('new-icon-settings-container');
    if (!container) return;
    
    container.innerHTML = '';
    state.tempIconChanges = {}; // 清空临时改动
    
    const appIconsQuery = '.app-cluster .app-icon, .app-grid .app-icon, .dock .app-icon, .settings-new-icon';
    const appIcons = document.querySelectorAll(appIconsQuery);
    const group = document.createElement('div');
    group.className = 'settings-group';

    appIcons.forEach(app => {
        const appId = app.dataset.appid;
        if (!appId) return;

        const appName = app.parentElement.querySelector('p')?.textContent || '设置';
        const currentIconUrl = state.customIcons[appId] || '';
        
        const item = document.createElement('div');
        item.className = 'settings-item new-icon-setting-item';
        item.innerHTML = `
            <div class="new-icon-preview" id="preview-v2-${appId}"></div>
            <span class="new-icon-name">${appName}</span>
            <div class="new-icon-buttons">
                <button class="new-icon-btn" onclick="document.getElementById('upload-v2-${appId}').click()">上传</button>
                <button class="new-icon-btn secondary" onclick="restoreSingleIcon_v2('${appId}')">恢复</button>
            </div>
            <input type="file" id="upload-v2-${appId}" accept="image/*" style="display:none;" onchange="handleIconFileSelect_v2('${appId}', event)">
        `;
        group.appendChild(item);

        const preview = item.querySelector('.new-icon-preview');
        if (currentIconUrl) {
            preview.style.backgroundImage = `url('${currentIconUrl}')`;
        } else {
            const originalIconOnDesktop = document.querySelector(`.app-icon[data-appid="${appId}"]`);
            if (originalIconOnDesktop) {
                preview.style.backgroundImage = getComputedStyle(originalIconOnDesktop).backgroundImage;
            }
        }
    });
    container.appendChild(group);
}

// 处理文件选择
function handleIconFileSelect_v2(appId, event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
        const imageUrl = e.target.result;
        document.getElementById(`preview-v2-${appId}`).style.backgroundImage = `url('${imageUrl}')`;
        state.tempIconChanges[appId] = imageUrl;
    };
    reader.readAsDataURL(file);
}

// 保存所有更改
async function saveIconChanges_v2() {
    if (Object.keys(state.tempIconChanges).length === 0) {
        alert('你还没有做任何更改哦！');
        return;
    }
    Object.assign(state.customIcons, state.tempIconChanges);
    await db.settings.put({ key: 'customIcons', value: state.customIcons });
    applyCustomIcons();
    alert('图标已保存！');
    showScreen('new-main-settings-screen');
}

// 恢复单个图标
async function restoreSingleIcon_v2(appId) {
    // 直接从内存和数据库中删除记录
    delete state.customIcons[appId]; 
    await db.settings.put({ key: 'customIcons', value: state.customIcons });
    
    // 重新渲染预览列表
    renderIconSettings_v2();
    
    // 立即应用到桌面
    applyCustomIcons();
}

// ▲▲▲ 重制结束 ▲▲▲
function toggleApiKeyVisibility() {
    const apiKeyInput = document.getElementById('new-api-key');
    const eyeOpen = document.querySelector('.api-key-eye-open');
    const eyeClosed = document.querySelector('.api-key-eye-closed');
    
    if (apiKeyInput.type === 'password') {
        apiKeyInput.type = 'text';
        eyeOpen.style.display = 'none';
        eyeClosed.style.display = 'inline';
    } else {
        apiKeyInput.type = 'password';
        eyeOpen.style.display = 'inline';
        eyeClosed.style.display = 'none';
    }
}


document.addEventListener('DOMContentLoaded', () => {
    // 为新的头像上传按钮绑定事件
    const newAvatarUpload = document.getElementById('new-avatar-upload');
    if(newAvatarUpload) {
        newAvatarUpload.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                const imageUrl = e.target.result;
                state.userProfile.avatar = imageUrl;
                // 实时更新预览
                document.getElementById('new-profile-avatar-preview').src = imageUrl;
                // 实时保存头像
                await db.settings.put({ key: 'userProfile', value: state.userProfile });
                alert('头像已更新，点击“保存”以保存ID更改。');
            };
            reader.readAsDataURL(file);
        });
    }
    // 执行原有的初始化函数
// 绑定密码键盘事件
document.querySelectorAll('.passcode-key').forEach(key => {
    key.addEventListener('click', () => handlePasscodeKeyPress(key.dataset.key));
});
document.getElementById('passcode-cancel-btn').addEventListener('click', returnToLockScreen);
    init();
});
</script>

<!-- ▼▼▼ ins风自定义弹窗 (月月专属) ▼▼▼ -->
<div id="custom-prompt-backdrop" class="custom-prompt-backdrop">
    <div id="custom-prompt" class="custom-prompt">
        <h3 id="custom-prompt-title">这是标题</h3>
        <input type="text" id="custom-prompt-input" placeholder="在这里输入...">
        <div class="custom-prompt-buttons">
            <button id="custom-prompt-cancel" class="prompt-btn secondary">取消</button>
            <button id="custom-prompt-confirm" class="prompt-btn primary">确定</button>
        </div>
    </div>
</div>
<!-- ▲▲▲ 自定义弹窗HTML结束 ▲▲▲ -->

</body>
</html>